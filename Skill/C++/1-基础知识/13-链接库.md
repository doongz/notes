# 链接库

编程语言中，常常将包含大量函数（类、方法）的文件称为库文件，库文件是最常用的共享代码的方式。

根据使用方法的不同，库文件可以分为静态链接库（简称“静态库文件”或者“静态库”）和动态链接库（“动态库文件”或者“动态库”）两种。

静态链接库和动态链接库的作用时机不同，

- 静态链接库会在程序载入内存之前完成所有的链接操作
- 动态链接库是在程序载入内存后再进行链接操作

## 一、什么是链接库

计算机中，有些文件专门用于存储可以重复使用的代码块，例如功能实用的函数或者类，我们通常将它们称为**「库文件」**，简称“库”（Library）。

实际开发中引入他人编写好的库文件可以省略某些功能的开发环节，提高项目的开发效率。但遗憾的是，类似 myMath.c 这种“开源”的库文件很难找到，多数程序员并不会直接分享源代码，他们更愿意分享库文件的**二进制版本「链接库」**。

所谓链接库，其实就是将开源的库文件（例如上面提到的 myMath.c）进行编译、打包操作后得到的二进制文件。**虽然链接库是二进制文件，但无法独立运行，必须等待其它程序调用，才会被载入内存。**

### 项目运行的过程

一个完整的 C 语言项目可能包含多个 .c 源文件，项目的运行需要经过“编译”和“链接”两个过程：

- 编译：由编译器逐个对源文件做词法分析、语法分析、语义分析等操作，最终生成多个目标文件。**每个目标文件都是二进制文件**，但由于它们会相互调用对方的函数或变量，还可能会调用某些链接库文件中的函数或变量，编译器无法跨文件找到它们确切的存储地址，所以这些目标文件无法单独执行。
- 链接：对于各个目标文件中缺失的函数和变量的存储地址（后续简称“缺失的地址”），由链接器负责修复，并最终**将所有的目标文件和链接库组织成一个可执行文件**。

但是一个目标文件中使用的函数或变量，可能定义在其他的目标文件中，也可能定义在某个链接库文件中。链接器完成完成链接工作的方式有两种，分别是：

- 无论缺失的地址位于其它目标文件还是链接库，链接器都会逐个找到各目标文件中缺失的地址。采用此链接方式生成的可执行文件，可以独立载入内存运行；（目标文件和链接库一并链接上）
- 链接器先从所有目标文件中找到部分缺失的地址，然后将所有目标文件组织成一个可执行文件。如此生成的可执行文件，仍缺失部分函数和变量的地址，待文件执行时，需连同所有的链接库文件一起载入内存，再由链接器完成剩余的地址修复工作，才能正常执行。（链接阶段先链接目标文件，程序运行的时候在链接链接库文件）

我们通常将第一种链接方式称为「静态链接」，用到的链接库称为「静态链接库」；第二种链接方式中，链接所有目标文件的方法仍属静态链接，而载入内存后进行的链接操作称为「动态链接」，用到的链接库称为「动态链接库」。

## 二、静态链接库和动态链接库

#### 1、静态链接库

静态链接库用来和所有的目标文件一起组织成可执行文件，生成的可执行文件可以**独立运行**。

采用静态链接库完成链接操作，存在诸多缺点。首先，可执行文件内部拷贝了所有目标文件和静态链接库的指令和数据，文件本身的体积会很大。当系统中存在多个链接同一个静态库的可执行文件时，每个可执行文件中都存有一份静态库的指令和数据，就会造成**内存空间的极大浪费**。

此外，一旦程序中有模块更新，整个程序就必须重新链接后才能运行。假设一个程序有 20 个模块构成，每个模块的大小为 1 MB，那么每次更新任何一个模块，用户就必须重新获取 20 MB 的程序，对用户很不友好。

#### 2、动态链接库

实际上，动态链接库是 Windows 平台上对动态链接过程所用库文件的称谓，Linux 平台上习惯称为「共享库」或者「共享对象文件」，它们表达的是一个意思。

所谓动态链接，指的是将链接的时机推迟到程序运行时再进行。具体来讲，**对于一个以动态链接方式运行的项目，首先由静态链接器将所有的目标文件组织成一个可执行文件，运行时将所需的动态链接库全部载入内存，由动态链接器完成可执行文件和动态库文件的链接工作。**

> 动态链接库可以随可执行文件一同载入内存，也可以在可执行文件运行过程中载入，即可执行文件什么时候需要，动态链接库才会载入内存。

和静态链接库相比，**动态链接库可以很好地解决空间浪费和更新困难的问题**。动态链接库和可执行文件是分别载入内存的，因此动态链接库的体积通常会小一些。当有多个程序使用同一个动态链接库时，所有程序可以共享一份动态链接库的指令和数据，避免了空间的浪费。采用动态链接的方式也可以方便程序的更新和升级，当程序的某个模块更新后，只需要将旧的模块替换掉，程序运行时会自动将所有模板载入内存并动态地链接在一起。

有读者可能会问，采用动态链接的方式，每次程序运行时都需要重新链接，会不会很慢？的确，**动态链接确实会损失一部分程序性能**，但实践证明，动态链接库和静态链接相比，性能损失大约在 5% 以下，由此换取程序在空间上的节省以及更新时的便利，是相当值得的。