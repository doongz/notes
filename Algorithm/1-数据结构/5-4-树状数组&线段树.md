# æ ‘çŠ¶æ•°ç»„

æ¥æº1ï¼šhttps://leetcode-cn.com/problems/count-of-smaller-numbers-after-self/solution/shu-zhuang-shu-zu-by-liweiwei1419/

æ¥æº2ï¼šhttps://leetcode-cn.com/problems/range-sum-query-mutable/solution/guan-yu-ge-lei-qu-jian-he-wen-ti-ru-he-x-41hv/

æ¥æº3ï¼šhttps://oi-wiki.org/ds/fenwick/

æ¥æº4ï¼šhttps://oi-wiki.org/ds/seg/

**æ ‘çŠ¶æ•°ç»„**æˆ–**äºŒå‰ç´¢å¼•æ ‘**ï¼ˆè‹±è¯­ï¼šBinary Indexed Treeï¼‰ï¼Œåˆä»¥å…¶å‘æ˜è€…å‘½åä¸ºFenwickæ ‘ï¼Œæœ€æ—©ç”±Peter M. Fenwickäº1994å¹´ä»¥A New Data Structure for Cumulative Frequency Tablesä¸ºé¢˜å‘è¡¨åœ¨SOFTWARE PRACTICE AND EXPERIENCEã€‚å…¶åˆè¡·æ˜¯è§£å†³æ•°æ®å‹ç¼©é‡Œçš„ç´¯ç§¯é¢‘ç‡ï¼ˆCumulative Frequencyï¼‰çš„è®¡ç®—é—®é¢˜ï¼Œç°å¤šç”¨äºé«˜æ•ˆè®¡ç®—æ•°åˆ—çš„å‰ç¼€å’Œï¼Œ åŒºé—´å’Œã€‚

## ä¸€ã€æ¦‚è¿°

### 1ã€æ¦‚å¿µ

**ç»´æŠ¤ åŒºé—´ä¿¡æ¯ çš„æ•°æ®ç»“æ„æœ‰ï¼šå‰ç¼€å’Œã€å·®åˆ†æ•°ç»„ã€æ ‘çŠ¶æ•°ç»„ã€çº¿æ®µæ•°**

æˆ‘ä»¬çŸ¥é“å‰ç¼€å’Œå°±å¯ä»¥æ±‚åŒºé—´å’Œï¼Œè¿™æ˜¯å› ä¸ºä¸åŒè§„æ¨¡çš„åŒºé—´å’Œæœ‰é‡å¤çš„éƒ¨åˆ†ï¼Œç›¸å‡ä»¥åå°±å¾—åˆ°äº†åŒºé—´å’Œã€‚

ã€Œå‰ç¼€å’Œã€æ•°ç»„çš„æ€è·¯æ˜¯ï¼šå°†åŸå§‹æ•°ç»„è¿›è¡Œé¢„å¤„ç†ï¼Œå°†æ¥éœ€è¦æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œåªéœ€è¦æŸ¥è¯¢é¢„å¤„ç†æ•°ç»„çš„æŸäº›å€¼å³å¯ã€‚

è¦ä¼˜åŒ–ã€Œä¿®æ”¹æ“ä½œã€é€ æˆçš„çº¿æ€§æ—¶é—´å¤æ‚åº¦ï¼Œ**é¢„å¤„ç†æ•°æ®ç»„ç»‡æˆçº¿æ€§ç»“æ„ï¼ˆå‰ç¼€å’Œæ•°ç»„ï¼‰è‚¯å®šæ˜¯ä¸è¡Œçš„**ï¼Œå› æ­¤ä¸€ç§æ–¹æ¡ˆæ˜¯æŠŠé¢„å¤„ç†çš„æ•°æ®ç»„ç»‡æˆã€Œæ ‘å½¢ç»“æ„ã€ï¼Œæœ‰ä¸¤ç§æ•°æ®ç»“æ„ï¼š

- çº¿æ®µæ ‘ï¼šé«˜æ•ˆå¤„ç†å•ç‚¹ä¿®æ”¹ã€åŒºé—´ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢ï¼ˆåŒºé—´æ±‚å’Œï¼Œæ±‚åŒºé—´æœ€å¤§å€¼ï¼Œæ±‚åŒºé—´æœ€å°å€¼ï¼‰ç­‰æ“ä½œ
- æ ‘çŠ¶æ•°ç»„ï¼šé«˜æ•ˆå¤„ç†ã€Œå‰ç¼€å’Œã€æŸ¥è¯¢ï¼Œå•ç‚¹ä¿®æ”¹ã€‚

**ã€Œçº¿æ®µæ ‘ã€å’Œã€Œæ ‘çŠ¶æ•°ç»„ã€ä¸€æ ·ï¼Œéƒ½æ˜¯å¯¹åŸå§‹è¾“å…¥æ•°ç»„è¿›è¡Œäº†é¢„å¤„ç†ï¼Œä½¿å¾—åœ¨çœŸæ­£éœ€è¦æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦çœ‹ã€Œé¢„å¤„ç†æ•°ç»„ã€çš„éƒ¨åˆ†ä¿¡æ¯å³å¯ï¼Œç”±äºç»„ç»‡æˆæ ‘å½¢ç»“æ„ï¼Œã€Œä¿®æ”¹ã€å’Œã€ŒæŸ¥è¯¢ã€çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(logN)**

æ³¨æ„ï¼šã€Œçº¿æ®µæ ‘ã€å’Œã€Œæ ‘çŠ¶æ•°ç»„ã€ä¸èƒ½å¤„ç†è¾“å…¥æ•°ç»„çš„é•¿åº¦æœ‰å¢åŠ æˆ–è€…å‡å°‘çš„æƒ…å†µã€‚

| æ•°æ®ç»“æ„ \ æ“ä½œ | å•ç‚¹ä¿®æ”¹ | åŒºé—´æŸ¥è¯¢ |
| --------------- | -------- | -------- |
| å‰ç¼€å’Œ          | O(n)     | O(1)     |
| æ ‘çŠ¶æ•°ç»„        | O(logn)  | O(logn)  |
| çº¿æ®µæ•°          | O(logn)  | O(logn)  |

### 2ã€é€‰æ‹©æ–¹æ¡ˆ

| é¢˜ç›®                                 | ä¼˜å…ˆæ–¹æ¡ˆ                         | å¯ç”¨æ–¹æ¡ˆ                 |
| ------------------------------------ | -------------------------------- | ------------------------ |
| æ•°ç»„ä¸å˜ï¼Œæ±‚åŒºé—´å’Œ                   | å‰ç¼€å’Œ                           | å‰ç¼€å’Œã€æ ‘çŠ¶æ•°ç»„ã€çº¿æ®µæ ‘ |
| å¤šæ¬¡ä¿®æ”¹æŸä¸ªæ•°ï¼Œæ±‚åŒºé—´å’Œ             | æ ‘çŠ¶æ•°ç»„                         | æ ‘çŠ¶æ•°ç»„ã€çº¿æ®µæ ‘         |
| å¤šæ¬¡æ•´ä½“ä¿®æ”¹æŸä¸ªåŒºé—´ï¼Œæ±‚åŒºé—´å’Œ       | æ ‘çŠ¶æ•°ç»„ï¼ˆçœ‹ä¿®æ”¹åŒºé—´çš„æ•°æ®èŒƒå›´ï¼‰ | çº¿æ®µæ ‘ã€æ ‘çŠ¶æ•°ç»„         |
| å¤šæ¬¡å°†æŸä¸ªåŒºé—´å˜æˆåŒä¸€ä¸ªæ•°ï¼Œæ±‚åŒºé—´å’Œ | çº¿æ®µæ ‘                           | çº¿æ®µæ ‘ã€æ ‘çŠ¶æ•°ç»„         |
| åŒºé—´çš„å˜åŒ–ç›¸åŒçš„é‡                   | å·®åˆ†æ•°ç»„                         | å·®åˆ†æ•°ç»„                 |

ã€Œçº¿æ®µæ ‘ã€ä»£ç å¾ˆé•¿ï¼Œè€Œä¸”å¸¸æ•°å¾ˆå¤§ï¼Œå®é™…è¡¨ç°ä¸ç®—å¾ˆå¥½ã€‚åªæœ‰åœ¨ä¸å¾—ä¸ç”¨çš„æ—¶å€™æ‰è€ƒè™‘ã€Œçº¿æ®µæ ‘ã€

ã€Œæ ‘çŠ¶æ•°ç»„ã€çš„ä»£ç è¦æ¯”ã€Œçº¿æ®µæ ‘ã€çŸ­ï¼Œæ€ç»´æ›´æ¸…æ™°ï¼Œé€Ÿåº¦ä¹Ÿæ›´å¿«ï¼Œåœ¨è§£å†³ä¸€äº›å•ç‚¹ä¿®æ”¹çš„é—®é¢˜æ—¶ï¼Œã€Œæ ‘çŠ¶æ•°ç»„ã€æ˜¯ä¸äºŒä¹‹é€‰

### 3ã€æ ‘å½¢ç»“æ„

- çº¿æ®µæ ‘æ˜¯ä¸€æ£µäºŒå‰æ ‘

çº¢è‰²éƒ¨åˆ†è¡¨ç¤ºé¢„å¤„ç†æ•°ç»„ï¼Œè“è‰²éƒ¨åˆ†æ˜¯åŸå§‹è¾“å…¥æ•°ç»„ï¼Œç®­å¤´è¡¨ç¤ºå½“å‰å€¼æ˜¯å“ªäº›ç»“ç‚¹çš„å€¼çš„å’Œã€‚

![](./doc/çº¿æ®µæ ‘.png)

- æ ‘çŠ¶æ•°ç»„æ˜¯å¤šå‰æ ‘

çº¢è‰²éƒ¨åˆ†è¡¨ç¤ºé¢„å¤„ç†æ•°ç»„ï¼Œè“è‰²éƒ¨åˆ†æ˜¯åŸå§‹è¾“å…¥æ•°ç»„ï¼Œç®­å¤´è¡¨ç¤ºå½“å‰å€¼æ˜¯å“ªäº›ç»“ç‚¹çš„å€¼çš„å’Œã€‚

![](./doc/æ ‘çŠ¶æ•°ç»„.png)

## äºŒã€æ ‘çŠ¶æ•°ç»„

ã€Œæ ‘çŠ¶æ•°ç»„ã€ä¹Ÿå« Binary Indexed Treeï¼ŒäºŒè¿›åˆ¶ç´¢å¼•æ ‘ï¼Œå¾ˆå¥½åœ°è¡¨ç¤ºäº†ã€Œæ ‘çŠ¶æ•°ç»„ã€å¤„ç†æ•°æ®çš„æ€è·¯ï¼šã€Œæ ‘çŠ¶æ•°ç»„ã€é‡ŒæŸä¸ªå…ƒç´ ç®¡ç†äº†åŸå§‹è¾“å…¥æ•°ç»„å¤šå°‘æ•°æ®æ˜¯ç”±ä¸‹æ ‡å†³å®šçš„ã€‚

**ç”¨äºï¼šé«˜æ•ˆåœ°è§£å†³ã€Œå‰ç¼€å’ŒæŸ¥è¯¢ã€ä¸ã€Œå•ç‚¹æ›´æ–°ã€é—®é¢˜**

æ€æƒ³ï¼šç©ºé—´æ¢æ—¶é—´

### 1ã€å¦‚ä½•ç»„ç»‡åŸå§‹è¾“å…¥æ•°æ®çš„ç»“æ„ï¼Ÿ

å’Œã€Œå †ã€ä¸€æ ·ï¼Œæ ‘çŠ¶æ•°ç»„çš„ 0 å·ä¸‹æ ‡ä¸æ”¾ç½®å…ƒç´ ï¼Œ**ä» 1 å·ä¸‹æ ‡å¼€å§‹ä½¿ç”¨**ã€‚ä»ä¸Šå›¾å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œä¸æ•°ç»„ C çš„æŸä¸ªç»“ç‚¹æœ‰å…³çš„æ•°ç»„ A çš„æŸäº›ç»“ç‚¹ï¼Œå®ƒä»¬çš„ä¸‹æ ‡ä¹‹é—´æœ‰å¦‚ä¸‹å…³ç³»ã€‚

| æ•°ç»„ `C` çš„å€¼ç”±æ•°ç»„ `A` çš„å“ªäº›å…ƒç´ è€Œæ¥ | æ•°ç»„ `A` çš„å…ƒç´ ä¸ªæ•° |
| -------------------------------------------------- | ------------------------- |
| C[1] = A[1] | 1 |
| C[2] = A[1] + A[2] | 2 |
| C[3] = A[3] | 1 |
| C[4] = A[1] + A[2] + A[3] + A[4] | 4 |
| C[5] = A[5] | 1 |
| C[6] = A[5] + A[6] | 2 |
| C[7] = A[7] | 1 |
| C[8] = A[1] + A[2] + A[3] + A[4] + A[5] + A[6] + A[7] + A[8] | 8 |

è¿™ä»¶äº‹æƒ…æ˜¯ç”±ä¸‹æ ‡æ•°å€¼çš„äºŒè¿›åˆ¶å†³å®šçš„ï¼ŒæŠŠä¸‹æ ‡å†™æˆäºŒè¿›åˆ¶çš„å½¢å¼ï¼Œ**æœ€ä½ä½çš„ 1 ä»¥åŠåé¢çš„ 0 è¡¨ç¤ºäº†é¢„å¤„ç†æ•°ç»„ C ç®¡ç†äº†å¤šå°‘è¾“å…¥æ•°ç»„ A çš„å…ƒç´ **ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‹é¢çš„å›¾ï¼š

![](./doc/æ ‘çŠ¶æ•°ç»„-1.png)

ä¾‹å¦‚ï¼š6 çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸º 0110ï¼Œè¿™é‡Œåªä¿ç•™æœ€ä½ 4 ä½ã€‚å°† 6 è¿›è¡ŒäºŒçº§åˆ¶åˆ†è§£å¾—åˆ°ï¼š
$$
6 = 1 \times 2^2 + 1 \times 2^1
$$
**æœ€åçš„è¿™éƒ¨åˆ† `2^1` å†³å®šäº† C[6] ç®¡ç†äº†å¤šå°‘ä¸ªè¾“å…¥æ•°ç»„ A çš„æ•°æ®ï¼Œå› ä¸ºæœ€åé¢çš„ 1 åé¢æœ‰ 1 ä¸ª 0**ï¼Œç®—ä¸‹æ¥æ˜¯ 2 ä¸ªï¼Œå³ä»ä¸‹æ ‡ 6 å¼€å§‹ï¼ˆåŒ…æ‹¬ 6ï¼‰å‘å‰æ•° 2 ä¸ªæ•°ï¼Œå› æ­¤ C[6] = A[5] +A[6]ï¼Œå…¶å®ƒåŒç†ã€‚

è¿™å°±æ˜¯å¼€å¤´æ‰€è¯´çš„ï¼šã€Œæ ‘çŠ¶æ•°ç»„ã€é‡ŒæŸä¸ªå…ƒç´ ç®¡ç†äº†åŸå§‹è¾“å…¥æ•°ç»„å¤šå°‘æ•°æ®æ˜¯ç”±ä¸‹æ ‡å†³å®šçš„ã€‚

æˆ‘ä»¬çœ‹åˆ°ï¼š

- ã€Œæ ‘çŠ¶æ•°ç»„ã€ç»„ç»‡æˆçš„æ ‘æ˜¯æœ‰å±‚çº§çš„ï¼Œ**ä¸‹æ ‡çš„äºŒè¿›åˆ¶è¡¨ç¤ºçš„æœ€ä½ä½ 1 åé¢çš„ 0 çš„ä¸ªæ•°å†³å®šäº†ï¼Œå½“å‰ç»“ç‚¹åœ¨ç¬¬å‡ å±‚**ï¼›
- è¿™æ ·ç»„ç»‡æ•°æ®ï¼Œ**ä»å¶å­ç»“ç‚¹åˆ°çˆ¶ç»“ç‚¹æ˜¯å¯ä»¥é€šè¿‡ä¸€ä¸ªå«åš lowbit çš„å‡½æ•°è®¡ç®—å‡ºæ¥ï¼Œå¹¶ä¸”å¯ä»¥çŸ¥é“å°äºç­‰äºå½“å‰ä¸‹æ ‡çš„åŒä¸€å±‚ç»“ç‚¹çš„æ‰€æœ‰ç»“ç‚¹**

### 2ã€lowbit å‡½æ•°

è¿™æ ·å‘½åçš„å«ä¹‰æ˜¯æˆªå–ä¸€ä¸ªæ­£æ•´æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºé‡Œçš„æœ€ä½ä½çš„ 1 å’Œå®ƒåé¢çš„æ‰€æœ‰çš„ 0ã€‚

è¿”å›çš„å€¼å¯ç”¨ä½œï¼Œè‹¥å½“å‰ä¸‹æ ‡ä¸º i 

- C[i] ç”± lowbit(i) ä¸ª A ä¸­å…ƒç´ ç»„æˆ
- C[i] çš„çˆ¶äº²ä¸º C[i+lowbit(i)]

lowbit çš„å®šä¹‰å¦‚ä¸‹ï¼š
$$
lowbit(x) = x \ \& \ (-x)
$$

```c++
int lowbit(int idx) {
    // idx ä¸ºæ ‘çŠ¶æ•°ç»„ä¸‹æ ‡
    return idx & (-idx);
}
```

è¯´æ˜ï¼š

- è¿™é‡Œ x ä¸€å®šæ˜¯æ­£æ•´æ•°ï¼Œå³ x >= 1ï¼›
- è¿™é‡Œ & è¡¨ç¤ºæŒ‰ä½ä¸è¿ç®—ï¼›
- -x ä¹Ÿå¯ä»¥å†™æˆ (~x + 1) ï¼Œè¿™é‡Œ ~ è¡¨ç¤ºã€ŒæŒ‰ä½å–åã€ã€‚è¿™æ˜¯è´Ÿæ•°çš„å®šä¹‰ï¼Œè´Ÿæ•°ç”¨è¡¥ç è¡¨ç¤ºï¼Œå®ƒçš„å€¼ç­‰äºè¿™ä¸ªè´Ÿæ•°çš„ç»å¯¹å€¼æŒ‰ä½å–åä»¥åå†åŠ  1

```
lowbit(x) = x & (~x + 1)
```

lowbit è¿ç®—è§£é‡Šï¼š

- å…ˆã€ŒæŒ‰ä½å–åã€æ­£å¥½è®©æœ€ä½ä½çš„ 1 å˜æˆ 0ï¼Œæœ€ä½ä½çš„ 1 åé¢çš„ 0 å˜æˆ 1ï¼Œæœ€ä½ä½çš„ 1 å‰é¢çš„ 1 å˜æˆ 0ï¼Œ0 å˜æˆ 1ï¼›
- å†åŠ  1 ä½¿å¾—ä½ä½çš„ 1 å…¨å˜æˆ 0ï¼ŒåŸæ¥å˜æˆ 0 çš„ 1 ç”±äºè¿›ä½åˆå˜å›äº† 1ï¼›
- å†ä¸åŸäºŒè¿›åˆ¶æŒ‰ä½ä¸è¿ç®—ï¼Œæ­£å¥½å°±ç•™ä¸‹äº†ä¸€ä¸ª 1ã€‚

ä¾‹1ï¼šè®¡ç®—ä¸‹æ ‡æ˜¯ 8ï¼Œè¿”å› 8

| æ­¥éª¤                                      | äºŒè¿›åˆ¶è¡¨ç¤º                            |
| ----------------------------------------- | ------------------------------------- |
| ç¬¬ 1 æ­¥ï¼šå†™å‡º 8 çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼›            | `00000000 00000000 00000000 00001000` |
| ç¬¬ 2 æ­¥ï¼šå°† 8 çš„äºŒè¿›åˆ¶è¡¨ç¤ºæŒ‰ä½å–åï¼›      | `11111111 11111111 11111111 11110111` |
| ç¬¬ 3 æ­¥ï¼šå†åŠ  1                           | `11111111 11111111 11111111 11111000` |
| ç¬¬ 4 æ­¥ï¼šç¬¬ä¸€æ­¥å’Œç¬¬ä¸‰éƒ¨çš„äºŒè¿›åˆ¶æŒ‰ä½ä¸è¿ç®— | `00000000 00000000 00000000 00001000` |

ä¾‹2ï¼šè®¡ç®—ä¸‹æ ‡æ˜¯ 6ï¼Œè¿”å› 2

| æ­¥éª¤                                      | äºŒè¿›åˆ¶è¡¨ç¤º                            |
| ----------------------------------------- | ------------------------------------- |
| ç¬¬ 1 æ­¥ï¼šå†™å‡º 6 çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼›            | `00000000 00000000 00000000 00000110` |
| ç¬¬ 2 æ­¥ï¼šå°† 6 çš„äºŒè¿›åˆ¶è¡¨ç¤ºæŒ‰ä½å–åï¼›      | `11111111 11111111 11111111 11111001` |
| ç¬¬ 3 æ­¥ï¼šå†åŠ  1                           | `11111111 11111111 11111111 11111010` |
| ç¬¬ 4 æ­¥ï¼šç¬¬ä¸€æ­¥å’Œç¬¬ä¸‰éƒ¨çš„äºŒè¿›åˆ¶æŒ‰ä½ä¸è¿ç®— | `00000000 00000000 00000000 00000010` |

#### è´Ÿæ•°å’Œè¡¥ç çš„ç›¸å…³çŸ¥è¯†

è‹¥è®¡ç®—æœºåº•å±‚å­˜å‚¨æ•´æ•°ä½¿ç”¨ 32 ä½ï¼›æœ€é«˜ä½è¡¨ç¤ºç¬¦å·ä½ï¼š1 è¡¨ç¤ºè´Ÿæ•°ï¼Œ 0 è¡¨ç¤ºæ­£æ•°ï¼›è´Ÿæ•°ä½¿ç”¨è¡¥ç è¡¨ç¤º

**ã€Œè¡¥ç ã€æŒ‰ç…§å¦‚ä¸‹è§„åˆ™å®šä¹‰**

- æ­£æ•°çš„è¡¥ç æ˜¯å®ƒè‡ªå·±ï¼›
- è´Ÿæ•°çš„è¡¥ç æ˜¯å®ƒå¯¹åº”æ­£æ•´æ•°æŒ‰ä½å–åä»¥åå†åŠ  1

è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ï¼š**ç¬¦å·ä½å‚ä¸è®¡ç®—ï¼Œå¹¶ä¸”ä¿è¯äº†ç»“æœæ­£ç¡®**

ä¾‹1ï¼šè®¡ç®— -5 çš„äºŒè¿›åˆ¶è¡¨ç¤º

| æ­¥éª¤                                 | äºŒè¿›åˆ¶è¡¨ç¤º                            |
| ------------------------------------ | ------------------------------------- |
| ç¬¬ 1 æ­¥ï¼šå†™å‡º 5 çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼›       | `00000000 00000000 00000000 00000101` |
| ç¬¬ 2 æ­¥ï¼šå°† 5 çš„äºŒè¿›åˆ¶è¡¨ç¤ºæŒ‰ä½å–åï¼› | `11111111 11111111 11111111 11111010` |
| ç¬¬ 3 æ­¥ï¼šåœ¨ç¬¬ 2 æ­¥çš„åŸºç¡€ä¸Šå†åŠ  1ã€‚   | `11111111 11111111 11111111 11111011` |

ä¾‹ 2ï¼šè®¡ç®— 16 - 8

è®¡ç®— 16 - 8ï¼Œç›´æ¥åŠ ï¼Œé«˜ä½æº¢å‡ºï¼Œä½†ä¸å½±å“ç»“æœ

| æ­¥éª¤                            | äºŒè¿›åˆ¶è¡¨ç¤º                            |
| ------------------------------- | ------------------------------------- |
| ç¬¬ 1 æ­¥ï¼šå†™å‡º 16 çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼› | `00000000 00000000 00000000 00010000` |
| ç¬¬ 2 æ­¥ï¼šå†™å‡º -8 çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼› | `11111111 11111111 11111111 11111000` |
| ç¬¬ 3 æ­¥ï¼šè®¡ç®— 16 - 8 = 8        | `00000000 00000000 00000000 00001000` |

### 3ã€å•ç‚¹æ›´æ–°

è‹¥å¯¹åŸå§‹æ•°ç»„è¿›è¡Œå•ç‚¹æ›´æ–°ï¼Œarr[idx] += delta;

åˆ™å¯¹æ ‘çŠ¶æ•°ç»„çš„ç›¸åº”ä½ç½®è¿›è¡Œæ›´æ–°ï¼Œtree[idx+1] += delta;

- ã€Œå•ç‚¹æ›´æ–°ã€ä»å­©å­ç»“ç‚¹åˆ°çˆ¶äº²ç»“ç‚¹ï¼Œæ²¿é€”æ‰€æœ‰çš„ç»“ç‚¹éƒ½éœ€è¦æ›´æ–°ï¼›
- **ä»å­©å­ç»“ç‚¹åˆ°çˆ¶äº²ç»“ç‚¹ï¼Œå°±æ˜¯ä¸æ–­åŠ ä¸Šå½“å‰ä¸‹æ ‡çš„ `lowbit` å€¼ï¼Œäº§ç”Ÿè¿›ä½**ã€‚

```java
/**
 * å•ç‚¹æ›´æ–°
 *
 * @param i     åŸå§‹æ•°ç»„ç´¢å¼• i
 * @param delta å˜åŒ–å€¼ = æ›´æ–°ä»¥åçš„å€¼ - åŸå§‹å€¼
 */
public void update(int i, int delta) {
    // ä»ä¸‹åˆ°ä¸Šæ›´æ–°ï¼Œæ³¨æ„ï¼Œé¢„å¤„ç†æ•°ç»„ï¼Œæ¯”åŸå§‹æ•°ç»„çš„ len å¤§ 1ï¼Œæ•… é¢„å¤„ç†ç´¢å¼•çš„æœ€å¤§å€¼ä¸º len
    while (i <= len) {
        tree[i] += delta;
        i += lowbit(i);
    }
}

public static int lowbit(int x) {
    return x & (-x);
}
```

ä¾‹å¦‚ï¼šæ›´æ–°åŸå§‹æ•°ç»„ä¸­ä¸‹æ ‡ä¸º i=6 çš„å…ƒç´  A6

tree[6] += deltaï¼Œ æ ‘çŠ¶æ•°ç»„ C6 åŠ ä¸Šå˜åŒ–é‡

6 + lowbit(6)ï¼Œi æ›´æ–°ä¸º 8ï¼ˆ6+2ï¼‰

tree[8] += deltaï¼Œ æ ‘çŠ¶æ•°ç»„ C8 åŠ ä¸Šå˜åŒ–é‡

8 + lowbit(8)ï¼Œi æ›´æ–°ä¸º 16ï¼ˆ8+8ï¼‰ï¼Œè·³å‡ºå¾ªç¯

### 4ã€å‰ç¼€å’ŒæŸ¥è¯¢

æˆ‘ä»¬ä½¿ç”¨è®°å· preSum[7] è¡¨ç¤ºæŸ¥è¯¢ A[1] + A[2] + ... + A[7]ï¼Œ7 çš„äºŒè¿›åˆ¶ä¸º 0111
$$
7 = 1\times2^2 \ + \ 1\times2^1 \ + \ 1\times2^0
$$
å¯ä»¥çœ‹æˆ 0100ï¼ˆ4ï¼‰ã€0010ï¼ˆ2ï¼‰ã€0001ï¼ˆ1ï¼‰ è¿™ 3 éƒ¨åˆ†ä¹‹å’Œï¼Œåˆ†åˆ«è¡¨ç¤º 4 ä¸ªå…ƒç´  + 2 ä¸ªå…ƒç´  + 1 ä¸ªå…ƒç´ ï¼Œæ­£å¥½æ˜¯ lowbit å€¼ä¸€ç›´å‡ï¼Œå‡åˆ° 00 ä¸ºæ­¢ï¼Œ**æ¯å‡å»ä¸€ä¸ª lowbit å€¼ï¼Œæ¶ˆå»ä¸€ä¸ª 1**ã€‚

sum += tree[7]ï¼Œsum åŠ ä¸Š C[7]

7 - lowbit(7)ï¼Œi æ›´æ–°ä¸º 6ï¼ˆ7-1ï¼‰

sum += tree[6]ï¼Œsum åŠ ä¸Š C[6]

6 - lowbit(6)ï¼Œi æ›´æ–°ä¸º 4ï¼ˆ6-2ï¼‰

sum += tree[4]ï¼Œsum åŠ ä¸Š C[4]

4 - lowbit(4)ï¼Œi æ›´æ–°ä¸º 0ï¼ˆ4-4ï¼‰ï¼Œè·³å‡ºå¾ªç¯

æ­¤æ—¶ï¼š

sum = C[7] + C[6] + C[4] = A[7] + A[6] + A[5] + A[4] + A[3] + A[2] + A[1]

```java
/**
 * æŸ¥è¯¢å‰ç¼€å’Œ
 *
 * @param i å‰ç¼€çš„æœ€å¤§ç´¢å¼•ï¼Œå³æŸ¥è¯¢åŒºé—´ [0, i] çš„æ‰€æœ‰å…ƒç´ ä¹‹å’Œ
 */
public int query(int i) {
    // ä»å³åˆ°å·¦æŸ¥è¯¢
    int sum = 0;
    while (i > 0) {
        sum += tree[i];
        i -= lowbit(i);
    }
    return sum;
}
```

### 5ã€æ ‘çŠ¶æ•°ç»„çš„åˆå§‹åŒ–

åˆå§‹åŒ–å‰ç¼€å’Œæ•°ç»„åº”è¯¥äº¤ç»™è°ƒç”¨è€…æ¥å†³å®šã€‚ä¸‹é¢æ˜¯ä¸€ç§åˆå§‹åŒ–çš„æ–¹å¼ã€‚

æ ‘çŠ¶æ•°ç»„çš„åˆå§‹åŒ–å¯ä»¥é€šè¿‡ã€Œå•ç‚¹æ›´æ–°ã€æ¥å®ç°ï¼Œå› ä¸ºæœ€å¼€å§‹çš„æ—¶å€™ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½ä¸º 0ï¼Œæ¯ä¸ªéƒ½å¯¹åº”åœ°åŠ ä¸ŠåŸå§‹æ•°ç»„çš„å€¼ï¼Œå°±å®Œæˆäº†é¢„å¤„ç†æ•°ç»„ C çš„åˆ›å»ºã€‚

è¿™é‡Œè¦ç‰¹åˆ«æ³¨æ„ï¼Œupdate æ“ä½œçš„ç¬¬ 2 ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå˜åŒ–å€¼ï¼Œè€Œä¸æ˜¯å˜åŒ–ä»¥åçš„å€¼ã€‚å› ä¸ºæˆ‘ä»¬çš„æ“ä½œæ˜¯é€å±‚å‘ä¸Šæ±‡æŠ¥ï¼Œæ±‡æŠ¥å˜æ›´å€¼ä¼šè®©æˆ‘ä»¬çš„æ“ä½œæ›´åŠ ç®€å•ã€‚

```java
public FenwickTree(int[] nums) {
    this.len = nums.length + 1;
    tree = new int[this.len + 1];
    for (int i = 1; i <= len; i++) {
        update(i, nums[i]);
    }
}
```

## ä¸‰ã€æ ‘çŠ¶æ•°ç»„æ¨¡ç‰ˆ

n ä¸ºåŸå§‹æ•°ç»„çš„å…ƒç´ ä¸ªæ•°

idx ä¸ºä» 1 å¼€å§‹è®¡ï¼Œ0 å·ä¸‹æ ‡ä¸ç”¨

### c++

```c++
class FenwickTree {
public:
    int size;
    vector<int> tree;

    FenwickTree(int n) {
        size = n;
        tree.resize(size + 1, 0);
    }
    int lowbit(int idx) {
        // idx ä¸ºæ ‘çŠ¶æ•°ç»„ä¸‹æ ‡
        return idx & (-idx);
    }
    void add(int idx, int delta) {
        // å•ç‚¹æ›´æ–°ï¼Œä»å‰å¾€åï¼Œidx ä¸ºæ ‘çŠ¶æ•°ç»„ä¸‹æ ‡
        // delta ä¸ºå˜åŒ–é‡ï¼Œå¦‚æœå·²çŸ¥éœ€è¦å˜åŒ–çš„å€¼valï¼Œä¼ å…¥ val - åŸå§‹æ•°ç»„[idx-1]
        while (idx < size + 1) {
            tree[idx] += delta;
            idx += lowbit(idx);
        }
    }
    int query(int idx) {
        // æŸ¥è¯¢å‰ç¼€å’Œï¼Œä»åå¾€å‰ï¼Œidx ä¸ºæ ‘çŠ¶æ•°ç»„ä¸‹æ ‡
        int sum = 0;
        while (idx > 0) {
            sum += tree[idx];
            idx -= lowbit(idx);
        }
        return sum;
    }
    int sumRange(int left, int right) {
        // left, right ä¸ºæ ‘çŠ¶æ•°ç»„ä¸‹æ ‡
        int preLeft = query(left - 1);
        int preRight = query(right);
        return preRight - preLeft;
    }
};
```

### python

```python
class FenwickTree:
    def __init__(self, n):
        self.size = n
        self.tree = [0 for _ in range(n + 1)]

    def __lowbit(self, idx):
        return idx & (-idx)

    # å•ç‚¹æ›´æ–°ï¼šä»ä¸‹åˆ°ä¸Šï¼Œæœ€å¤šåˆ° sizeï¼Œå¯ä»¥å–ç­‰
    def add(self, idx, delta):
        while idx <= self.size:
            self.tree[idx] += delta
            idx += self.__lowbit(idx)

    # åŒºé—´æŸ¥è¯¢ï¼šä»ä¸Šåˆ°ä¸‹ï¼Œæœ€å°‘åˆ° 1ï¼Œå¯ä»¥å–ç­‰
    def query(self, idx):
        res = 0
        while idx > 0:
            res += self.tree[idx]
            idx -= self.__lowbit(idx)
        return res
```

### java

```java
public class FenwickTree {

    /**
     * é¢„å¤„ç†æ•°ç»„
     */
    private int[] tree;
    private int len;

    public FenwickTree(int n) {
        this.len = n;
        tree = new int[n + 1];
    }

    /**
     * å•ç‚¹æ›´æ–°
     *
     * @param i     åŸå§‹æ•°ç»„ç´¢å¼• i
     * @param delta å˜åŒ–å€¼ = æ›´æ–°ä»¥åçš„å€¼ - åŸå§‹å€¼
     */
    public void update(int i, int delta) {
        // ä»ä¸‹åˆ°ä¸Šæ›´æ–°ï¼Œæ³¨æ„ï¼Œé¢„å¤„ç†æ•°ç»„ï¼Œæ¯”åŸå§‹æ•°ç»„çš„ len å¤§ 1ï¼Œæ•… é¢„å¤„ç†ç´¢å¼•çš„æœ€å¤§å€¼ä¸º len
        while (i <= len) {
            tree[i] += delta;
            i += lowbit(i);
        }
    }

    /**
     * æŸ¥è¯¢å‰ç¼€å’Œ
     *
     * @param i å‰ç¼€çš„æœ€å¤§ç´¢å¼•ï¼Œå³æŸ¥è¯¢åŒºé—´ [0, i] çš„æ‰€æœ‰å…ƒç´ ä¹‹å’Œ
     */
    public int query(int i) {
        // ä»å³åˆ°å·¦æŸ¥è¯¢
        int sum = 0;
        while (i > 0) {
            sum += tree[i];
            i -= lowbit(i);
        }
        return sum;
    }

    public static int lowbit(int x) {
        return x & (-x);
    }
}
```

## å››ã€çº¿æ®µæ•°æ¨¡ç‰ˆ

### c++

[çº¿æ®µæ ‘æ¨¡ç‰ˆé¢˜ã€Œæ±‡æ€»çº§åˆ«æ•´ç† ğŸ”¥ğŸ”¥ğŸ”¥ã€](https://leetcode.cn/problems/shifting-letters-ii/solution/by-lfool-vbqw/)

```c++
struct Node{
    int l, r;
    int sum;
};

class NumArray {
private:
    vector<Node> tr;
    vector<int> nums;
    int n;
public:
    NumArray(vector<int>& nums) 
    {
        n = nums.size();
        tr = vector<Node>(n * 4);
        this -> nums = nums;
        build(1, 1, n);//å»ºç«‹çº¿æ®µæ ‘
    }
    
    void update(int index, int val) 
    {
        modify(1, index + 1, val);
    }
    
    int sumRange(int left, int right) 
    {
        return query(1, left + 1, right + 1).sum;
    }

    void build(int u, int l, int r)
    {
        if (l == r) tr[u] = {l, r, nums[l - 1]};
        else
        {
            tr[u] = {l, r};
            int mid = l + r >> 1;
            build(u << 1, l, mid), build(u << 1 | 1, mid + 1, r);
            pushup(u);
        }
    }//çº¿æ®µæ ‘åˆå§‹åŒ–

    void pushup(Node &u, Node &l, Node &r)
    {
        u.sum = l.sum + r.sum;
    }//å‘ä¸Šè°ƒæ•´

    void pushup(int u)
    {
        pushup(tr[u], tr[u << 1], tr[u << 1 | 1]);
    }//å‘ä¸Šè°ƒæ•´

    void modify(int u, int x, int val)
    {
        if (tr[u].l == x && tr[u].r == x) tr[u] = {x, x, val};
        else
        {
            int mid = tr[u].l + tr[u].r >> 1;
            if (x <= mid) modify(u << 1, x, val);//å·¦è¾¹æ›´æ–°
            else modify(u << 1 | 1, x, val);//å³è¾¹æ›´æ–°
            pushup(u);//å‘ä¸Šæ›´æ–°çˆ¶èŠ‚ç‚¹
        }
    }

    Node query(int u, int l, int r)
    {
        if (tr[u].l >= l && tr[u].r <= r) return tr[u];//è¿”å›ç»“ç‚¹
        else
        {
            int mid = tr[u].l + tr[u].r >> 1;
            if (r <= mid) return query(u << 1, l, r);//å·¦è¾¹æŸ¥è¯¢
            else if (l > mid) return query(u << 1 | 1, l, r);//å³è¾¹æŸ¥è¯¢
            else
            {
                auto left = query(u << 1, l, r);
                auto right = query(u << 1 | 1, l, r);
                Node res;
                pushup(res, left, right);//ä¸¤è¾¹æŸ¥è¯¢åè¿”å›ç»“ç‚¹å’Œ
                return res;
            }
        }
    }

};
```

