# å¤„ç†å™¨è°ƒåº¦

å¤ä¹ 

- æœºåˆ¶ (mechanism)ï¼šä¸Šä¸‹æ–‡åˆ‡æ¢
    - åœ¨ä¸­æ–­/ç³»ç»Ÿè°ƒç”¨æ—¶æ‰§è¡Œæ“ä½œç³»ç»Ÿä»£ç 
    - æ“ä½œç³»ç»Ÿå®ç°æ‰€æœ‰çŠ¶æ€æœº (è¿›ç¨‹) ä¸€è§†åŒä»çš„ â€œå°å­˜â€
    - ä»è€Œå¯ä»¥æ¢å¤ä»»æ„ä¸€ä¸ªçŠ¶æ€æœº (è¿›ç¨‹) æ‰§è¡Œ

------

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: ç­–ç•¥ (policy)ï¼šé‚£æˆ‘ä»¬åˆ°åº•é€‰å“ªä¸ªè¿›ç¨‹æ‰§è¡Œå‘¢ï¼Ÿ

------

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- å¸¸è§è°ƒåº¦ç®—æ³•ï¼šRound-Robin, ä¼˜å…ˆçº§, MLFQ, CFS
- å‘Šè¯‰å¤§å®¶ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿™é—¨è¯¾ä¸è®² â€œè°ƒåº¦ç®—æ³•â€

## ä¸€ã€å¤„ç†å™¨è°ƒåº¦ (1)

### 1ã€ç®€åŒ–çš„å¤„ç†å™¨è°ƒåº¦é—®é¢˜

ä¸­æ–­æœºåˆ¶

- å¤„ç†å™¨ä»¥å›ºå®šçš„é¢‘ç‡è¢«ä¸­æ–­
    - Linux Kernel å¯ä»¥é…ç½®ï¼š100/250/300/1000Hz
- ä¸­æ–­/ç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶å¯ä»¥è‡ªç”±é€‰æ‹©è¿›ç¨‹/çº¿ç¨‹æ‰§è¡Œ

![image-20220807154510653](./doc/image-20220807154510653.png)

------

å¤„ç†å™¨è°ƒåº¦é—®é¢˜çš„ç®€åŒ–å‡è®¾

- ç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªå¤„ç†å™¨ (1970s)
- ç³»ç»Ÿä¸­æœ‰å¤šä¸ªè¿›ç¨‹/çº¿ç¨‹å…±äº« CPU
    - åŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨ (è¿›ç¨‹/çº¿ç¨‹çš„ä¸€éƒ¨åˆ†ä»£ç åœ¨ syscall ä¸­æ‰§è¡Œ)
    - å¶å°”ä¼šç­‰å¾… I/O è¿”å›ï¼Œä¸ä½¿ç”¨ CPU (é€šå¸¸æ—¶é—´è¾ƒé•¿)

### 2ã€ç­–ç•¥: Round-Robin

å‡è®¾å½“å‰ Ti è¿è¡Œ

- ä¸­æ–­åè¯•å›¾åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªçº¿ç¨‹ T(i+1)modn
- å¦‚æœä¸‹ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾… I/O è¿”å›ï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
    - å¦‚æœç³»ç»Ÿæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¸éœ€è¦ CPUï¼Œå°±è°ƒåº¦ idle çº¿ç¨‹æ‰§è¡Œ

------

æˆ‘ä»¬çš„ [thread-os.c](http://jyywiki.cn/pages/OS/2022/demos/thread-os.c) å®é™…ä¸Šå®ç°äº† Round-Robin çš„è°ƒåº¦å™¨

- ä¸­æ–­ä¹‹é—´çš„çº¿ç¨‹æ‰§è¡Œç§°ä¸º â€œæ—¶é—´ç‰‡â€ (time-slicing)

![img](./doc/sched-rr.png)

### 3ã€ç­–ç•¥ï¼šå¼•å…¥ä¼˜å…ˆçº§

UNIX niceness

- -20 .. 19 çš„æ•´æ•°ï¼Œè¶Š nice è¶Šè®©åˆ«äººå¾—åˆ° CPU

    - -20: æå; most favorable to the process
    - 19: æå¥½; least favorable to the process

- åŸºäºä¼˜å…ˆçº§çš„è°ƒåº¦ç­–ç•¥

    - RTOS: åäººèººä¸‹å¥½äººæ‰èƒ½ä¸Šï¼Œå…ˆæ»¡è¶³åäººçš„éœ€æ±‚ï¼Œå¥½äººç­‰ç€
        - ~~å¥½äººæµä¸‹äº†æ‚”æ¨çš„æ³ªæ°´~~
    - Linux: nice ç›¸å·® 10, CPU èµ„æºè·å¾—ç‡ç›¸å·® 10 å€

- ä¸å¦¨è¯•ä¸€è¯•: nice/renice
    - å°†ä¸€ä¸ªè¿›ç¨‹åªæ´¾åˆ°ä¸€ä¸ª cpu ä¸Šï¼Œ`-c 0` é™åˆ¶åˆ° cpu0 ä¸Š
    - `-n 19` è®¾ç½®ä¼˜å…ˆçº§


    taskset -c 0 nice -n 19 yes > /dev/null &
    taskset -c 0 nice -n  9 yes > /dev/null &

![image-20220807161153704](./doc/image-20220807161153704.png)

## äºŒã€çœŸå®çš„å¤„ç†å™¨è°ƒåº¦(1)

### 1ã€Round-Robin çš„é—®é¢˜

ç³»ç»Ÿé‡Œæœ‰ä¸¤ä¸ªè¿›ç¨‹

- äº¤äº’å¼çš„ Vimï¼Œå•çº¿ç¨‹
- çº¯ç²¹è®¡ç®—çš„ [mandelbrot.c](http://jyywiki.cn/pages/OS/2022/demos/mandelbrot.c), 32 ä¸ªçº¿ç¨‹

------

Round-Robin

- Vim èŠ± 0.1ms å¤„ç†å®Œè¾“å…¥å°±åˆç­‰è¾“å…¥äº†
    - ä¸»åŠ¨è®©å‡º CPU
- Mandelbrot ä½¿ Vim åœ¨æœ‰è¾“å…¥å¯ä»¥å¤„ç†çš„æ—¶å€™è¢«å»¶è¿Ÿ
    - å¿…é¡»ç­‰å½“å‰çš„ Mandelbrot è½¬å®Œä¸€åœˆ
    - æ•°ç™¾ ms çš„å»¶è¿Ÿå°±ä¼šä½¿äººæ„Ÿåˆ°æ˜æ˜¾å¡é¡¿
- ä½ ä»¬ä¼šåœ¨ L2 é‡Œé‡åˆ°è¿™æ ·çš„é—®é¢˜
    - è¡¨ç°å½¢å¼ï¼štty å¡é¡¿

### 2ã€ç­–ç•¥ï¼šåŠ¨æ€ä¼˜å…ˆçº§ (MLFQ)

ä¸ä¼šè®¾ç½®ä¼˜å…ˆçº§ï¼Ÿè®©ç³»ç»Ÿè‡ªåŠ¨è®¾å®šï¼

![img](./doc/MLFQ.png)

- è®¾ç½®è‹¥å¹²ä¸ª Round-Robin é˜Ÿåˆ—
    - æ¯ä¸ªé˜Ÿåˆ—å¯¹åº”ä¸€ä¸ªä¼˜å…ˆçº§
- åŠ¨æ€ä¼˜å…ˆçº§è°ƒæ•´ç­–ç•¥
    - ä¼˜å…ˆè°ƒåº¦é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—
    - ç”¨å®Œæ—¶é—´ç‰‡ â†’ åäºº
        - Mandelbrot: è¯·ä½ å˜å¾—æ›´å¥½
    - è®©å‡º CPU I/O â†’ å¥½äºº
        - Vim: ä½ å¯ä»¥å˜å¾—æ›´å
- é˜…è¯»æ•™ç§‘ä¹¦

### 3ã€ç­–ç•¥ï¼šComplete Fair Scheduling (CFS)

è¯•å›¾å»æ¨¡æ‹Ÿä¸€ä¸ª â€œIdeal Multi-Tasking CPUâ€: 

- â€œIdeal multi-tasking CPUâ€ is a (non-existent :-)) CPU that has 100% physical power and which can run each task at precise equal speed, in parallel, each at . For example: if there are 2 tasks running, then it runs each at 50% physical power â€” i.e., actually in parallel.

------

â€œè®©ç³»ç»Ÿé‡Œçš„æ‰€æœ‰è¿›ç¨‹å°½å¯èƒ½å…¬å¹³åœ°å…±äº«å¤„ç†å™¨â€

- ä¸ºæ¯ä¸ªè¿›ç¨‹è®°å½•ç²¾ç¡®çš„è¿è¡Œæ—¶é—´
- ä¸­æ–­/å¼‚å¸¸å‘ç”Ÿåï¼Œåˆ‡æ¢åˆ°è¿è¡Œæ—¶é—´æœ€å°‘çš„è¿›ç¨‹æ‰§è¡Œ
    - ä¸‹æ¬¡ä¸­æ–­/å¼‚å¸¸åï¼Œå½“å‰è¿›ç¨‹çš„å¯èƒ½å°±ä¸æ˜¯æœ€å°çš„äº†

### 4ã€CFS: å®ç°ä¼˜å…ˆçº§

æ“ä½œç³»ç»Ÿå…·æœ‰å¯¹ç‰©ç†æ—¶é’Ÿçš„ â€œç»å¯¹æ§åˆ¶â€ï¼Œ**æŠŠç‰©ç†çš„æ—¶é—´å˜æˆè™šæ‹Ÿçš„æ—¶é—´**

- æ¯äººæ‰§è¡Œ 1msï¼Œä½†å¥½äººçš„é’Ÿå¿«ä¸€äº›ï¼Œåäººçš„é’Ÿæ…¢ä¸€äº›
    - vruntime (virtual runtime)
    - vrt[i] / vrt[j] çš„å¢åŠ æ¯”ä¾‹ = wt[j] / wt[i]

```c
const int sched_prio_to_weight[40] = {
  /* -20 */ 88761, 71755, 56483, 46273, 36291,
  /* -15 */ 29154, 23254, 18705, 14949, 11916,
  /* -10 */  9548,  7620,  6100,  4904,  3906,
  /*  -5 */  3121,  2501,  1991,  1586,  1277,
  /*   0 */  1024,   820,   655,   526,   423,
  /*   5 */   335,   272,   215,   172,   137,
  /*  10 */   110,    87,    70,    56,    45,
  /*  15 */    36,    29,    23,    18,    15,
};
```

### 5ã€CFS çš„å¤æ‚æ€§ (1): æ–°è¿›ç¨‹/çº¿ç¨‹

å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ vruntime

- å¹¶ä¸”ä» 2.6.32 å¼€å§‹ï¼Œ[parent run first](https://lkml.org/lkml/2009/9/11/411)

```c
static void task_fork_fair(struct task_struct *p) {
  struct sched_entity *se = &p->se, *curr;
  ...
  rq_lock(rq, &rf);
  update_rq_clock(rq);
  cfs_rq = task_cfs_rq(current);
  curr = cfs_rq->curr;
  if (curr) {
    update_curr(cfs_rq);
    se->vruntime = curr->vruntime; // ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ vruntime
  }
  place_entity(cfs_rq, se, 1);
  ...
```

### 6ã€CFS çš„å¤æ‚æ€§ (2): I/O

I/O (ä¾‹å¦‚ 1 åˆ†é’Ÿ) ä»¥åå›æ¥ vruntime ä¸¥é‡è½å

- ä¸ºäº†èµ¶ä¸Šï¼ŒCPU ä¼šå…¨éƒ¨å½’å®ƒæ‰€æœ‰

------

Linux çš„å®ç°

- è¢«å”¤é†’çš„è¿›ç¨‹è·å¾— â€œæœ€å°â€ çš„ vruntime (å¯ä»¥ç«‹å³è¢«æ‰§è¡Œ)
    - æ›¾ç»ä¼šç»™å”¤é†’çš„è¿›ç¨‹ä¸€äº›é¢å¤–çš„ vruntime
    - ç°åœ¨æ²¡æœ‰äº†

```c
if (renorm && curr)
  se->vruntime += cfs_rq->min_vruntime;
```

### 7ã€CFS çš„å¤æ‚æ€§ (3): æ•´æ•°æº¢å‡º

vruntime æœ‰ä¼˜å…ˆçº§çš„ â€œå€æ•°â€

- å¦‚æœæº¢å‡ºäº† 64-bit æ•´æ•°æ€ä¹ˆåŠâ€¦â€¦ï¼Ÿ
    - `a < b` ä¸å†ä»£è¡¨ â€œå°äºâ€ï¼

------

å‡è®¾ï¼šç³»ç»Ÿä¸­æœ€è¿‘ã€æœ€è¿œçš„æ—¶åˆ»å·®ä¸è¶…è¿‡æ•°è½´çš„ä¸€åŠ

- æˆ‘ä»¬å¯ä»¥æ¯”è¾ƒå®ƒä»¬çš„ç›¸å¯¹å¤§å°

```c
bool less(u64 a, u64 b) {
  return (i64)(a - b) < 0;
}
```

### 8ã€å®ç° CFS çš„æ•°æ®ç»“æ„

ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„ç»´æŠ¤æ‰€æœ‰è¿›ç¨‹çš„ vruntime?

- ä»»ä½•æœ‰åºé›†åˆ (ä¾‹å¦‚ binary search tree) ç»´æŠ¤çº¿ç¨‹ t çš„ vrt(t)
    - æ›´æ–° vrt(t)â†vrt(t)+Î”t/w
    - å–æœ€å°çš„ vrt
    - è¿›ç¨‹åˆ›å»º/é€€å‡º/ç¡çœ /å”¤é†’æ—¶æ’å…¥/åˆ é™¤ t

------

é“ç†è¿˜æŒºç®€å•çš„

- ä»£ç å®ç°æœ‰å›°éš¾
- è¿˜ä¸èƒ½æœ‰å¹¶å‘ bugâ€¦â€¦

### 9ã€å°ç»“ï¼šæ˜¯å¦è§£å†³äº†é—®é¢˜ï¼Ÿ

è€ƒè™‘ä¸‰ç§æƒ…å†µï¼šProducer, Consumer, `while (1)`

- Round-Robin (L2)
    - Producer/Consumer è·å¾—éå¸¸å°‘æ¯”ä¾‹çš„ CPU
- MLFQ
    - Producer/Consumer è·å¾—æœ€é«˜ä¼˜å…ˆçº§ Round-Robin
    - `while (1)` å®Œå…¨é¥¥é¥¿ â†’ éœ€è¦å®šæœŸæŠŠæ‰€æœ‰äººä¼˜å…ˆçº§ â€œæ‹‰å¹³â€
- CFS
    - çº¿ç¨‹æœ‰ç²¾ç¡®çš„ accounting ä¿¡æ¯
    - è¿™äº›ä¿¡æ¯å¯ä»¥æŒ‡å¯¼ Round-Robin
        - é€‚å½“ä½¿ç”¨ uptime (ä¸å¿…å¤ªç²¾ç¡®) å¯ä»¥å¤§å¹…ç¼“è§£ L2

## ä¸‰ã€çœŸå®çš„å¤„ç†å™¨è°ƒåº¦ (2)

### 1ã€ä¸è¦é«˜å…´å¾—å¤ªæ—©ï¼ˆä¼˜å…ˆçº§åè½¬ï¼‰

```c
void xiao_zhang() { // é«˜ä¼˜å…ˆçº§
  sleep(1); // ä¼‘æ¯ä¸€ä¸‹å…ˆ
  mutex_lock(&wc);
  ...
}

void xi_zhu_ren() { // ä¸­ä¼˜å…ˆçº§
  while (1) ;
}

void jyy() { // æœ€ä½ä¼˜å…ˆçº§
  mutex_lock(&wc);
  ...
}
```

jyy åœ¨æŒæœ‰äº’æ–¥é”çš„æ—¶å€™è¢«èµ¶ä¸‹äº†å¤„ç†å™¨â€¦â€¦

### 2ã€è¿™ä¸ªæ•…äº‹åœ¨ç«æ˜Ÿä¸Šå‘ç”Ÿè¿‡ä¸€æ¬¡

Sojourner â€œæ¢è·¯è€…â€ (PathFinder)ï¼Œ1997 å¹´ 7 æœˆ 4 æ—¥ç™»é™†ç«æ˜Ÿ

### 3ã€[The First Bug on Mars](https://news.ycombinator.com/item?id=13210478)

Sojourner â€œæ¢è·¯è€…â€ (PathFinder)

- Lander (ç™»é™†èˆ±)
    - IBM Rad6000 SC (20 MIPS), 128 MiB RAM, 6 MiB EEPROM
    - VxWorks â€œå®æ—¶â€ ä»»åŠ¡æ“ä½œç³»ç»Ÿ
        - ASI/MET task: å¤§æ°”æˆåˆ†ç›‘æµ‹ (ä½)
        - `bc_dist` task: åˆ†å‘ä»»åŠ¡ (ä¸­)
        - `bc_sched` task: æ€»çº¿è°ƒåº¦ (é«˜)
- Rover (ç«æ˜Ÿè½¦)
    - Intel 80C85 (0.1 MIPS), 512K RAM, 176K Flash SSD
- ç€é™†åå¼€å§‹å‡ºç°ç³»ç»Ÿé‡å¯

![img](./doc/marsbot.png)

- (ä½ä¼˜å…ˆçº§) `select -> pipeIoctl -> selNodeAdd -> mutex_lock`
- (é«˜ä¼˜å…ˆçº§) `pipeWrite -> mutex_lock`

### 4ã€è§£å†³ä¼˜å…ˆçº§åè½¬é—®é¢˜

Linux: CFS å‡‘åˆç”¨å§

- å®æ—¶ç³»ç»Ÿï¼šç«æ˜Ÿè½¦åœ¨ CPU Reset å•Šå–‚ï¼Ÿï¼Ÿ
    - ä¼˜å…ˆçº§ç»§æ‰¿ (Priority Inheritance)/ä¼˜å…ˆçº§æå‡ (Priority Ceiling)
        - æŒæœ‰ mutex çš„çº¿ç¨‹/è¿›ç¨‹ä¼šç»§æ‰¿ block åœ¨è¯¥ mutex ä¸Šè¿›ç¨‹çš„æœ€é«˜ä¼˜å…ˆçº§
        - ä½†ä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ (ä¾‹å¦‚æ¡ä»¶å˜é‡å”¤é†’)
    - åœ¨ç³»ç»Ÿä¸­åŠ¨æ€ç»´æŠ¤èµ„æºä¾èµ–å…³ç³»
        - ä¼˜å…ˆçº§ç»§æ‰¿æ˜¯å®ƒçš„ç‰¹ä¾‹
        - ä¼¼ä¹æ›´å›°éš¾äº†â€¦â€¦
    - é¿å…é«˜/ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡äº‰æŠ¢èµ„æº
        - å¯¹æ½œåœ¨çš„ä¼˜å…ˆçº§åè½¬è¿›è¡Œé¢„è­¦ (lockdep)
        - TX-based: å†²çªçš„ TX å‘ç”Ÿæ—¶ï¼Œæ€»æ˜¯ä½ä¼˜å…ˆçº§çš„ abort

## å››ã€çœŸå®çš„å¤„ç†å™¨è°ƒåº¦ (3)

### 1ã€å¤šå¤„ç†å™¨è°ƒåº¦

è¿˜æ²¡å®Œï¼šæˆ‘ä»¬çš„è®¡ç®—æœºç³»ç»Ÿå¯æ˜¯å¤šæ ¸å¿ƒã€å¤šçº¿ç¨‹çš„ï¼

- æˆ‘ä»¬çš„è€æœåŠ¡å™¨ï¼š2 Socket x 24 Cores x 2 Threads = 96T

![img](./doc/2S-motherboard.jpg)

### 2ã€å¤šå¤„ç†å™¨è°ƒåº¦ï¼šè¢«ä½ä¼°çš„å¤æ‚æ€§

> â€œAnd you have to realize that there are not very many things that have aged as well as the scheduler. Which is just another proof that scheduling is easy.â€ â€”â€”Linus Torvalds, 2001

------

Linus ä»¥ä¸ºè°ƒåº¦æ˜¯ä¸ªæŒºç®€å•çš„é—®é¢˜ï¼Ÿ

- As a central part of resource management, the OS thread scheduler must maintain the following, simple, invariant:make sure that ready threads are scheduled on available cores... this invariant is often broken in Linux. Cores may stay idle for seconds while ready threads are waiting in runqueues.
    - [The Linux scheduler: A decade of wasted cores](https://dl.acm.org/doi/10.1145/2901318.2901326).  (EuroSys'16)
        - ä½œè€…åœ¨ç‹‚é»‘ Linus ğŸ˜‚

### 3ã€å¤šå¤„ç†å™¨è°ƒåº¦çš„å›°éš¾æ‰€åœ¨

æ—¢ä¸èƒ½ç®€å•åœ° â€œåˆ†é…çº¿ç¨‹åˆ°å¤„ç†å™¨â€

- çº¿ç¨‹é€€å‡ºï¼Œç¬é—´å¤„ç†å™¨å¼€å§‹å›´è§‚

------

ä¹Ÿä¸èƒ½ç®€å•åœ° â€œè°ç©ºä¸¢ç»™è°â€

- åœ¨å¤„ç†å™¨ä¹‹é—´è¿ç§»ä¼šå¯¼è‡´ cache/TLB å…¨éƒ½ç™½ç»™

------

å¤šå¤„ç†å™¨è°ƒåº¦çš„ä¸¤éš¾å¢ƒåœ°

- è¿ç§»ï¼Ÿå¯èƒ½è¿‡ä¸€ä¼šå„¿è¿˜å¾—ç§»å›æ¥
- ä¸è¿ç§»ï¼Ÿé€ æˆå¤„ç†å™¨çš„æµªè´¹

### 4ã€å®é™…æƒ…å†µ (1): å¤šç”¨æˆ·ã€å¤šä»»åŠ¡

è¿˜æ˜¯åˆšæ‰æœåŠ¡å™¨çš„ä¾‹å­

- é©¬ä¸Šè¦åˆ° paper deadline äº†ï¼ŒA å’Œ B è¦åœ¨æœåŠ¡å™¨ä¸Šè·‘å®éªŒ
    - A è¦è·‘ä¸€ä¸ªä»»åŠ¡ï¼Œå› ä¸ºè¦è°ƒç”¨ä¸€ä¸ªåº“ï¼Œåªèƒ½å•çº¿ç¨‹è·‘
    - B è·‘å¹¶è¡Œçš„ä»»åŠ¡ï¼Œåˆ›å»º 1000 ä¸ªçº¿ç¨‹è·‘
        - B è·å¾—å‡ ä¹ 100% çš„ CPU

------

æ›´ç³Ÿç³•çš„æ˜¯ï¼Œä¼˜å…ˆçº§è§£å†³ä¸äº†è¿™ä¸ªé—®é¢˜â€¦â€¦

- B ä¸èƒ½éšä¾¿æé«˜è‡ªå·±è¿›ç¨‹çš„ä¼˜å…ˆçº§
    - â€œAn unprivileged user can only increase the nice value and such changes are irreversible...â€

### 5ã€Linux Namespaces Control Groups (cgroups)

namespaces (7), cgroups (7)

- è½»é‡çº§è™šæ‹ŸåŒ–ï¼Œåˆ›é€  â€œæ“ä½œç³»ç»Ÿä¸­çš„æ“ä½œç³»ç»Ÿâ€
    - Mount, pid, network, IPC, user, cgroup namespace, time
    - cgroup å…è®¸ä»¥è¿›ç¨‹ç»„ä¸ºå•ä½ç®¡ç†èµ„æº
        - Docker å°±å˜å¾—å¾ˆå®¹æ˜“å®ç°äº†

![img](./doc/cgroups.jpg)

### 6ã€å®é™…æƒ…å†µ (2): Big.LITTLE/èƒ½æ•ˆæ¯”

Snapdragon 888

- 1X Prime Cortex-X1 (2.84GHz)
- 3X Performance Cortex-A78 (2.4GHz)
- 4X Efficiency Cortex-A55 (1.8GHz)

------

â€œDark siliconâ€ æ—¶ä»£çš„å›°å¢ƒ

- åŠŸç‡æ— æ³•æ”¯æ’‘æ‰€æœ‰ç”µè·¯åŒæ—¶å·¥ä½œ
- æ€»å¾—æœ‰ä¸€éƒ¨åˆ†æ˜¯åœä¸‹çš„
- Linux Kernel [EAS](https://www.kernel.org/doc/html/latest/scheduler/sched-energy.html) (Energy Aware Scheduler)

![img](http://jyywiki.cn/pages/OS/img/Snapdragon-888.png)

è½¯ä»¶å¯ä»¥é…ç½® CPU çš„å·¥ä½œæ¨¡å¼

- å¼€/å…³/å·¥ä½œé¢‘ç‡ (é¢‘ç‡è¶Šä½ï¼Œèƒ½æ•ˆè¶Šå¥½)
- å¦‚ä½•åœ¨ç»™å®šåŠŸç‡ä¸‹å¹³è¡¡å»¶è¿Ÿ v.s. ååé‡ï¼Ÿ

![img](./doc/power-curve.png)

### 7ã€å®é™…æƒ…å†µ (3): Non-Uniform Memory Access

å…±äº«å†…å­˜åªæ˜¯å‡è±¡

- L1 Cache èŠ±äº†å·¨å¤§çš„ä»£ä»·æ‰è®©ä½ æ„Ÿåˆ°å†…å­˜æ˜¯å…±äº«çš„
- Producer/Consumer ä½äºåŒä¸€ä¸ª/ä¸åŒ module æ€§èƒ½å·®è·å¯èƒ½å¾ˆå¤§

![img](./doc/EPYC-NUMA.png)

### 8ã€ç¨‹åºæ‰§è¡Œæ¯”ä½ æƒ³è±¡å¾—å¤æ‚

åŸºæœ¬çš„å‡è®¾å¯èƒ½ä¸å†æˆç«‹

- ä¾‹å­: more CPU time, more progress
    - æˆ‘ä»¬è¯¾å ‚ä¸Šçš„ä¾‹å­å°±å¯ä»¥ challenge è¿™ä¸€ç‚¹
    - [sum-atomic.c](http://jyywiki.cn/pages/OS/2022/demos/sum-atomic.c)

```
$ time taskset -c 0   ./a.out
$ time taskset -c 0,1 ./a.out
```

------

åˆ†é…äº† 1/2 çš„å¤„ç†å™¨èµ„æºï¼Œåè€Œé€Ÿåº¦æ›´å¿«äº†

- ç³»ç»Ÿé‡Œè¿›ç¨‹çš„è¡Œä¸ºå’Œäº¤äº’æ˜¯éå¸¸å¤æ‚çš„â€¦â€¦
    - NUMA é‡Œå°¤å…¶é‡è¦ (å½“ç„¶ä¸Šé¢çš„ä¾‹å­æ˜¯ä¸ª performance bugï¼‰

### 9ã€å®é™…æƒ…å†µ (4): CPU Hot-plug

ğŸ˜‚ğŸ˜‚ğŸ˜‚ æˆ‘è®²ä¸ä¸‹å»äº†

- å®åœ¨æ˜¯å¤ªå¤æ‚äº†
- æˆ‘ä¸æ˜¯ä»£ç çš„ç»´æŠ¤è€…ï¼Œå¹¶ä¸æ¸…æ¥šè¿™äº›ç»†èŠ‚
    - æŠŠä¸Šé¢éƒ½åŠ èµ·æ¥
        - è¿™å¾—è€ƒè™‘å¤šå°‘æƒ…å†µï¼Œå†™å¤šå°‘ä»£ç â€¦â€¦

------

å¤æ‚çš„ç³»ç»Ÿæ— äººå¯ä»¥æŒæ§

- [The battle of the schedulers: FreeBSD ULE vs. Linux CFS](https://www.usenix.org/system/files/conference/atc18/atc18-bouron.pdf).(ATC'18)
    - ç»“è®ºï¼šåœ¨ç°å®é¢å‰ï¼Œæ²¡æœ‰ç»å¯¹çš„èµ¢å®¶å’Œè¾“å®¶
    - å¦‚æœä½ è¿½æ±‚æè‡´çš„æ€§èƒ½ï¼Œå°±ä¸èƒ½å…¨æŒ‡æœ›ä¸€ä¸ªè°ƒåº¦ç®—æ³•

### 10ã€å›åˆ°å¤„ç†å™¨è°ƒåº¦

è°ƒåº¦æ˜¯å¤æ‚ã€æœ‰ç€æ·±è¿œè€ƒè™‘çš„å›°éš¾é—®é¢˜

- ä¸‹ä¸ªæ—¶é—´ç‰‡æœ‰ 10,000,000 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œåˆ†é…ç»™å“ªä¸ªçº¿ç¨‹ï¼Ÿ
- å­¦æ ¡é¢„ç®— 10,000,000 ç»è´¹ï¼Œæ€ä¹ˆåˆ†ç»™é™¢ç³»ï¼Ÿ
- å‘æ”¹å§”ä¸‹æ‹¨ 1000,000,000,000 ç»è´¹ï¼Œæ€ä¹ˆåˆ†ç»™å¤§å®¶ï¼Ÿ

------

å·¨å¤§çš„è®¾è®¡ç©ºé—´

- å»ºæ¨¡ (ç†è§£å’Œæ€»ç»“ â€œè¿‡å»å‘ç”Ÿäº†ä»€ä¹ˆâ€)
    - profiling å’Œ trace; PMU
- é¢„æµ‹ (è¯•å›¾é¢„çŸ¥æœªæ¥å¯èƒ½å‘ç”Ÿä»€ä¹ˆ)
- å†³ç­– (åº”è¯¥å¦‚ä½•è°ƒæ•´ç³»ç»Ÿè¡Œä¸º)

### 11ã€è°æ¥å®Œæˆå»ºæ¨¡-é¢„æµ‹-å†³ç­–ï¼Ÿ

æ“ä½œç³»ç»Ÿä¸ (å®Œå…¨) èƒŒè¿™ä¸ªé”…

- è®©ç¨‹åºæä¾› scheduling hints
- [ghOSt: Fast & flexible user-space delegation of Linux scheduling](https://dl.acm.org/doi/10.1145/3477132.3483542)(SOSP'21)

![img](./doc/ghost-sched.png)

## æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: ä¸­æ–­ååˆ°åº•åº”è¯¥æŠŠå“ªä¸ªè¿›ç¨‹/çº¿ç¨‹è°ƒåº¦åˆ°å¤„ç†å™¨ä¸Šï¼Ÿ

------

Take-away messages

- æœºåˆ¶ (åšå‡ºæ¥) å’Œç­–ç•¥ (åšå¾—å¥½)
    - æ„å»ºå¤æ‚ç³»ç»Ÿçš„å¸¸ç”¨æ–¹æ³•
- çœŸå®ä¸–ç•Œçš„å¤„ç†å™¨è°ƒåº¦
    - å¼‚æ„å¤„ç†å™¨ + Non-Uniform Memory Access
    - ä¼˜å…ˆçº§ç¿»è½¬
    - æ•™ç§‘ä¹¦ä¸Šçš„å†…å®¹éšæ—¶å¯èƒ½ä¼šè¢«æ”¹å†™