# æŒä¹…æ•°æ®çš„å¯é æ€§

## Overview

å¤ä¹ 

- æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼šbread/bwrite ä¸Šçš„æ•°æ®ç»“æ„
    - balloc/bfree
    - æ–‡ä»¶ï¼šFAT (é“¾è¡¨)/UNIX æ–‡ä»¶ç³»ç»Ÿ (ç´¢å¼•)
    - ç›®å½•æ–‡ä»¶

------

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- æ•°æ®ç»“æ„çš„å¦ä¸€ä¸ªå‡è®¾ï¼š**å†…å­˜å¯é ä¸”å¯ä»¥æ¥å—æ–­ç”µæ•°æ®ä¸¢å¤±**
- **Q**: æŒä¹…æ•°æ®æ˜¯ä¸èƒ½æ¥å—ä¸¢å¤±çš„ï¼Œå¦‚ä½•ä¿è¯æŒä¹…æ•°æ®çš„å¯é æ€§ï¼Ÿ

------

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- RAID (Redundant Array of Inexpensive Disks)
- å´©æºƒä¸€è‡´æ€§

## ä¸€ã€Redundant Array of Inexpensive Disks (RAID)

### 1ã€æ—¥æ¸å¢é•¿çš„æŒä¹…å­˜å‚¨éœ€æ±‚ (1)â€”â€”æ€§èƒ½

å­˜å‚¨ï¼šåªè¦ CPU (DMA) èƒ½å¤„ç†å¾—è¿‡æ¥ï¼Œæˆ‘å°±èƒ½æä¾›è¶³å¤Ÿçš„å¸¦å®½ï¼

- Computer System çš„ â€œindustryâ€ ä¼ ç»Ÿâ€”â€”åšçœŸå®æœ‰ç”¨çš„ç³»ç»Ÿ

![img](http://jyywiki.cn/pages/OS/img/emc-vnx5300.jpg)

### 2ã€æ—¥æ¸å¢é•¿çš„æŒä¹…å­˜å‚¨éœ€æ±‚ (2)â€”â€”å¯é æ€§

ä»»ä½•ç‰©ç†å­˜å‚¨ä»‹è´¨éƒ½æœ‰å¤±æ•ˆçš„å¯èƒ½

- ä½ ä¾ç„¶å¸Œæœ›åœ¨å­˜å‚¨è®¾å¤‡å¤±æ•ˆçš„æ—¶å€™èƒ½ä¿æŒæ•°æ®çš„å®Œæ•´
    - æå°æ¦‚ç‡äº‹ä»¶ï¼šæˆ˜äº‰çˆ†å‘/ä¸‰ä½“äººè¿›æ”»åœ°çƒ/ä¸–ç•Œæ¯ç­ ğŸ˜‚
    - å°æ¦‚ç‡äº‹ä»¶ï¼šç¡¬ç›˜æŸå
        - å¤§é‡é‡å¤ = å¿…ç„¶å‘ç”Ÿ (ä½†æˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›ç³»ç»Ÿèƒ½ç…§å¸¸è¿è½¬)

![img](http://jyywiki.cn/pages/OS/img/datacenter.jpg)

### 3ã€RAID: å­˜å‚¨è®¾å¤‡çš„è™šæ‹ŸåŒ–

> é‚£ä¹ˆï¼Œæ€§èƒ½å’Œå¯é æ€§ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½å…¨éƒ½è¦å‘¢ï¼Ÿ

Redundant Array of Inexpensive (*Independent*) Disks (RAID)

- æŠŠå¤šä¸ª (ä¸å¯é çš„) ç£ç›˜è™šæ‹Ÿæˆä¸€å—**éå¸¸å¯é ä¸”æ€§èƒ½æé«˜**çš„è™šæ‹Ÿç£ç›˜
    - [A case for redundant arrays of inexpensive disks (RAID)](https://dl.acm.org/doi/10.1145/971701.50214)(SIGMOD'88)

------

RAID æ˜¯ä¸€ä¸ª â€œåå‘â€ çš„è™šæ‹ŸåŒ–

- è¿›ç¨‹ï¼šæŠŠä¸€ä¸ª CPU åˆ†æ—¶è™šæ‹Ÿæˆå¤šä¸ªè™šæ‹Ÿ CPU
- è™šå­˜ï¼šæŠŠä¸€ä»½å†…å­˜é€šè¿‡ MMU è™šæ‹Ÿæˆå¤šä¸ªåœ°å€ç©ºé—´
- æ–‡ä»¶ï¼šæŠŠä¸€ä¸ªå­˜å‚¨è®¾å¤‡è™šæ‹Ÿæˆå¤šä¸ªè™šæ‹Ÿç£ç›˜

### 4ã€RAID çš„ Fault Model: Fail-Stop

ç£ç›˜å¯èƒ½åœ¨æŸä¸ªæ—¶åˆ»å¿½ç„¶å½»åº•æ— æ³•è®¿é—®

- æœºæ¢°æ•…éšœã€èŠ¯ç‰‡æ•…éšœâ€¦â€¦
    - ç£ç›˜å¥½åƒå°± â€œå¿½ç„¶æ¶ˆå¤±â€ äº† (æ•°æ®å®Œå…¨ä¸¢å¤±)
    - å‡è®¾ç£ç›˜èƒ½æŠ¥å‘Šè¿™ä¸ªé—®é¢˜ (å¦‚ä½•æŠ¥å‘Šï¼Ÿ)
- [An analysis of data corruption in the storage stack](https://www.usenix.org/conference/fast-08/analysis-data-corruption-storage-stack) (FAST'08)

------

åœ¨é‚£ä¸ªéåœ°æ˜¯é»„é‡‘çš„å¹´ä»£

- 1988: å‡‘å‡ å—ç›˜ï¼Œæ€ç¿»æ•´ä¸ªäº§ä¸šé“¾ï¼
    - â€œSingle Large Expensive Disksâ€ (IBM 3380), v.s.
    - â€œRedundant Array of Inexpensive Disksâ€

### 5ã€ä¸€ä¸ªæœ€ç®€å•çš„æƒ³æ³•

åœ¨ç³»ç»Ÿé‡Œå¤šæ¥å…¥ä¸€å—ç¡¬ç›˜ç”¨äº Fault Tolerance (RAID-1)

- å‡è®¾æœ‰ä¸¤å—ç›˜A, B
    - åŒæ ·è§„æ ¼ï¼Œå…±æœ‰ n å—
- â€œé•œåƒâ€ è™šæ‹Ÿç£ç›˜V
    - Viâ†’{Ai,Bi} (1â‰¤iâ‰¤n)

------

å—è¯»å†™

- bread(i)
    - å¯ä»¥ä» A æˆ– B ä¸­çš„ä»»æ„ä¸€ä¸ªè¯»å–
- bwrite(i)
    - åŒæ—¶å°†åŒæ ·çš„æ•°æ®å†™å…¥ A, B çš„åŒä¸€ä½ç½® 
- å®¹é”™ï¼Œä¸”è¯»é€Ÿåº¦ç¿»å€ (å‡è®¾å†…å­˜è¿œå¿«äºç£ç›˜)

### 6ã€RAID: Design Space

> RAID (è™šæ‹ŸåŒ–) = è™šæ‹Ÿç£ç›˜å—åˆ°ç‰©ç†ç£ç›˜å—çš„ â€œæ˜ å°„â€ã€‚

ä¸¤å—ç£ç›˜çš„å…¶ä»–æ‹¼æ¥æ–¹æ³•

- é¡ºåºæ‹¼æ¥
    - V1â†’A1, V2â†’A2, â€¦, Vnâ†’An
    - Vn+1â†’B1, Vn+2â†’B2, â€¦, V2nâ†’Bn
- äº¤é”™æ’åˆ— (RAID-0)
    - V1â†’A1, V2â†’B1
    - V3â†’A2, V4â†’B2
    - V2iâˆ’1â†’Ai, V2iâ†’Bi
- è™½ç„¶ä¸èƒ½å®¹é”™ï¼Œä½†å¯ä»¥åˆ©ç”¨å¥½ç£ç›˜çš„å¸¦å®½

![image-20220812215212517](./doc/image-20220812215212517.png)

RAID: å…è®¸ â€œå¤šå¯¹å¤šâ€ çš„æ˜ å°„ (ä¸€ç»„æ˜ å°„ç§°ä¸º â€œæ¡å¸¦â€, stripe)

![image-20220812215528270](./doc/image-20220812215528270.png)



![image-20220812215732141](./doc/image-20220812215732141.png)

> RAID-10ï¼šæœ‰æ—¶èƒ½å®¹å¿ä¸¤å—ç›˜åï¼Œæœ‰æ—¶å€™å´ä¸èƒ½ã€‚å¦‚æœæˆ‘ä»¬æœ‰å¾ˆå¤šå—ç›˜ï¼Œèƒ½å¦å‡å°‘æµªè´¹ï¼Ÿ

æ¢ä¸€ä¸ªé—®æ³•

![image-20220812220208830](./doc/image-20220812220208830.png)

### 7ã€RAID-4: Parity Disk

![image-20220812232253998](./doc/image-20220812232253998.png)

### 8ã€RAID-5: Rotating Parity

â€œäº¤é”™æ’åˆ—â€ parity block!

![img](/Users/zhangdong/Desktop/notes/Course/NJU-OS/doc/raid5.png)

### 9ã€AID-5: æ€§èƒ½åˆ†æ

è®©æ¯ä¸€å—ç›˜éƒ½æœ‰å‡ç­‰çš„æœºä¼šå­˜å‚¨ parity

- Sequential read/write: 3x (75% æ€»å¸¦å®½)
- Random read (tricky)
    - (read è¶³å¤Ÿå¤§ï¼Œæ‰€æœ‰ç£ç›˜éƒ½å¯ä»¥æä¾›æ•°æ®) 4x (100% æ€»å¸¦å®½)
- Random write (tricky)
    - D1=V1âŠ•V2âŠ•V3; å†™å…¥ä»»æ„ V1,V2,V3 éƒ½éœ€è¦æ›´æ–° D1
    - å¥‡å¶æ ¡éªŒä¾ç„¶ä¸¥é‡æ‹–æ…¢äº†éšæœºå†™å…¥
        - ä½†è‡³å°‘ n å—ç›˜å¯ä»¥è·å¾— n/4 çš„éšæœºå†™æ€§èƒ½
        - æœ‰ä¸€å®šçš„ scalability

### 10ã€RAID: è®¨è®º

æ›´å¿«ã€æ›´å¯é ã€è¿‘ä¹å…è´¹çš„å¤§å®¹é‡ç£ç›˜

- é©äº† â€œé«˜å¯é æ€§ç£ç›˜â€ çš„å‘½
    - æˆä¸ºä»Šå¤©æœåŠ¡å™¨çš„æ ‡å‡†é…ç½®
- ç±»ä¼¼çš„é‡Œç¨‹ç¢‘
    - [The Google file system](https://dl.acm.org/doi/10.1145/1165389.945450) (SOSP'03) å’Œ [MapReduce: Simplified data processing on large clusters](https://dl.acm.org/doi/10.5555/1251254.1251264) (OSDI'04) å¼€å¯ â€œå¤§æ•°æ®â€ æ—¶ä»£

------

RAID çš„å¯é æ€§

- RAID ç³»ç»Ÿå‘ç”Ÿæ–­ç”µï¼Ÿ
    - ä¾‹å­ï¼šRAID-1 é•œåƒç›˜å‡ºç°ä¸ä¸€è‡´çš„æ•°æ®
- æ£€æµ‹åˆ°ç£ç›˜åï¼Ÿ
    - è‡ªåŠ¨é‡ç»„

## äºŒã€å´©æºƒä¸€è‡´æ€§ä¸å´©æºƒæ¢å¤

### 1ã€å¦ä¸€ç§ Fault Model

ç£ç›˜å¹¶æ²¡æœ‰æ•…éšœ

- ä½†æ“ä½œç³»ç»Ÿå†…æ ¸å¯èƒ½ crashï¼Œç³»ç»Ÿå¯èƒ½æ–­ç”µ

![img](./doc/cat-crash-consistency.jpg)

æ–‡ä»¶ç³»ç»Ÿï¼šè®¾å¤‡ä¸Šçš„æ ‘ç»“æ„

- å³ä¾¿åªæ˜¯ append ä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿæ¶‰åŠå¤šå¤„ç£ç›˜çš„ä¿®æ”¹
    - FATã€ç›®å½•æ–‡ä»¶ (æ–‡ä»¶å¤§å°) å’Œæ•°æ®
    - ç£ç›˜æœ¬èº«ä¸æä¾› â€œall or nothingâ€ çš„æ”¯æŒ

### 2ã€å´©æºƒä¸€è‡´æ€§ (Crash Consistency)

> **Crash Consistency**: Move the file system from one consistent state (e.g., before the file got appended to) to another atomically (e.g., after the inode, bitmap, and new data block have been written to disk).

(ä½ ä»¬å¹³æ—¶ç¼–ç¨‹æ—¶å‡è®¾ä¸ä¼šå‘ç”Ÿçš„äº‹ï¼Œæ“ä½œç³»ç»Ÿéƒ½è¦ç»™ä½ å…œåº•)

------

ç£ç›˜ä¸æä¾›å¤šå—è¯»å†™ â€œall or nothingâ€ çš„æ”¯æŒ

- ç”šè‡³ä¸ºäº†æ€§èƒ½ï¼Œæ²¡æœ‰é¡ºåºä¿è¯
    - bwrite å¯èƒ½è¢«ä¹±åº
    - æ‰€ä»¥ç£ç›˜è¿˜æä¾›äº† bflush ç­‰å¾…å·²å†™å…¥çš„æ•°æ®è½ç›˜
    - å›åˆ°è¢«å¹¶å‘ç¼–ç¨‹æ”¯é…çš„ææƒ§ï¼Ÿ[peterson-barrier.c](http://jyywiki.cn/pages/OS/2022/demos/peterson-barrier.c)
- ~~é‚£æˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘æä¾›å•Šï¼š[Transactional flash](https://dl.acm.org/doi/10.5555/1855741.1855752) (OSDI'08)~~

### 3ã€ç£ç›˜ä¹±åºçš„åæœ

ä¸º FAT æ–‡ä»¶è¿½åŠ å†™å…¥ä¸€ä¸ª cluster (4KB) éœ€è¦æ›´æ–°

- ç›®å½•é¡¹ä¸­çš„æ–‡ä»¶å¤§å° (100 â†’ 4196)
- FAT è¡¨ä¸­ç»´æŠ¤çš„é“¾è¡¨ (EOF â†’ cluster-id, FREE â†’ EOF)
- å®é™…æ•°æ®

------

è¿™éº»çƒ¦äº†â€¦â€¦

- ä»»ä½•ä¸€ä¸ªå­é›†çš„å†™å…¥ä¸¢å¤±éƒ½å¯èƒ½å‡ºç°
- æ–‡ä»¶ç³»ç»Ÿå°±è¿›å…¥äº† â€œä¸ä¸€è‡´â€ çš„çŠ¶æ€
    - å¯èƒ½è¿å FAT çš„åŸºæœ¬å‡è®¾
        - é“¾è¡¨æ— ç¯ä¸”é•¿åº¦å’Œæ–‡ä»¶å¤§å°ä¸€è‡´
        - FREE çš„ cluster ä¸èƒ½æœ‰å…¥è¾¹
        - â€¦â€¦

### 4ã€File System Checking (FSCK)

æ ¹æ®ç£ç›˜ä¸Šå·²æœ‰çš„ä¿¡æ¯ï¼Œæ¢å¤å‡º â€œæœ€å¯èƒ½â€ çš„æ•°æ®ç»“æ„

![img](./doc/fsck-recovery.png)

- [SQCK: A declarative file system checker](https://dl.acm.org/doi/10.5555/1855741.1855751) (OSDI'08)
- [Towards robust file system checkers](https://dl.acm.org/doi/10.1145/3281031) (FAST'18)
    - â€œwidely used file systems (EXT4, XFS, BtrFS, and F2FS) may leave the file system in an uncorrectable state if the repair procedure is interrupted unexpectedlyâ€ ğŸ˜‚

## ä¸‰ã€æ—¥å¿— (Journaling)

### 1ã€é‡æ–°æ€è€ƒæ•°æ®ç»“æ„çš„å­˜å‚¨

ä¸¤ä¸ª â€œè§†è§’â€

1. å­˜å‚¨å®é™…**æ•°æ®ç»“æ„**
    - æ–‡ä»¶ç³»ç»Ÿçš„ â€œç›´è§‚â€ è¡¨ç¤º
    - crash unsafe
2. Append-only è®°å½•æ‰€æœ‰**å†å²æ“ä½œ**
    - â€œé‡åšâ€ æ‰€æœ‰æ“ä½œå¾—åˆ°æ•°æ®ç»“æ„çš„å½“å‰çŠ¶æ€
    - å®¹æ˜“å®ç°å´©æºƒä¸€è‡´æ€§

------

äºŒè€…çš„èåˆ

- æ•°æ®ç»“æ„æ“ä½œå‘ç”Ÿæ—¶ï¼Œç”¨ (2) append-only è®°å½•æ—¥å¿—
- æ—¥å¿—è½ç›˜åï¼Œç”¨ (1) æ›´æ–°æ•°æ®ç»“æ„
- å´©æºƒåï¼Œé‡æ”¾æ—¥å¿—å¹¶æ¸…é™¤ (ç§°ä¸º redo logï¼›ç›¸åº”ä¹Ÿå¯ä»¥ undo log)

### 2ã€å®ç° Atomic Append

ç”¨ bread, bwrite å’Œ bflush å®ç° append()

![img](./doc/fs-journaling.png)

1. å®šä½åˆ° journal çš„æœ«å°¾ (bread)
2. bwrite TXBegin å’Œæ‰€æœ‰æ•°æ®ç»“æ„æ“ä½œ
3. bflush ç­‰å¾…æ•°æ®è½ç›˜
4. bwrite TXEnd
5. bflush ç­‰å¾…æ•°æ®è½ç›˜
6. å°†æ•°æ®ç»“æ„æ“ä½œå†™å…¥å®é™…æ•°æ®ç»“æ„åŒºåŸŸ
7. ç­‰å¾…æ•°æ®è½ç›˜åï¼Œåˆ é™¤ (æ ‡è®°) æ—¥å¿—

### 3ã€Journaling: ä¼˜åŒ–

ç°åœ¨ç£ç›˜éœ€è¦å†™å…¥åŒä»½çš„æ•°æ®

- æ‰¹å¤„ç† (xv6; jbd)
    - å¤šæ¬¡ç³»ç»Ÿè°ƒç”¨çš„ Tx åˆå¹¶æˆä¸€ä¸ªï¼Œå‡å°‘ log çš„å¤§å°
    - jbd: å®šæœŸ write back
- Checksum (ext4)
    - ä¸å†æ ‡è®° TxBegin/TxEnd
    - ç›´æ¥æ ‡è®° Tx çš„é•¿åº¦å’Œ checksum
- Metadata journaling (ext4 default)
    - æ•°æ®å ç£ç›˜å†™å…¥çš„ç»å¤§éƒ¨åˆ†
        - åªå¯¹ inode å’Œ bitmap åš journaling å¯ä»¥æé«˜æ€§èƒ½
    - ä¿è¯æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„æ˜¯ä¸€è‡´çš„ï¼›ä½†æ•°æ®å¯èƒ½ä¸¢å¤±

### 4ã€Metadata Journaling

ä»åº”ç”¨è§†è§’æ¥çœ‹ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„è¡Œä¸ºå¯èƒ½å¾ˆæ€ªå¼‚

- å„ç±»ç³»ç»Ÿè½¯ä»¶ (git, sqlite, gdbm, ...) ä¸å¹¸ä¸­æ‹›
    - [All file systems are not created equal: On the complexity of crafting crash-consistent applications](https://cn.bing.com/search?q=All+file+systems+are+not+created+equal%3A+On+the+complexity+of+crafting+crash-consistent+applications&form=APMCS1&PC=APMC) (OSDI'14)
    - (os-workbench é‡Œçš„å°ç§˜å¯†)
- æ›´å¤šçš„åº”ç”¨ç¨‹åºå¯èƒ½å‘ç”Ÿ data loss
    - æˆ‘ä»¬çš„å·¥ä½œ: GNU coreutils, gmake, gzip, ... ä¹Ÿæœ‰é—®é¢˜
    - [Crash consistency validation made easy](https://dl.acm.org/doi/10.1145/2950290.2950327) (FSE'16)

------

æ›´ä¸ºä¸€åŠ³æ°¸é€¸çš„æ–¹æ¡ˆï¼šTxOS

- xbegin/xend/xabort ç³»ç»Ÿè°ƒç”¨å®ç°è·¨ syscall çš„ â€œall-or-nothingâ€
    - åº”ç”¨åœºæ™¯ï¼šæ•°æ®æ›´æ–°ã€è½¯ä»¶æ›´æ–°ã€check-useâ€¦â€¦
    - [Operating systems transactions](https://dl.acm.org/doi/10.1145/1629575.1629591) (SOSP'09)

## æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- Q

    : å¦‚ä½•ä¿è¯æŒä¹…æ•°æ®çš„å¯é æ€§ï¼Ÿ

    - ç¡¬ä»¶å†—ä½™ï¼šRAID
    - è½¯ä»¶å®¹é”™ï¼šfsck å’Œ journaling

------

Takeaway messages

- å¤šä¸ª bwrite ä¸ä¿è¯é¡ºåºå’ŒåŸå­æ€§
- Journaling: æ•°æ®ç»“æ„çš„ä¸¤ä¸ªè§†è§’
    - çœŸå®çš„æ•°æ®ç»“æ„
    - æ‰§è¡Œçš„å†å²æ“ä½œ