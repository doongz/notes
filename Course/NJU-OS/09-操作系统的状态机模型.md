# æ“ä½œç³»ç»Ÿçš„çŠ¶æ€æœºæ¨¡å‹

## Overview

å¤ä¹ 

- å¹¶å‘â€¦â€¦å°±è¿™ä¹ˆâ€¦â€¦è®²å®Œäº†â€¦â€¦
  - ç†è§£çš„æ–¹å¼ï¼šâ€œç©ä¸€ç©â€ ç¤ºä¾‹ä»£ç 

------

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: å¬è¯´æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ç¨‹åºã€‚é‚£åˆ°åº•æ˜¯é¸¡ç”Ÿè›‹è¿˜æ˜¯è›‹ç”Ÿé¸¡ï¼Ÿ

------

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- è½¯ä»¶å’Œç¡¬ä»¶çš„æ¡¥æ¢
- æ“ä½œç³»ç»Ÿçš„åŠ è½½å’Œåˆå§‹åŒ–
- AbstractMachine ä»£ç å¯¼è¯»

## ä¸€ã€è‡ªå·±åŠ¨æ‰‹å†™æ“ä½œç³»ç»Ÿ

### 1ã€æ—¶äº‹çƒ­è¯„

[å°å­¦ç”Ÿå†™äº†ä¸‰ä¸ªæœˆçš„æ“ä½œç³»ç»Ÿæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ](https://www.bilibili.com/video/BV14T4y1D7y8)

- çœ‹åˆ° i386 å°±çŸ¥é“äº†å˜›

### 2ã€æœ¬å­¦æœŸçš„ OSLabs

çƒ­èº«å®éªŒ

- Lab0 (amgame): ç†Ÿæ‚‰ä»£ç æ¡†æ¶

æ­£ç»å®éªŒ

- Lab1 (pmm): Physical memory management
  - å¤šå¤„ç†å™¨ (bare-metal) ä¸Šçš„ kalloc/free
- Lab2 (kmt): Kernel multi-threading
  - ä¸­æ–­å’Œå¼‚å¸¸é©±åŠ¨çš„ä¸Šä¸‹æ–‡ (çº¿ç¨‹) åˆ‡æ¢
- Lab3 (uproc): User processes
  - è™šæ‹Ÿåœ°å€ç©ºé—´ã€ç”¨æˆ·æ€è¿›ç¨‹å’Œç³»ç»Ÿè°ƒç”¨
- Lab4 (vfs): Virtual file system
  - devfs, procfs, ç®€å•çš„æ–‡ä»¶ç³»ç»Ÿï¼›ELF åŠ è½½å™¨

### 3ã€å®ç°æ“ä½œç³»ç»Ÿï¼šåˆ°åº•æœ‰å¤šéš¾ï¼Ÿ

å¿ƒè·¯å†ç¨‹

- æ›¾ç»çš„æˆ‘ï¼šå“‡ï¼è¿™ä¹Ÿå¯ä»¥ï¼Ÿ
- ç°åœ¨çš„æˆ‘ï¼šå“¦ã€‚å‘µå‘µå‘µã€‚

> éŸ©å¯’ï¼šâ€œè¢«å°å­¦ç”Ÿæ”¯é…çš„ææƒ§ï¼Œè€Œæˆ‘ä¹Ÿæ›¾å¯¹é‚£ç§åŠ›é‡ï¼Œä¸€æ— æ‰€çŸ¥ã€‚â€
>
> - ã€ŒæŠ¤çƒåƒæ¢…è¥¿ï¼Œå°„é—¨åƒè´åˆ©ã€çš„é‡‘å±±åŒºé½è¾¾å†…ï¼Œæ»¡æ€€æœŸå¾…åœ°å»å’Œå„¿ç«¥é¢„å¤‡é˜Ÿæ¯”èµ›ï¼Œç»“æœè¢«çŒäº† 20 å¤šçƒã€‚
>
> Bill Gates: æˆ‘é€‰æ‹©é€€å­¦ã€‚

### 4ã€å¤§å­¦çš„çœŸæ­£æ„ä¹‰

å°†å·²æœ‰çš„çŸ¥è¯†å’Œæ–¹æ³•é‡æ–°æ¶ˆåŒ–ï¼Œä¸ºå¤§å®¶å»ºç«‹å¥½ â€œå°é˜¶â€ï¼Œ**åœ¨æœ‰é™çš„æ—¶é—´é‡Œè¿…é€Ÿèµ¶ä¸Šæ•°åå¹´æ¥å»ºç«‹èµ·çš„å­¦ç§‘ä½“ç³»**ã€‚

ä»Šå¤©çš„å­¦æœ¯ç•Œå¯æ¯” Bill Gates çš„æ—¶ä»£å·å¤šäº†

- å­¦æœ¯ç•ŒåŸºæœ¬æ²¡å•¥æ˜¯éœ€è¦ä¸€ä¸ªæ¯›å¤´å°ä¼™å­æ¥æ•™çš„

------

ä¾‹å­ï¼šç ´é™¤ â€œå†™æ“ä½œç³»ç»Ÿå¾ˆéš¾â€ã€â€œå†™æ“ä½œç³»ç»Ÿå¾ˆç‰›â€ çš„é”™è¯¯è®¤è¯†

- æ“ä½œç³»ç»ŸçœŸçš„å°±æ˜¯ä¸ª C ç¨‹åº
- ä½ åªæ˜¯éœ€è¦ â€œè¢«æ­£ç¡®å‘ŠçŸ¥â€ ä¸€äº›é¢å¤–çš„çŸ¥è¯†
  - ç„¶åå†™ä»£ç ã€åƒè‹¦å¤´
  - ä»è€Œå»ºç«‹æ­£ç¡®çš„ â€œä¸“ä¸šä¸–ç•Œè§‚â€

### 5ã€ä¾‹å­

â€œä¸“ä¸šä¸–ç•Œè§‚â€ çš„ä¾‹å­ (è¿™äº›éƒ½æ²¡å•¥ï¼Œpaper éƒ½å‘ä¸äº†)

- å†™ x86 æ¨¡æ‹Ÿå™¨çš„æ—¶å€™ï¼Œä¸çŸ¥é“å“ªæ¡æŒ‡ä»¤é”™äº†ï¼Œæ€ä¹ˆåŠï¼Ÿ
- åšæ“ä½œç³»ç»Ÿå®éªŒçš„æ—¶å€™ï¼Œå¦‚æœé‡åˆ°ç¥ç§˜ CPU Resetï¼Œæ€ä¹ˆåŠï¼Ÿ
- åšå®éªŒåšä¸ä¸‹å»çš„æ—¶å€™ï¼Œè¯¥å®ç°ä»€ä¹ˆå·¥å…·ï¼Ÿ

------

â€œä¸“ä¸šä¸–ç•Œè§‚â€ çš„å­¦ä¹ æ–¹æ³•

- ç»å…¸ç ”ç©¶è®ºæ–‡ (OSDI, SOSP, ATC, EuroSys, ...)
- ä¹…ç»è€ƒéªŒçš„ç»å…¸æ•™å­¦ææ–™ (xv6, OSTEP, CSAPP, ...)
- æµ·é‡çš„å¼€æºå·¥å…· (GNU ç³»åˆ—, qemu, gdb, ...)
- ç¬¬ä¸‰æ–¹èµ„æ–™ï¼Œæ…ç”¨ (tutorials, osdev wiki, ...)

## äºŒã€ç¡¬ä»¶å’Œè½¯ä»¶çš„æ¡¥æ¢

### 1ã€C ç¨‹åº

æˆ‘ä»¬å·²ç»çŸ¥é“å¦‚ä½•å†™ä¸€ä¸ª â€œæœ€å°â€ çš„ C ç¨‹åºäº†ï¼š

- [minimal.S](http://jyywiki.cn/pages/OS/2022/demos/minimal.S)
- ä¸éœ€è¦é“¾æ¥ä»»ä½•åº“ï¼Œå°±èƒ½åœ¨æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œ

```assembly
#include <sys/syscall.h>

.globl _start
_start:
  movq $SYS_write, %rax   # write(
  movq $1,         %rdi   #   fd=1,
  movq $st,        %rsi   #   buf=st,
  movq $(ed - st), %rdx   #   count=ed-st
  syscall                 # );

  movq $SYS_exit,  %rax   # exit(
  movq $1,         %rdi   #   status=1
  syscall                 # );

st:
  .ascii "\033[01;31mHello, OS World\033[0m\n"
ed:

```

```bash
$ gcc -c minimal.S

$ ld minimal.o

$ file a.out
a.out: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, not stripped

$ objdump -d a.out | less

$ ./a.out
Hello, OS World

$ gdb a.out
(gdb) starti
```



------

â€œç¨‹åº = çŠ¶æ€æœºâ€ æ²¡é—®é¢˜

- å¸¦æ¥æ›´å¤šçš„ç–‘é—®
  - **ä½†è°åˆ›å»ºçš„è¿™ä¸ªçŠ¶æ€æœºï¼Ÿï¼Ÿï¼Ÿ**
    - å½“ç„¶æ˜¯æ“ä½œç³»ç»Ÿäº†â€¦â€¦å‘ƒâ€¦â€¦
  - **è¿™ä¸ªç¨‹åºå¯ä»¥åœ¨æ²¡æœ‰æ“ä½œç³»ç»Ÿçš„ç¡¬ä»¶ä¸Šè¿è¡Œå—ï¼Ÿ**
    - â€œå¯åŠ¨â€ çŠ¶æ€æœºæ˜¯ç”± â€œåŠ è½½å™¨â€ å®Œæˆçš„
    - åŠ è½½å™¨ä¹Ÿæ˜¯ä¸€æ®µç¨‹åº (çŠ¶æ€æœº)
    - è¿™ä¸ªç¨‹åºç”±æ˜¯ç”±è°åŠ è½½çš„ï¼Ÿ

### 2ã€Bare-metal ä¸ç¨‹åºå‘˜çš„çº¦å®š

ä¸ºäº†è®©è®¡ç®—æœºèƒ½**è¿è¡Œä»»ä½•æˆ‘ä»¬çš„ç¨‹åº**ï¼Œä¸€å®šå­˜åœ¨è½¯ä»¶/ç¡¬ä»¶çš„çº¦å®š

- CPU reset åï¼Œå¤„ç†å™¨å¤„äºæŸä¸ªç¡®å®šçš„çŠ¶æ€
  - PC æŒ‡é’ˆä¸€èˆ¬æŒ‡å‘ä¸€æ®µ memory-mapped ROM
    - ROM å­˜å‚¨äº†å‚å•†æä¾›çš„ firmware (å›ºä»¶)
  - å¤„ç†å™¨çš„å¤§éƒ¨åˆ†ç‰¹æ€§å¤„äºå…³é—­çŠ¶æ€
    - ç¼“å­˜ã€è™šæ‹Ÿå­˜å‚¨ã€â€¦â€¦
- Firmware (å›ºä»¶ï¼Œå‚å•†æä¾›çš„ä»£ç )
  - å°†ç”¨æˆ·æ•°æ®åŠ è½½åˆ°å†…å­˜
    - ä¾‹å¦‚å­˜å‚¨ä»‹è´¨ä¸Šçš„ç¬¬äºŒçº§ loader (åŠ è½½å™¨)
    - æˆ–è€…ç›´æ¥åŠ è½½æ“ä½œç³»ç»Ÿ (åµŒå…¥å¼ç³»ç»Ÿ)

### 3ã€x86 Family: CPU Reset è¡Œä¸º

CPU Reset ([IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual](https://software.intel.com/en-us/articles/intel-sdm), Volume 3A/3B)

- å¯„å­˜å™¨ä¼šæœ‰åˆå§‹çŠ¶æ€
  - `EIP = 0x0000fff0`
  - `CR0 = 0x60000010`
    - 16-bit æ¨¡å¼
  - `EFLAGS = 0x00000002`
    - interrupt disabled
- TFM (5,000 é¡µ by 2019)
  - æœ€éœ€è¦çš„ Volume 3A åªæœ‰ 468 é¡µ

![img](./doc/intel-cpu-reset.png)

### 4ã€CPU Reset ä¹‹åï¼šå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

ã€Šè®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€‹ï¼š**ä¸ä»…æ˜¯ç¨‹åºï¼Œæ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ªçŠ¶æ€æœº**

- ä» PC (`CS:IP`) æŒ‡é’ˆå¤„å–æŒ‡ä»¤ã€è¯‘ç ã€æ‰§è¡Œâ€¦â€¦
- ä» firmware å¼€å§‹æ‰§è¡Œ
  - `ffff0` é€šå¸¸æ˜¯ä¸€æ¡å‘ firmware è·³è½¬çš„ jmp æŒ‡ä»¤

Firmware: [BIOS vs. UEFI](https://www.zhihu.com/question/21672895)

- éƒ½æ˜¯ä¸»æ¿/ä¸»æ¿ä¸Šå¤–æ’è®¾å¤‡çš„è½¯ä»¶æŠ½è±¡
  - æ”¯æŒç³»ç»Ÿç®¡ç†ç¨‹åºè¿è¡Œ
- Legacy BIOS (Basic I/O System)
- UEFI (Unified Extensible Firmware Interface)

![img](./doc/bios-firmware.png)

### 5ã€Legacy BIOS: çº¦å®š

Firmware å¿…é¡»æä¾›æœºåˆ¶ï¼Œå°†ç”¨æˆ·æ•°æ®è½½å…¥å†…å­˜

- Legacy BIOS æŠŠç¬¬ä¸€ä¸ªå¯å¼•å¯¼è®¾å¤‡çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºåŠ è½½åˆ°ç‰©ç†å†…å­˜çš„`7c00`ä½ç½®
  - æ­¤æ—¶å¤„ç†å™¨å¤„äº 16-bit æ¨¡å¼
  - è§„å®š `CS:IP = 0x7c00,(R[CS] << 4) | R[IP] == 0x7c00`
    - å¯èƒ½æ€§1ï¼š`CS = 0x07c0, IP = 0`
    - å¯èƒ½æ€§2ï¼š`CS = 0, IP = 0x7c00`
  - å…¶ä»–æ²¡æœ‰ä»»ä½•çº¦æŸ

### 6ã€èƒ½ä¸èƒ½çœ‹ä¸€ä¸‹ä»£ç ï¼Ÿ

Talk is cheap. Show me the code. â€”â€”Linus Torvalds

æœ‰æ²¡æœ‰å¯èƒ½æˆ‘ä»¬çœŸçš„å»çœ‹ä» CPU Reset ä»¥åæ¯ä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œï¼Ÿ

------

**è®¡ç®—æœºç³»ç»Ÿå…¬ç†ï¼šä½ æƒ³åˆ°çš„å°±ä¸€å®šæœ‰äººåšåˆ°**ã€‚

- æ¨¡æ‹Ÿæ–¹æ¡ˆï¼šQEMU
  - ä¼ å¥‡é»‘å®¢ã€å¤©æ‰ç¨‹åºå‘˜ [Fabrice Bellard](https://www.zhihu.com/question/28388113) çš„æ°ä½œ
    - [QEMU, A fast and portable dynamic translator](https://www.usenix.org/legacy/publications/library/proceedings/usenix05/tech/freenix/full_papers/bellard/bellard.pdf) (USENIX ATC'05)
    - Android Virtual Device, VirtualBox, ... èƒŒåéƒ½æ˜¯ QEMU
- çœŸæœºæ–¹æ¡ˆï¼šJTAG (Joint Test Action Group) debugger
  - ä¸€ç³»åˆ— (ç‰©ç†) è°ƒè¯•å¯„å­˜å™¨ï¼Œå¯ä»¥å®ç° gdb æ¥å£ (!!!)

### 7ã€è°ƒè¯• QEMU: ç¡®è®¤ Firmware çš„è¡Œä¸º

äº²çœ¼ç¡®è®¤ Firmware åˆ°åº•æ˜¯ä¸æ˜¯ä¼šåŠ è½½å¯åŠ¨ç›˜ç¬¬ä¸€ä¸ªæ‰‡åŒºåˆ° `0x7c00` å†…å­˜ä½ç½®ï¼

è°ƒè¯• QEMU æ¨¡æ‹Ÿå™¨

- æŸ¥çœ‹ CPU Reset åçš„å¯„å­˜å™¨
  - `info registers`
- æŸ¥çœ‹ `0x7c00` å†…å­˜çš„åŠ è½½
  - `watch *0x7c00` - ã€Šè®¡ç®—æœºç³»ç»ŸåŸºç¡€ã€‹çš„è‰¯è‹¦ç”¨å¿ƒ
  - æŸ¥çœ‹å½“å‰æŒ‡ä»¤ `x/i ($cs * 16 + $rip)`
  - æ‰“å°å†…å­˜ `x/16xb 0x7c00`
- è¿›å…¥ `0x7c00` ä»£ç çš„æ‰§è¡Œ
  - `b *0x7c00, c` (æ’’èŠ±ï¼æˆ‘ä»¬ä¸€ä¼šå†å›æ¥)

### 8ã€é¸¡å’Œè›‹çš„é—®é¢˜è§£å†³

æœ‰ä¸ªåŸå§‹çš„é¸¡ï¼šFirmware

- ä»£ç ç›´æ¥å­˜åœ¨äºç¡¬ä»¶é‡Œ
- CPU Reset å Firmware ä¼šæ‰§è¡Œ
  - åŠ è½½ 512 å­—èŠ‚åˆ°å†…å­˜ (Legacy Boot)
  - ç„¶ååŠŸæˆèº«é€€

------

Firmware çš„å¦ä¸€ç”¨å¤„

- æ”¾ç½®ä¸€äº› â€œç»å¯¹å®‰å…¨çš„ä»£ç â€
  - [BIOS ä¸­æ–­](http://jyywiki.cn/pages/OS/manuals/BIOS-interrupts.pdf) (Hello World æ˜¯å¦‚ä½•è¢«æ‰“å°çš„)
  - ARM Trusted Firmware
    - Boot-Level 1, 2, 3.1, 3.2, 3.3
    - [U-Boot](https://www.denx.de/wiki/U-Boot): the universal boot loader

### 9ã€å°æ’æ›²ï¼šFirmware çš„ç—…æ¯’ (1998)

Firmware é€šå¸¸æ˜¯åªè¯»çš„ (å½“ç„¶â€¦â€¦)

- Intel 430TX (Pentium) èŠ¯ç‰‡ç»„å…è®¸**å†™å…¥ Flash ROM**
  - åªè¦å‘ Flash BIOS å†™å…¥ç‰¹å®šåºåˆ—ï¼ŒFlash ROM å°±å˜ä¸ºå¯å†™
    - ç•™ç»™ firmware æ›´æ–°çš„é€šé“
  - è¦å¾—åˆ°è¿™ä¸ªåºåˆ—å…¶å®å¹¶ä¸å›°éš¾
    - ä¼¼ä¹æ–‡æ¡£é‡Œå°±æœ‰ ğŸ¤” Boomâ€¦â€¦

------

CIH çš„ä½œè€…é™ˆç›ˆè±ªè¢«é€®æ•ï¼Œä½†å¹¶æœªè¢«å®šç½ª

![img](./doc/cih-virus.png)

### 10ã€ä»Šå¤©çš„ Firmware: UEFI

IBM PC æ‰€æœ‰è®¾å¤‡/BIOS ä¸­æ–­æ˜¯æœ‰ specification çš„ (æˆå°±äº† â€œå…¼å®¹æœºâ€)

- ä»Šå¤©çš„ boot loader é¢ä¸´éº»çƒ¦å¾—å¤šçš„ç¡¬ä»¶ï¼š
  - æŒ‡çº¹é”ã€ä¸çŸ¥åå‚å•†ç”Ÿäº§ç½‘å¡ä¸Šçš„ç½‘ç»œå¯åŠ¨ã€USB ä¸Šçš„è“ç‰™è½¬æ¥å™¨è¿æ¥çš„è“ç‰™é”®ç›˜ã€â€¦â€¦

![img](./doc/UEFI-booting-seq.png)

### 11ã€UEFI ä¸Šçš„æ“ä½œç³»ç»ŸåŠ è½½

æ ‡å‡†åŒ–çš„åŠ è½½æµç¨‹

- ç›˜å¿…é¡»æŒ‰ GPT (GUID Partition Table) æ–¹å¼æ ¼å¼åŒ–
- é¢„ç•™ä¸€ä¸ª FAT32 åˆ†åŒº (lsblk/fdisk å¯ä»¥çœ‹åˆ°)
- Firmware åŠ è½½ä»»æ„å¤§å°çš„ PE å¯æ‰§è¡Œæ–‡ä»¶ `.efi`
  - æ²¡æœ‰ legacy boot 512 å­—èŠ‚é™åˆ¶
  - EFI åº”ç”¨å¯ä»¥è¿”å› firmware

------

æ›´å¥½çš„ç¨‹åºæ”¯æŒ

- è®¾å¤‡é©±åŠ¨æ¡†æ¶
- æ›´å¤šçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ Secure Bootï¼Œåªèƒ½å¯åŠ¨ â€œä¿¡ä»»â€ çš„æ“ä½œç³»ç»Ÿ

## ä¸‰ã€æ“ä½œç³»ç»Ÿçš„çŠ¶æ€æœºæ¨¡å‹

ã€1:05:20ã€‘å¼€å§‹å¾€åçœ‹ï¼Œå¾ˆé‡è¦

### 1ã€â€œæ“ä½œç³»ç»Ÿâ€ çš„çŠ¶æ€æœºå·²ç»å¯åŠ¨

Firmware å’Œ boot loader å…±åŒå®Œæˆ â€œæ“ä½œç³»ç»Ÿçš„åŠ è½½â€

- åˆå§‹åŒ–å…¨å±€å˜é‡å’Œæ ˆï¼›åˆ†é…å †åŒº (`heap`)
- ä¸º `main` å‡½æ•°ä¼ é€’å‚æ•°
  - è°ç»™æ“ä½œç³»ç»Ÿä¼ é€’äº†å‚æ•°ï¼Ÿ
  - å¦‚ä½•å®ç°å‚æ•°ä¼ é€’ï¼Ÿ

------

è¿›å…¥ C ä»£ç ä¹‹å

- å®Œå…¨éµå¾ª C è¯­è¨€çš„å½¢å¼è¯­ä¹‰
- ä½†æœ‰ä¸€äº›è¡Œä¸º â€œè¡¥å……â€ â€”â€” AbstractMachine API

### 2ã€æ“ä½œç³»ç»Ÿï¼šæ˜¯ä¸ª C ç¨‹åº

ä¸€ä¸ªè¿·ä½  â€œæ“ä½œç³»ç»Ÿâ€ [thread-os.c](http://jyywiki.cn/pages/OS/2022/demos/thread-os.c)ï¼Œå¾ˆé‡è¦

- make ä¼šå¾—åˆ°ä¸€ä¸ª â€œç£ç›˜é•œåƒâ€ï¼Œå¥½åƒé­”æ³•ä¸€æ ·
  - å°±è·Ÿä½ ä»¬ç¬¬ä¸€æ¬¡ç”¨ IDE çš„æ—¶å€™æŒ‰ä¸€ä¸ªé”®å°±å¯ä»¥ç¼–è¯‘è¿è¡Œä¸€æ ·

------

```c
#include <am.h>
#include <klib.h>
#include <klib-macros.h>

#define MAX_CPU 8

typedef union task {
  struct {
    const char *name;
    union task *next;
    void      (*entry)(void *);
    Context    *context;
  };
  uint8_t stack[8192];
} Task;

Task *currents[MAX_CPU];
#define current currents[cpu_current()]

// user-defined tasks

int locked = 0;
void lock()   { while (atomic_xchg(&locked, 1)); }
void unlock() { atomic_xchg(&locked, 0); }

void func(void *arg) {
  while (1) {
    lock();
    printf("Thread-%s on CPU #%d\n", arg, cpu_current());
    unlock();
    for (int volatile i = 0; i < 100000; i++) ;
  }
}

Task tasks[] = {
  { .name = "A", .entry = func },
  { .name = "B", .entry = func },
  { .name = "C", .entry = func },
  { .name = "D", .entry = func },
  { .name = "E", .entry = func },
};

// ------------------

Context *on_interrupt(Event ev, Context *ctx) {
  extern Task tasks[];
  if (!current) current = &tasks[0];
  else          current->context = ctx;
  do {
    current = current->next;
  } while ((current - tasks) % cpu_count() != cpu_current());
  return current->context;
}

void mp_entry() {
  iset(true);
  yield();
}

int main() {
  cte_init(on_interrupt);

  for (int i = 0; i < LENGTH(tasks); i++) {
    Task *task    = &tasks[i];
    Area stack    = (Area) { &task->context + 1, task + 1 };
    task->context = kcontext(stack, task->entry, (void *)task->name);
    task->next    = &tasks[(i + 1) % LENGTH(tasks)];
  }
  mpe_init(mp_entry); // æŠŠå•çº¿ç¨‹çš„Cç¨‹åºç¼–ç¨‹å¤šç¨‹åºçš„Cç¨‹åº
}

```

### 3ã€AbstractMachine å¯¹ â€œC ç¨‹åºè¯­ä¹‰â€ åšå‡ºçš„æ‰©å……

TRM + MPE

- å®Œå…¨ç­‰åŒäºå¤šçº¿ç¨‹ (å¤„ç†å™¨ç›¸å½“äºçº¿ç¨‹) - L1/native
- IOE API: å®Œå…¨æ˜¯æ™®é€šçš„åº“å‡½æ•°
  - åŒä¸€è®¾å¤‡çš„æ•°æ®ç«äº‰ = undefined behavior

CTEï¼Œä¸­æ–­

- å…è®¸åˆ›å»ºå¤šä¸ªæ‰§è¡Œæµ (ç±»æ¯”åç¨‹) - M2
- yield ä¸»åŠ¨åˆ‡æ¢ï¼›ä¼šè¢«ä¸­æ–­è¢«åŠ¨æ‰“æ–­
- `on_interrupt` ä¼šæ‹¦æˆªåˆ°ä¸­æ–­äº‹ä»¶

VMEï¼Œè™šæ‹Ÿå†…å­˜

- å…è®¸åˆ›å»ºä¸€ä¸ª â€œç»è¿‡åœ°å€ç¿»è¯‘çš„æ‰§è¡Œæ¨¡å¼â€
- é€šè¿‡ CTE API ç®¡ç†

## å››ã€RTFSC æ—¶é—´

### 0ã€ç”Ÿæˆé•œåƒå’Œå¯åŠ¨è™šæ‹Ÿæœº

> å¦‚æœä½¿ç”¨ â€œåœŸåŠæ³•â€ï¼Œä½ å¾ˆå¯èƒ½è¢«æ·¹æ²¡åœ¨ Makefile ä¸­
>
> - è¯»æ‡‚ Makefile éœ€è¦ STFW, RTFMï¼Œå¤§é‡çš„ç²¾åŠ›
> - è™½ç„¶èŠ±ç‚¹æ—¶é—´è¯»æ˜¯å€¼å¾—çš„ï¼Œä½†å¾ˆå¯èƒ½è¯»äº†å¾ˆä¹…éƒ½æ²¡è¯»åˆ°é‡è¦çš„åœ°æ–¹

èŠ±ä¸€ç‚¹æ—¶é—´æƒ³ â€œåº”è¯¥æ€ä¹ˆåšâ€

- èŠ±å‡ åˆ†é’Ÿåˆ›å»ºä¸€ä¸ªå°å·¥å…·ï¼šâ€œAbstractMachine æ„å»ºç†è§£å·¥å…·â€
  - UNIX Philosophy: keep it simple, stupid
  - everything is a file; write things to work together using text interface
- *Get out of your comfort zone*



å¦‚æœæƒ³è¦çŸ¥é“æ“ä½œç³»ç»Ÿæ˜¯æ€æ ·è¿è¡Œçš„ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ

æ˜¯ä¸€è¡Œè¡Œçœ‹ä»£ç ï¼Œè¿˜æ˜¯ç”¨ gdb è°ƒå¼å®ƒï¼Œå½“ç„¶ç”¨ gdb è°ƒå¼å®ƒ

---

è§‚å¯Ÿ AbstractMachine ç¨‹åºç¼–è¯‘è¿‡ç¨‹çš„æ­£ç¡®æ–¹æ³•ï¼š

```bash
make -nB \
  | grep -ve '^\(\#\|echo\|mkdir\|make\)' \
  | sed "s#$AM_HOME#\$AM_HOME#g" \
  | sed "s#$PWD#.#g" \
  | vim -
```

- Command line tricks
  - `make -nB` (RTFM)
  - grep: æ–‡æœ¬è¿‡æ»¤ï¼Œçœç•¥äº†ä¸€äº›å¹²æ‰°é¡¹
    - echo (æç¤ºä¿¡æ¯), mkdir (ç›®å½•å»ºç«‹), make (sub-goals)
  - sed: è®©è¾“å‡ºæ›´æ˜“è¯»
    - å°†ç»å¯¹è·¯å¾„æ›¿æ¢æˆç›¸å¯¹è·¯å¾„
  - vim: æ›´èˆ’é€‚çš„ç¼–è¾‘/æŸ¥çœ‹ä½“éªŒ

---

æƒ³è¦çœ‹å¾—æ›´æ¸…æ¥šä¸€äº›ï¼Ÿ

- `:%s/ /\r /g`
  - æ¯ä¸€ä¸ªå‘½ä»¤å°±åƒ â€œä¸€å¥è¯â€

ç¼–è¯‘

- `-std=gnu11`, `m64`, `-mno-sse`, `-I`, `-D`, ... (è¿™å¯¹ä½ é…ç½® vscode å¾ˆé‡è¦)

é“¾æ¥

- `-melf_x86_64`, `-N`, `-Ttext-segment=0x00100000`
- é“¾æ¥äº†éœ€è¦çš„åº“ (`am-x86_64-qemu.a`, `klib-x86_64-qemu.a`)

å½©è›‹

- `make html`

### 1ã€å¯åŠ¨åŠ è½½å™¨ (Boot Loader)

512 å­—èŠ‚ä¸­çš„ä»£ç ï¼Œå‡è®¾äº†é•œåƒæ ¼å¼ (çœŸæ­£çš„çš„åŠ è½½å™¨æœ‰å¾ˆå¤š stages)

- 16-bit â†’ 32-bit
- ELF32/64 çš„åŠ è½½å™¨
  - æŒ‰ç…§çº¦å®šçš„ç£ç›˜é•œåƒæ ¼å¼åŠ è½½

------

ä»£ç è®²è§£ï¼š

- `am/src/x86/qemu/boot/start.S` å’Œ `main.c`
  - å®ƒä»¬éƒ½å¯ä»¥è°ƒè¯•ï¼

```c
if (elf32->e_machine == EM_X86_64) {
  ((void(*)())(uint32_t)elf64->e_entry)();
} else {
  ((void(*)())(uint32_t)elf32->e_entry)();
}
```

## æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ç¨‹åºï¼Œå®ƒå¦‚ä½•ç”¨çŠ¶æ€æœºå¦‚ä½•å®šä¹‰ï¼Ÿ

------

Take-away message

- ä¸€åˆ‡çš†å¯è°ƒè¯• (åŒ…æ‹¬ firmware)
  - ç†è§£æ“ä½œç³»ç»Ÿæ˜¯å¦‚ä½•è¢«å¯åŠ¨çš„
  - å­¦ä¼šä½¿ç”¨ gdb (å¿…å¤‡ç”Ÿå­˜æŠ€èƒ½)
- æ“ä½œç³»ç»Ÿä¹Ÿæ˜¯ç¨‹åº
  - AbstractMachine æ‰©å±•äº†ç¨‹åºçš„è¯­ä¹‰ï¼Œä»…æ­¤è€Œå·²

