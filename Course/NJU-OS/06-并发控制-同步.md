# å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥

## Overview

å¤ä¹ 

- äº’æ–¥ï¼šè‡ªæ—‹é”ã€äº’æ–¥é”ã€futex
- ~~æ˜¯æ—¶å€™é¢å¯¹çœŸæ­£çš„å¹¶å‘ç¼–ç¨‹äº†~~

------

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸ŠååŒå¤šä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Ÿ

------

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- å…¸å‹çš„åŒæ­¥é—®é¢˜ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼›å“²å­¦å®¶åƒé¥­ï¼ˆ99%çš„é—®é¢˜ï¼‰
- åŒæ­¥çš„å®ç°æ–¹æ³•ï¼šä¿¡å·é‡ã€æ¡ä»¶å˜é‡

## æ”¶è·

### 1ã€åŒæ­¥

ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šéšæ—¶é—´å˜åŒ–çš„é‡åœ¨å˜åŒ–è¿‡ç¨‹ä¸­ä¿æŒä¸€å®šçš„ç›¸å¯¹å…³ç³»

åŒæ­¥å°±æ˜¯ä¸¤ä¸ªäººçº¦å®šå¥½ï¼Œå…ˆåˆ°çš„äººç­‰ï¼Œç­‰å¦ä¸€ä¸ªäººä¹Ÿç»“æŸï¼Œå°±åœ¨é‚£ä¸ªæ—¶åˆ»ï¼Œè¾¾åˆ°ç›¸äº’çŸ¥é“çš„çŠ¶æ€

### 2ã€å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸ŠååŒå¤šä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Ÿ

ä½¿ç”¨ä¸‡èƒ½çš„æ¡ä»¶å˜é‡ï¼Œå¯ä»¥è§£å†³ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼ŒæŠŠä¸€ä¸ªå¤§ä»»åŠ¡é€šè¿‡è®¡ç®—å›¾çš„æ–¹å¼æ‹†æˆå°ä»»åŠ¡ï¼Œå°±å¯ä»¥å¹¶è¡Œä»»ä½•ç®—æ³•

**å®ç°åŒæ­¥çš„æ–¹æ³•**

- æ¡ä»¶å˜é‡ã€ä¿¡å·é‡ï¼›ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜
- Job queue å¯ä»¥å®ç°å‡ ä¹ä»»ä½•å¹¶è¡Œç®—æ³•

ä¸è¦ â€œè‡ªä½œèªæ˜â€ è®¾è®¡ç®—æ³•ï¼Œå°å¿ƒæ±‚è¯

### 3ã€å…¸å‹çš„åŒæ­¥é—®é¢˜ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼›å“²å­¦å®¶åƒé¥­ï¼ˆ99%çš„é—®é¢˜ï¼‰

å“²å­¦å®¶ (çº¿ç¨‹) æœ‰æ—¶æ€è€ƒï¼Œæœ‰æ—¶åƒé¥­

- åƒé¥­éœ€è¦åŒæ—¶å¾—åˆ°å·¦æ‰‹å’Œå³æ‰‹çš„å‰å­
- å½“å‰å­è¢«å…¶ä»–äººå æœ‰æ—¶ï¼Œå¿…é¡»ç­‰å¾…ï¼Œå¦‚ä½•å®ŒæˆåŒæ­¥ï¼Ÿ

ä¸‡èƒ½çš„æ–¹æ³•ï¼Œæ¡ä»¶å˜é‡

```c
mutex_lock(&mutex);                    // å…ˆä¸Šä¸€æŠŠäº’æ–¥é”ï¼Œä½ ä»¬éƒ½åˆ«åŠ¨
while (!(avail[lhs] && avail[rhs])) {  // å·¦å³æ‰‹è¾¹çš„å‰å­éƒ½åœ¨çš„è¯é€€å‡ºå¾ªç¯
    wait(&cv, &mutex);                 // æœ‰ä¸åœ¨çš„è¯ï¼Œç­‰å¾…ï¼ŒæŠŠé”é‡Šæ”¾æ‰
}
avail[lhs] = avail[rhs] = false;  // åœ¨é”çš„ä¿æŠ¤ä¸‹ï¼ŒæŠŠä¸¤ä¸ªå‰å­éƒ½æ‹¿èµ·æ¥
mutex_unlock(&mutex);             // å°±å¯ä»¥æŠŠé”é‡Šæ”¾æ‰ï¼Œå°±å¯ä»¥å¼€å§‹åƒé¥­äº†

mutex_lock(&mutex);              // èŠ±äº†è¶³å¤Ÿé•¿çš„æ—¶é—´åƒå®Œé¥­åï¼ŒæŠŠé”å†ä¸Šä¸Š
avail[lhs] = avail[rhs] = true;  // æŠŠå‰å­è¿˜å›å»
broadcast(&cv);                  // æŠŠå…¶ä»–å¯èƒ½è¿˜åœ¨ç­‰å‰å­çš„äººå”¤é†’
mutex_unlock(&mutex);            // é”é‡Šæ”¾æ‰
```

### 4ã€åŒæ­¥çš„å®ç°æ–¹æ³•ï¼šæ¡ä»¶å˜é‡

å¬è¯¾ï¼Œä¸€çŸ¥åŠè§£

ç®—æ³•æ ¸å¿ƒï¼šéœ€è¦**ç­‰å¾…æ¡ä»¶æ»¡è¶³æ—¶**ï¼Œå†å¾€ä¸‹æ‰§è¡Œï¼Œè´Ÿè´£å°±ç­‰å¾…ï¼ˆè€Œä¸”æŠŠé”é‡Šæ”¾æ‰ï¼‰

### 5ã€åŒæ­¥çš„å®ç°æ–¹æ³•ï¼šä¿¡å·é‡

å¬äº†ï¼Œä½†ä¹Ÿæ²¡å¬

ä¿¡å·é‡è®¾è®¡çš„é‡ç‚¹ï¼Œè€ƒè™‘ â€œæ‰‹ç¯â€ (æ¯ä¸€å•ä½çš„ â€œ**èµ„æº**â€) æ˜¯ä»€ä¹ˆï¼Œè°åˆ›é€ ï¼Ÿè°è·å–ï¼Ÿ

### 6ã€å¿˜äº†ä¿¡å·é‡ï¼Œè®©ä¸€ä¸ªäººé›†ä¸­ç®¡ç†å‰å­å§ï¼

â€œLeader/followerâ€ - ç”Ÿäº§è€…/æ¶ˆè´¹è€…

- åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éå¸¸å¸¸è§çš„è§£å†³æ€è·¯ (HDFS, ...)

è‡ªä¸»çš„åŒæ­¥ç®—æ³•ï¼Œåˆ†å¸ƒå¼çš„åŒæ­¥ï¼Œæ¯ä¸ªäººéƒ½è¦è¯•ä¸€è¯•ï¼Œå¤§å®¶éµå®ˆåŒä¸€ä¸ªåè®®ï¼Œéš¾

é›†ä¸­å¼çš„ç®—æ³•ï¼ˆmaster-slaveï¼‰ï¼Œè¿œæ¯”åˆ†å¸ƒå¼çš„ç®—æ³•å®¹æ˜“ç†è§£ï¼Œå®¹æ˜“å¼„å¯¹ï¼Œæ›´çµæ´»çš„è°ƒåº¦ï¼Œæœ‰ä¼˜å…ˆçº§

## ä¸€ã€çº¿ç¨‹åŒæ­¥

### 1ã€åŒæ­¥ (Synchronization)

ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šéšæ—¶é—´å˜åŒ–çš„é‡åœ¨å˜åŒ–è¿‡ç¨‹ä¸­ä¿æŒä¸€å®šçš„ç›¸å¯¹å…³ç³»

- iPhone/iCloud åŒæ­¥ (æ‰‹æœº vs ç”µè„‘ vs äº‘ç«¯)
- å˜é€Ÿç®±åŒæ­¥å™¨ (åˆå¹¶å¿«æ…¢é€Ÿé½¿è½®)
- åŒæ­¥ç”µæœº (è½¬å­ä¸ç£åœºé€Ÿåº¦ä¸€è‡´)
- åŒæ­¥ç”µè·¯ (æ‰€æœ‰è§¦å‘å™¨åœ¨è¾¹æ²¿åŒæ—¶è§¦å‘)

------

å¼‚æ­¥ (Asynchronous) = ä¸åŒæ­¥

- ä¸Šè¿°å¾ˆå¤šä¾‹å­éƒ½æœ‰å¼‚æ­¥ç‰ˆæœ¬ (å¼‚æ­¥ç”µæœºã€å¼‚æ­¥ç”µè·¯ã€å¼‚æ­¥çº¿ç¨‹)

### 2ã€å¹¶å‘ç¨‹åºä¸­çš„åŒæ­¥

å¹¶å‘ç¨‹åºçš„æ­¥è°ƒå¾ˆéš¾ä¿æŒ â€œå®Œå…¨ä¸€è‡´â€

- çº¿ç¨‹åŒæ­¥ï¼š**åœ¨æŸä¸ªæ—¶é—´ç‚¹å…±åŒè¾¾åˆ°äº’ç›¸å·²çŸ¥çš„çŠ¶æ€**

å†æ¬¡æŠŠçº¿ç¨‹æƒ³è±¡æˆæˆ‘ä»¬è‡ªå·±

- NPYï¼šç­‰æˆ‘æ´—ä¸ªå¤´å°±å‡ºé—¨/ç­‰æˆ‘æ‰“å®Œè¿™å±€æ¸¸æˆå°±æ¥
- èˆå‹ï¼šç­‰æˆ‘ä¿®å¥½è¿™ä¸ª bug å°±åƒé¥­
- å¯¼å¸ˆï¼šç­‰æˆ‘å‡ºå·®å›æ¥å°±è®¨è®ºè¿™ä¸ªè¯¾é¢˜
- jyyï¼š~~ç­‰æˆ‘æˆä¸ºå·ç‹å°±èººå¹³~~
    - â€œå…ˆåˆ°å…ˆç­‰â€

åŒæ­¥å°±æ˜¯ä¸¤ä¸ªäººçº¦å®šå¥½ï¼Œå…ˆåˆ°çš„äººç­‰ï¼Œç­‰å¦ä¸€ä¸ªäººä¹Ÿç»“æŸï¼Œå°±åœ¨é‚£ä¸ªæ—¶åˆ»ï¼Œè¾¾åˆ°ç›¸äº’çŸ¥é“çš„çŠ¶æ€

### 3ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šå­¦åºŸä½ å°±èµ¢äº†

**99% çš„å®é™…å¹¶å‘é—®é¢˜éƒ½å¯ä»¥ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³**ã€‚

```c
void Tproduce() { while (1) printf("("); }
void Tconsume() { while (1) printf(")"); }
```

åœ¨ `printf` å‰åå¢åŠ ä»£ç ï¼Œä½¿å¾—æ‰“å°çš„æ‹¬å·åºåˆ—æ»¡è¶³

- ä¸€å®šæ˜¯æŸä¸ªåˆæ³•æ‹¬å·åºåˆ—çš„å‰ç¼€
- æ‹¬å·åµŒå¥—çš„æ·±åº¦ä¸è¶…è¿‡n
    - n=3, `((())())(((...` åˆæ³•
    - n=3, `(((())))`, `(()))` ä¸åˆæ³•
- åŒæ­¥
    - ç­‰åˆ°æœ‰ç©ºä½å†æ‰“å°å·¦æ‹¬å·
    - ç­‰åˆ°èƒ½é…å¯¹æ—¶å†æ‰“å°å³æ‹¬å·

### 4ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼šåˆ†æ

ä¸ºä»€ä¹ˆå« â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€ è€Œä¸æ˜¯ â€œæ‹¬å·é—®é¢˜â€ï¼Ÿ

- å·¦æ‹¬å·ï¼šç”Ÿäº§èµ„æº (ä»»åŠ¡)ã€æ”¾å…¥ã€Œé˜Ÿåˆ—ã€
- å³æ‹¬å·ï¼šä»ã€Œé˜Ÿåˆ—ã€å–å‡ºèµ„æº (ä»»åŠ¡) æ‰§è¡Œ

------

èƒ½å¦ç”¨äº’æ–¥é”å®ç°æ‹¬å·é—®é¢˜ï¼Ÿ

- å·¦æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—) ä¸è¶³ n æ—¶æ‰èƒ½æ‰“å°
- å³æ‹¬å·ï¼šåµŒå¥—æ·±åº¦ (é˜Ÿåˆ—) >1 æ—¶æ‰èƒ½æ‰“å°
    - **å½“ç„¶æ˜¯ç­‰åˆ°æ»¡è¶³æ¡ä»¶æ—¶å†æ‰“å°äº†**ï¼š[pc.c](http://jyywiki.cn/pages/OS/2022/demos/pc.c)
        - **ç”¨äº’æ–¥é”ä¿æŒæ¡ä»¶æˆç«‹**
    - å‹åŠ›æµ‹è¯•çš„æ£€æŸ¥å½“ç„¶ä¸èƒ½å°‘ï¼š[pc-check.py](http://jyywiki.cn/pages/OS/2022/demos/pc-check.py)
    - Model checker å½“ç„¶ä¹Ÿä¸èƒ½å°‘ (ç•™ä½œä¹ é¢˜)

---

pc.c

```c
#include "thread.h"
#include "thread-sync.h"

int n, count = 0;
mutex_t lk = MUTEX_INIT();

void Tproduce() {
  while (1) {
retry:
    mutex_lock(&lk);
    if (count == n) { // åŒ…å·²ç»æ»¡äº†
      mutex_unlock(&lk);
      goto retry;
    }
    count++;
    printf("(");
    mutex_unlock(&lk);
  }
}

void Tconsume() {
  while (1) {
retry:
    mutex_lock(&lk);
    if (count == 0) { // åŒ…æ˜¯ç©ºçš„
      mutex_unlock(&lk);
      goto retry;
    }
    count--;
    printf(")");
    mutex_unlock(&lk);
  }
}

int main(int argc, char *argv[]) {
  assert(argc == 2);
  n = atoi(argv[1]);
  setbuf(stdout, NULL);
  for (int i = 0; i < 8; i++) {
    create(Tproduce);
    create(Tconsume);
  }
}

```

pc-check.py

```python
import sys

limit = int(sys.argv[1])
count, n = 0, 100000
while True:
    for ch in sys.stdin.read(n):
        if ch == '(': count += 1
        if ch == ')': count -= 1
        assert 0 <= count <= limit
    print(f'{n} Ok.')

```

åšæµ‹è¯•ï¼š

```bash
$ gcc pc.c -O2 -lpthread
$ ./a.out 1 | python3 pc-check.py 1
100000 Ok.
100000 Ok.
100000 Ok.
100000 Ok.
```

ä½†æ˜¯æœ‰å¯èƒ½å‡ åˆ†é’Ÿåæ‰å‡ºç°é”™è¯¯ï¼Œä¸è¿‡å°±å¾ˆéš¾è°ƒäº†

## äºŒã€æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½åŒæ­¥æ–¹æ³•

### 1ã€åŒæ­¥é—®é¢˜ï¼šåˆ†æ

ä»»ä½•åŒæ­¥é—®é¢˜éƒ½æœ‰**å…ˆæ¥å…ˆç­‰å¾…çš„æ¡ä»¶**ã€‚

çº¿ç¨‹ join ([thread.h](http://jyywiki.cn/pages/OS/2022/demos/thread.h), [sum.c](http://jyywiki.cn/pages/OS/2022/demos/sum.c))

- ç­‰æ‰€æœ‰çº¿ç¨‹ç»“æŸåç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™ç­‰å¾…

------

NPY çš„ä¾‹å­

- æ‰“å®Œæ¸¸æˆä¸”æ´—å®Œå¤´åç»§ç»­æ‰§è¡Œ `date()`ï¼Œå¦åˆ™ç­‰å¾…

------

ç”Ÿäº§è€…/æ¶ˆè´¹è€…é—®é¢˜

- å·¦æ‹¬å·ï¼šæ·±åº¦ k<n æ—¶ `printf`ï¼Œå¦åˆ™ç­‰å¾…
- å³æ‹¬å·ï¼šk>0æ—¶`printf`ï¼Œå¦åˆ™ç­‰å¾…
    - å†çœ‹ä¸€çœ¼ [pc.c](http://jyywiki.cn/pages/OS/2022/demos/pc.c)

### 2ã€Conditional Variables (æ¡ä»¶å˜é‡, CV)

æŠŠ [pc.c](http://jyywiki.cn/pages/OS/2022/demos/pc.c) ä¸­çš„è‡ªæ—‹å˜æˆç¡çœ 

- åœ¨å®Œæˆæ“ä½œæ—¶å”¤é†’

------

æ¡ä»¶å˜é‡ API

- wait(cv, mutex) ğŸ’¤
    - è°ƒç”¨æ—¶å¿…é¡»ä¿è¯å·²ç»è·å¾— mutex
    - é‡Šæ”¾ mutexã€è¿›å…¥ç¡çœ çŠ¶æ€
- signal/notify(cv) ğŸ’¬ ç§ä¿¡ï¼šèµ°èµ·
    - å¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾… cvï¼Œåˆ™å”¤é†’å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹
- broadcast/notifyAll(cv) ğŸ“£ æ‰€æœ‰äººï¼šèµ°èµ·
    - å”¤é†’å…¨éƒ¨æ­£åœ¨ç­‰å¾… cv çš„çº¿ç¨‹

### 3ã€æ¡ä»¶å˜é‡ï¼šå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…

```c
void Tproduce() {
  mutex_lock(&lk);
  if (count == n) cond_wait(&cv, &lk);
  printf("("); count++; cond_signal(&cv);
  mutex_unlock(&lk);
}

void Tconsume() {
  mutex_lock(&lk);
  if (count == 0) cond_wait(&cv, &lk);
  printf(")"); count--; cond_signal(&cv);
  mutex_unlock(&lk);
}
```

å‹åŠ›æµ‹è¯•ï¼š[pc-cv.c](http://jyywiki.cn/pages/OS/2022/demos/pc-cv.c)ï¼›æ¨¡å‹æ£€éªŒï¼š[pc-cv.py](http://jyywiki.cn/pages/OS/2022/demos/pc-cv.py)

- (Small scope hypothesis)

---

pc-cv.c

```c
#include "thread.h"
#include "thread-sync.h"

int n, count = 0;
mutex_t lk = MUTEX_INIT();
cond_t cv = COND_INIT();

void Tproduce() {
  while (1) {
    mutex_lock(&lk);
    if (count == n) {
      cond_wait(&cv, &lk);
    }
    printf("("); count++;
    cond_signal(&cv);
    mutex_unlock(&lk);
  }
}

void Tconsume() {
  while (1) {
    mutex_lock(&lk);
    if (count == 0) {
      pthread_cond_wait(&cv, &lk);
    }
    printf(")"); count--;
    cond_signal(&cv);
    mutex_unlock(&lk);
  }
}

int main(int argc, char *argv[]) {
  assert(argc == 2);
  n = atoi(argv[1]);
  setbuf(stdout, NULL);
  for (int i = 0; i < 8; i++) {
    create(Tproduce);
    create(Tconsume);
  }
}

```

```bash
gcc pc-cv.c -lpthread && ./a.out 1 | head -c 512
# è¾“å‡ºæ˜¾ç¤ºä¸Šé¢çš„ pc-cv.c ç®—æ³•æ˜¯æœ‰é—®é¢˜çš„
# åœ¨æœ‰ä¸€ä¸ªç”Ÿäº§è€…ã€æ¶ˆè´¹è€…çš„æ—¶å€™æ²¡é—®é¢˜ï¼Œå¤šä¸ªçš„æ—¶å€™å‡ºç°é—®é¢˜
```

pc-cv.py

```python
class ProducerConsumer:
    locked, count, log, waits = '', 0, '', ''

    def tryacquire(self):
        self.locked, seen = 'ğŸ”’', self.locked
        return seen == ''

    def release(self):
        self.locked = ''

    @thread
    def tp(self):
        for _ in range(2):
            while not self.tryacquire(): pass # mutex_lock()

            if self.count == 1:
                # cond_wait
                _, self.waits = self.release(), self.waits + '1'
                while '1' in self.waits: pass
                while not self.tryacquire(): pass

            self.log, self.count = self.log + '(', self.count + 1
            self.waits = self.waits[1:] # cond_signal
            self.release() # mutex_unlock()

    @thread
    def tc1(self):
        while not self.tryacquire(): pass

        if self.count == 0:
            _, self.waits = self.release(), self.waits + '2'
            while '2' in self.waits: pass
            while not self.tryacquire(): pass

        self.log, self.count = self.log + ')', self.count - 1

        self.waits = self.waits[1:]
        self.release()

    @thread
    def tc2(self):
        while not self.tryacquire(): pass

        if self.count == 0:
            _, self.waits = self.release(), self.waits + '3'
            while '3' in self.waits: pass
            while not self.tryacquire(): pass

        self.log, self.count = self.log + ')', self.count - 1

        self.waits = self.waits[1:]
        self.release()

    @marker
    def mark_negative(self, state):
        count = 0
        for ch in self.log:
            if ch == '(': count += 1
            if ch == ')': count -= 1
            if count < 0: return 'red'

```

model checker æµ‹è¯•

```bash
$ python3 model-checker.py pc-cv.py > a.txt
```

### 4ã€æ¡ä»¶å˜é‡ï¼šæ­£ç¡®çš„æ‰“å¼€æ–¹å¼

éœ€è¦**ç­‰å¾…æ¡ä»¶æ»¡è¶³æ—¶**

```c
mutex_lock(&mutex);
while (!cond) {
  wait(&cv, &mutex);
}
assert(cond);
// ...
// äº’æ–¥é”ä¿è¯äº†åœ¨æ­¤æœŸé—´æ¡ä»¶ cond æ€»æ˜¯æˆç«‹
// ...
mutex_unlock(&mutex);
```

**å…¶ä»–çº¿ç¨‹æ¡ä»¶å¯èƒ½è¢«æ»¡è¶³æ—¶**

```c
broadcast(&cv);
```

- ä¿®æ”¹ [pc-cv.c](http://jyywiki.cn/pages/OS/2022/demos/pc-cv.c) å’Œ [pc-cv.py](http://jyywiki.cn/pages/OS/2022/demos/pc-cv.py)

### 5ã€æ¡ä»¶å˜é‡ï¼šå®ç°å¹¶è¡Œè®¡ç®—

```c
struct job {
  void (*run)(void *arg);
  void *arg;
}

while (1) {
  struct job *job;

  mutex_lock(&mutex);
  while (! (job = get_job()) ) {
    wait(&cv, &mutex);
  }
  mutex_unlock(&mutex);

  job->run(job->arg); // ä¸éœ€è¦æŒæœ‰é”
                      // å¯ä»¥ç”Ÿæˆæ–°çš„ job
                      // æ³¨æ„å›æ”¶åˆ†é…çš„èµ„æº
}
```

### 6ã€æ¡ä»¶å˜é‡ï¼šæ›´å¤æ€ªçš„ä¹ é¢˜/é¢è¯•é¢˜

æœ‰ä¸‰ç§çº¿ç¨‹ï¼Œåˆ†åˆ«æ‰“å° `<`, `>`, å’Œ `_`

- å¯¹è¿™äº›çº¿ç¨‹è¿›è¡ŒåŒæ­¥ï¼Œä½¿å¾—æ‰“å°å‡ºçš„åºåˆ—æ€»æ˜¯ `<><_` å’Œ `><>_` ç»„åˆ

------

ä½¿ç”¨æ¡ä»¶å˜é‡ï¼Œåªè¦å›ç­”ä¸‰ä¸ªé—®é¢˜ï¼š

- æ‰“å° â€œ`<`â€ çš„æ¡ä»¶ï¼Ÿ
- æ‰“å° â€œ`>`â€ çš„æ¡ä»¶ï¼Ÿ
- æ‰“å° â€œ_â€ çš„æ¡ä»¶ï¼Ÿ
    - [fish.c](http://jyywiki.cn/pages/OS/2022/demos/fish.c)

## ä¸‰ã€ä¿¡å·é‡

### 1ã€å¤ä¹ ï¼šäº’æ–¥é”å’Œæ›´è¡£å®¤ç®¡ç†

æ“ä½œç³»ç»Ÿ = æ›´è¡£å®¤ç®¡ç†å‘˜

- å…ˆåˆ°çš„äºº (çº¿ç¨‹)
    - æˆåŠŸè·å¾—æ‰‹ç¯ï¼Œè¿›å…¥æ¸¸æ³³é¦† 
    - `*lk = ğŸ”’`ï¼Œç³»ç»Ÿè°ƒç”¨ç›´æ¥è¿”å›
- ååˆ°çš„äºº (çº¿ç¨‹)
    - ä¸èƒ½è¿›å…¥æ¸¸æ³³é¦†ï¼Œæ’é˜Ÿç­‰å¾…
    - çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæ‰§è¡Œçº¿ç¨‹åˆ‡æ¢ (yield)
- æ´—å®Œæ¾¡å‡ºæ¥çš„äºº (çº¿ç¨‹)
    - äº¤è¿˜æ‰‹ç¯ç»™ç®¡ç†å‘˜ï¼›ç®¡ç†å‘˜æŠŠæ‰‹ç¯å†äº¤ç»™æ’é˜Ÿçš„äºº
    - å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ
    - å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œ`*lk = âœ…`
- **ç®¡ç†å‘˜ (OS) ä½¿ç”¨è‡ªæ—‹é”ç¡®ä¿è‡ªå·±å¤„ç†æ‰‹ç¯çš„è¿‡ç¨‹æ˜¯åŸå­çš„**

### 2ã€æ›´è¡£å®¤ç®¡ç†

å®Œå…¨æ²¡æœ‰å¿…è¦é™åˆ¶æ‰‹ç¯çš„æ•°é‡â€”â€”è®©æ›´å¤šåŒå­¦å¯ä»¥è¿›å…¥æ›´è¡£å®¤

- ç®¡ç†å‘˜å¯ä»¥æŒæœ‰ä»»æ„æ•°é‡çš„æ‰‹ç¯ (æ›´è¡£å®¤å®¹é‡ä¸Šé™)
    - å…ˆè¿›å…¥æ›´è¡£å®¤çš„åŒå­¦å…ˆå¾—åˆ°
    - æ‰‹ç¯ç”¨å®Œåæ‰éœ€è¦ç­‰åŒå­¦å‡ºæ¥

### 3ã€æ›´è¡£å®¤ç®¡ç† (by E.W. Dijkstra)

åšä¸€ç‚¹æ‰©å±•â€”â€”çº¿ç¨‹å¯ä»¥ä»»æ„ â€œå˜å‡ºâ€ ä¸€ä¸ªæ‰‹ç¯

- æŠŠæ‰‹ç¯çœ‹æˆæ˜¯ä»¤ç‰Œ
- å¾—åˆ°ä»¤ç‰Œçš„å¯ä»¥è¿›å…¥æ‰§è¡Œ
- å¯ä»¥éšæ—¶åˆ›å»ºä»¤ç‰Œ

------

â€œæ‰‹ç¯â€ = â€œä»¤ç‰Œâ€ = â€œä¸€ä¸ªèµ„æºâ€ = â€œä¿¡å·é‡â€ (semaphore)

- P(&sem) - prolaag = try + decrease; wait; down; in
    - ç­‰å¾…ä¸€ä¸ªæ‰‹ç¯åè¿”å›
    - å¦‚æœæ­¤æ—¶ç®¡ç†å‘˜æ‰‹ä¸Šæœ‰ç©ºé—²çš„æ‰‹ç¯ï¼Œç«‹å³è¿”å›
- V(&sem) - verhoog = increase; post; up; out
    - å˜å‡ºä¸€ä¸ªæ‰‹ç¯ï¼Œé€ç»™ç®¡ç†å‘˜
- ä¿¡å·é‡çš„è¡Œä¸ºå»ºæ¨¡: [sem.py](http://jyywiki.cn/pages/OS/2022/demos/sem.py)

```python
class Semaphore:
    token, waits = 1, ''

    # æ‹“å±•äº†äº’æ–¥é”ï¼ˆåªæœ‰ä¸€ä¸ªé’¥åŒ™ï¼‰ï¼Œè¿™é‡Œ token æ˜¯ä¸ªè®¡æ•°å™¨
    # P è¯•å›¾å»è·å–ä¸€æŠŠé’¥åŒ™ï¼Œå‰©ä¸‹çš„é’¥åŒ™ï¼ˆtokenï¼‰å¤§äº0ï¼Œå°±å¯ä»¥å‡ä¸€ï¼Œ
    # å¦åˆ™æ”¾å…¥ç­‰å¾…çš„é˜Ÿåˆ—é‡Œï¼Œç­‰å¾…åˆ«äººå”¤é†’è‡ªå·±
    def P(self, tid):
        if self.token > 0:
            self.token -= 1
            return True
        else:
            self.waits = self.waits + tid
            return False
	
    # V å˜å‡ºä¸€æŠŠé’¥åŒ™ï¼Œå¦‚æœæœ‰äººåœ¨ç­‰è¿™ä¸ªé’¥åŒ™ï¼Œä¼šå”¤é†’ä¸€ä¸ªæ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹
    # å¦‚æœæ²¡æœ‰äººåœ¨ç­‰çš„è¯ï¼ŒæŠŠé’¥åŒ™äº¤ç»™ç®¡ç†å‘˜
    def V(self):
        if self.waits:
            self.waits = self.waits[1:]
        else:
            self.token += 1

    @thread
    def t1(self):
        self.P('1')
        while '1' in self.waits: pass
        cs = True
        del cs
        self.V()

    @thread
    def t2(self):
        self.P('2')
        while '2' in self.waits: pass
        cs = True
        del cs
        self.V()

    @marker
    def mark_t1(self, state):
        if localvar(state, 't1', 'cs'): return 'blue'

    @marker
    def mark_t2(self, state):
        if localvar(state, 't2', 'cs'): return 'green'

    @marker
    def mark_both(self, state):
        if localvar(state, 't1', 'cs') and localvar(state, 't2', 'cs'):
            return 'red'

```

### 4ã€ä¿¡å·é‡ï¼šå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…

ä¿¡å·é‡è®¾è®¡çš„é‡ç‚¹

- è€ƒè™‘ â€œæ‰‹ç¯â€ (æ¯ä¸€å•ä½çš„ â€œ**èµ„æº**â€) æ˜¯ä»€ä¹ˆï¼Œè°åˆ›é€ ï¼Ÿè°è·å–ï¼Ÿ
    - [`pc-sem.c`](http://jyywiki.cn/pages/OS/2022/demos/pc-sem.c)

```c
void producer() {
  P(&empty);   // P()è¿”å› -> å¾—åˆ°æ‰‹ç¯
  printf("("); // å‡è®¾çº¿ç¨‹å®‰å…¨
  V(&fill);
}
void consumer() {
  P(&fill);
  printf(")");
  V(&empty);
}
```

- åœ¨ â€œä¸€å•ä½èµ„æºâ€ æ˜ç¡®çš„é—®é¢˜ä¸Šæ›´å¥½ç”¨

```c
#include "thread.h"
#include "thread-sync.h"

sem_t fill, empty;

void producer() {
  while (1) {
    P(&empty);
    printf("(");
    V(&fill);
  }
}

void consumer() {
  while (1) {
    P(&fill);
    printf(")");
    V(&empty);
  }
}

int main(int argc, char *argv[]) {
  assert(argc == 2);
  SEM_INIT(&fill, 0);
  SEM_INIT(&empty, atoi(argv[1]));
  for (int i = 0; i < 8; i++) {
    create(producer);
    create(consumer);
  }
}

```

## å››ã€å“²å­¦å®¶åƒé¥­é—®é¢˜

### 1ã€å“²å­¦å®¶åƒé¥­é—®é¢˜ (E. W. Dijkstra, 1960)

å“²å­¦å®¶ (çº¿ç¨‹) æœ‰æ—¶æ€è€ƒï¼Œæœ‰æ—¶åƒé¥­

- åƒé¥­éœ€è¦åŒæ—¶å¾—åˆ°å·¦æ‰‹å’Œå³æ‰‹çš„å‰å­
- å½“å‰å­è¢«å…¶ä»–äººå æœ‰æ—¶ï¼Œå¿…é¡»ç­‰å¾…ï¼Œå¦‚ä½•å®ŒæˆåŒæ­¥ï¼Ÿ
    - å¦‚ä½•ç”¨äº’æ–¥é”/ä¿¡å·é‡å®ç°ï¼Ÿ

![img](./doc/dining-philosophers.png)

### 2ã€å¤±è´¥ä¸æˆåŠŸçš„å°è¯•

å¤±è´¥çš„å°è¯•ï¼Œæ­»é”

- [philosopher.c](http://jyywiki.cn/pages/OS/2022/demos/philosopher.c) (å¦‚ä½•è§£å†³ï¼Ÿ)

```c
#include "thread.h"
#include "thread-sync.h"

#define N 3
sem_t locks[N];

// æ‰€æœ‰äººéƒ½å…ˆæ‹¿å·¦æ‰‹çš„å‰å­
void Tphilosopher(int id) {
  int lhs = (N + id - 1) % N;
  int rhs = id % N;
  while (1) {
    P(&locks[lhs]);
    printf("T%d Got %d\n", id, lhs + 1);
    P(&locks[rhs]);
    printf("T%d Got %d\n", id, rhs + 1);
    V(&locks[lhs]);
    V(&locks[rhs]);
  }
}

int main(int argc, char *argv[]) {
  for (int i = 0; i < N; i++) {
      SEM_INIT(&locks[i], 1);
  }
  for (int i = 0; i < N; i++) {
    create(Tphilosopher);
  }
}

```

æˆåŠŸçš„å°è¯• (ä¸‡èƒ½çš„æ–¹æ³•ï¼Œæ¡ä»¶å˜é‡)

```c
mutex_lock(&mutex);                    // å…ˆä¸Šä¸€æŠŠäº’æ–¥é”ï¼Œä½ ä»¬éƒ½åˆ«åŠ¨
while (!(avail[lhs] && avail[rhs])) {  // å·¦å³æ‰‹è¾¹çš„å‰å­éƒ½åœ¨çš„è¯é€€å‡ºå¾ªç¯
    wait(&cv, &mutex);                 // æœ‰ä¸åœ¨çš„è¯ï¼Œç­‰å¾…ï¼ŒæŠŠé”é‡Šæ”¾æ‰
}
avail[lhs] = avail[rhs] = false;  // åœ¨é”çš„ä¿æŠ¤ä¸‹ï¼ŒæŠŠä¸¤ä¸ªå‰å­éƒ½æ‹¿èµ·æ¥
mutex_unlock(&mutex);             // å°±å¯ä»¥æŠŠé”é‡Šæ”¾æ‰ï¼Œå°±å¯ä»¥å¼€å§‹åƒé¥­äº†

mutex_lock(&mutex);              // èŠ±äº†è¶³å¤Ÿé•¿çš„æ—¶é—´åƒå®Œé¥­åï¼ŒæŠŠé”å†ä¸Šä¸Š
avail[lhs] = avail[rhs] = true;  // æŠŠå‰å­è¿˜å›å»
broadcast(&cv);                  // æŠŠå…¶ä»–å¯èƒ½è¿˜åœ¨ç­‰å‰å­çš„äººå”¤é†’
mutex_unlock(&mutex);            // é”é‡Šæ”¾æ‰
```

### 3ã€å¿˜äº†ä¿¡å·é‡ï¼Œè®©ä¸€ä¸ªäººé›†ä¸­ç®¡ç†å‰å­å§ï¼

â€œLeader/followerâ€ - ç”Ÿäº§è€…/æ¶ˆè´¹è€…

- åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éå¸¸å¸¸è§çš„è§£å†³æ€è·¯ (HDFS, ...)

```c
void Tphilosopher(int id) {
  send_request(id, EAT);
  P(allowed[id]); // waiter ä¼šæŠŠå‰å­é€’ç»™å“²å­¦å®¶
  philosopher_eat();
  send_request(id, DONE);
}

void Twaiter() {
  while (1) {
    (id, status) = receive_request();
    if (status == EAT) { ... }
    if (status == DONE) { ... }
  }
}
```

---

ç¬¬ 2 èŠ‚ï¼šè‡ªä¸»çš„åŒæ­¥ç®—æ³•ï¼Œåˆ†å¸ƒå¼çš„åŒæ­¥ï¼Œæ¯ä¸ªäººéƒ½è¦è¯•ä¸€è¯•ï¼Œå¤§å®¶éµå®ˆåŒä¸€ä¸ªåè®®

ç¬¬ 3 èŠ‚ï¼šé›†ä¸­å¼çš„ç®—æ³•ï¼ˆmaster-slaveï¼‰ï¼Œè¿œæ¯”åˆ†å¸ƒå¼çš„ç®—æ³•å®¹æ˜“ç†è§£ï¼Œå®¹æ˜“å¼„å¯¹ï¼Œæ›´çµæ´»çš„è°ƒåº¦ï¼Œæœ‰ä¼˜å…ˆçº§

### 4ã€å¿˜äº†é‚£äº›å¤æ‚çš„åŒæ­¥ç®—æ³•å§ï¼

ä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œç®¡å‰å­çš„äººæ˜¯æ€§èƒ½ç“¶é¢ˆ

- ä¸€å¤§æ¡Œäººåƒé¥­ï¼Œæ¯ä¸ªäººéƒ½å«æœåŠ¡å‘˜çš„æ„Ÿè§‰
- Premature optimization is the root of all evil (D. E. Knuth)

------

åœ¨ä½ å¯¹è¿™ä¸ªç³»ç»Ÿï¼Œåˆ°åº•è¿™ä¸ªç“¶é¢ˆåœ¨å“ªé‡Œäº†è§£ä¹‹å‰ï¼Œä¸è¦åšä»»ä½•çš„ä¼˜åŒ–

**æŠ›å¼€ workload è°ˆä¼˜åŒ–å°±æ˜¯è€æµæ°“**

- åƒé¥­çš„æ—¶é—´é€šå¸¸è¿œè¿œå¤§äºè¯·æ±‚æœåŠ¡å‘˜çš„æ—¶é—´
- å¦‚æœä¸€ä¸ª manager æä¸å®šï¼Œå¯ä»¥åˆ†å¤šä¸ª (fast/slow path)
    - æŠŠç³»ç»Ÿè®¾è®¡å¥½ï¼Œä½¿é›†ä¸­ç®¡ç†ä¸æˆä¸ºç“¶é¢ˆ
        - [Millions of tiny databases](https://www.usenix.org/conference/nsdi20/presentation/brooker) (NSDI'20)

## æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸ŠååŒå¤šä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Ÿ

ä½¿ç”¨ä¸‡èƒ½çš„æ¡ä»¶å˜é‡ï¼Œå¯ä»¥è§£å†³ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼ŒæŠŠä¸€ä¸ªå¤§ä»»åŠ¡é€šè¿‡è®¡ç®—å›¾çš„æ–¹å¼æ‹†æˆå°ä»»åŠ¡

å°±å¯ä»¥å¹¶è¡Œä»»ä½•ç®—æ³•

------

Take-away message

- å®ç°åŒæ­¥çš„æ–¹æ³•
    - æ¡ä»¶å˜é‡ã€ä¿¡å·é‡ï¼›ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜
    - Job queue å¯ä»¥å®ç°å‡ ä¹ä»»ä½•å¹¶è¡Œç®—æ³•
- ä¸è¦ â€œè‡ªä½œèªæ˜â€ è®¾è®¡ç®—æ³•ï¼Œå°å¿ƒæ±‚è¯