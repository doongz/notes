# æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº

## Overview

å¤ä¹ ï¼šæ“ä½œç³»ç»Ÿ

- åº”ç”¨è§†è§’ (è®¾è®¡): ä¸€ç»„å¯¹è±¡ (è¿›ç¨‹/æ–‡ä»¶/...) + API
- ç¡¬ä»¶è§†è§’ (å®ç°): ä¸€ä¸ª C ç¨‹åº

------

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: åˆ°åº•ä»€ä¹ˆæ˜¯ â€œç¨‹åºâ€ï¼Ÿ

------

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹ (å’Œç¼–è¯‘å™¨)
- æ“ä½œç³»ç»Ÿä¸Šçš„ {æœ€å°/ä¸€èˆ¬/å›¾å½¢} ç¨‹åº

## ä¸€ã€æ•°å­—ç”µè·¯ä¸çŠ¶æ€æœº

### 1ã€æ•°å­—ç”µè·¯ä¸çŠ¶æ€æœº

æ•°å­—é€»è¾‘ç”µè·¯

- çŠ¶æ€ = å¯„å­˜å™¨ä¿å­˜çš„å€¼ (flip-flop)
- åˆå§‹çŠ¶æ€ = RESET (implementation dependent)
- è¿ç§» = ç»„åˆé€»è¾‘ç”µè·¯è®¡ç®—å¯„å­˜å™¨ä¸‹ä¸€å‘¨æœŸçš„å€¼

### 2ã€æ•°å­—é€»è¾‘ç”µè·¯ï¼šæ¨¡æ‹Ÿå™¨

```c
#include <stdio.h>
#include <unistd.h>

#define REGS_FOREACH(_)  _(X) _(Y)
#define RUN_LOGIC        X1 = !X && Y; \
                         Y1 = !X && !Y;
#define DEFINE(X)        static int X, X##1;
#define UPDATE(X)        X = X##1;
#define PRINT(X)         printf(#X " = %d; ", X);

int main() {
  REGS_FOREACH(DEFINE);
  while (1) { // clock
    RUN_LOGIC;
    REGS_FOREACH(PRINT);
    REGS_FOREACH(UPDATE);
    putchar('\n'); sleep(1);
  }
}
```

é¢„ç¼–è¯‘çš„å®å±•å¼€ï¼š`gcc -E a.c`

```c
int main() {
  static int X, X1; static int Y, Y1;;
  while (1) {
    X1 = !X && Y; Y1 = !X && !Y;;
    printf("X" " = %d; ", X); printf("Y" " = %d; ", Y);;
    X = X1; Y = Y1;;
    putchar('\n'); sleep(1);
  }
}
```

### 3ã€æ›´å®Œæ•´çš„å®ç°ï¼šæ•°ç ç®¡æ˜¾ç¤º

è¾“å‡ºæ•°ç ç®¡çš„é…ç½®ä¿¡å·

- [logisim.c](http://jyywiki.cn/pages/OS/2022/demos/logisim.c)
- ä¼šç¼–ç¨‹ï¼Œä½ å°±æ‹¥æœ‰å…¨ä¸–ç•Œï¼
    - [seven-seg.py](http://jyywiki.cn/pages/OS/2022/demos/seven-seg.py)
    - åŒæ ·çš„æ–¹å¼å¯ä»¥æ¨¡æ‹Ÿä»»ä½•æ•°å­—ç³»ç»Ÿ
        - å½“ç„¶ï¼Œä¹ŸåŒ…æ‹¬è®¡ç®—æœºç³»ç»Ÿ

åç«¯ï¼šlogisim.c

```c
#include <stdio.h>
#include <unistd.h>

#define REGS_FOREACH(_)  _(X) _(Y)
#define OUTS_FOREACH(_)  _(A) _(B) _(C) _(D) _(E) _(F) _(G)
#define RUN_LOGIC        X1 = !X && Y; \
                         Y1 = !X && !Y; \
                         A  = (!X && !Y) || (X && !Y); \
                         B  = 1; \
                         C  = (!X && !Y) || (!X && Y); \
                         D  = (!X && !Y) || (X && !Y); \
                         E  = (!X && !Y) || (X && !Y); \
                         F  = (!X && !Y); \
                         G  = (X && !Y); 

#define DEFINE(X)   static int X, X##1;
#define UPDATE(X)   X = X##1;
#define PRINT(X)    printf(#X " = %d; ", X);

int main() {
  REGS_FOREACH(DEFINE);
  OUTS_FOREACH(DEFINE);
  while (1) { // clock
    RUN_LOGIC;
    OUTS_FOREACH(PRINT);
    REGS_FOREACH(UPDATE);
    putchar('\n');
    fflush(stdout);
    sleep(1);
  }
}
```

å‰ç«¯ï¼šseven-seg.py

```python
import fileinput
 
TEMPLATE = '''
\033[2J\033[1;1f
     AAAAAAAAA
    FF       BB
    FF       BB
    FF       BB
    FF       BB
    GGGGGGGGGG
   EE       CC
   EE       CC
   EE       CC
   EE       CC
    DDDDDDDDD
''' 
BLOCK = {
    0: '\033[37mâ–‘\033[0m', # STFW: ANSI Escape Code
    1: '\033[31mâ–ˆ\033[0m',
}
VARS = 'ABCDEFG'

for v in VARS:
    globals()[v] = 0
stdin = fileinput.input()

while True:
    exec(stdin.readline())
    pic = TEMPLATE
    for v in VARS:
        pic = pic.replace(v, BLOCK[globals()[v]]) # 'A' -> BLOCK[A], ...
    print(pic)

```

æ‰§è¡Œä¸‹ï¼š`./a.out | python seven-seg.py`

------

ä½ è¿˜ä½“éªŒäº† UNIX å“²å­¦

- Make each program do one thing well
- Expect the output of every program to become the input to another

## äºŒã€ä»€ä¹ˆæ˜¯ç¨‹åº (æºä»£ç è§†è§’)

### 1ã€ä»€ä¹ˆæ˜¯ç¨‹åºï¼Ÿ

ä½ éœ€è¦ã€Š[ç¨‹åºè®¾è®¡è¯­è¨€çš„å½¢å¼è¯­ä¹‰](https://cs.nju.edu.cn/hongjin/teaching/semantics/index.htm)ã€‹

- by æ¢çº¢ç‘¾ ğŸ©
- Î»-calculus, operational semantics, Hoare logic, separation logic
- å…¥å›´ â€œä½ åœ¨å—äº¬å¤§å­¦ä¸Šè¿‡æœ€ç‰›çš„è¯¾æ˜¯ä»€ä¹ˆï¼Ÿâ€ çŸ¥ä¹é«˜ç¥¨ç­”æ¡ˆ
    - ~~å½“ç„¶ï¼Œæˆ‘ä¹Ÿåšé¢œæ— è€»åœ°å…¥å›´äº†~~

### 2ã€ç¨‹åºå°±æ˜¯çŠ¶æ€æœº

ç¨‹åºå°±æ˜¯çŠ¶æ€æœº (ä½ åœ¨ gdb é‡Œçœ‹åˆ°çš„)

- è¯•è¯•ç¨‹åºå§ [hanoi-r.c](http://jyywiki.cn/pages/OS/2022/demos/hanoi-r.c)

æ±‰è¯ºå¡”ç¨‹åºï¼Œå“ˆå“ˆï¼Œè™äººå•¦

hanoi-r.c

```c
void hanoi(int n, char from, char to, char via) {
  if (n == 1) printf("%c -> %c\n", from, to);
  else {
    hanoi(n - 1, from, via, to);
    hanoi(1,     from, to,  via);
    hanoi(n - 1, via,  to,  from);
  }
  return;
}
```

main.c

```c
#include <stdio.h>

#include "hanoi-r.c"

int main() {
    hanoi(3, 'A', 'B', 'c');
}
```

`#include` çš„å½¢å¼è¯­ä¹‰å°±æ˜¯å¤åˆ¶ç²˜è´´

```shell
gcc main.c
./a.out 
A -> B
A -> c
B -> c
A -> B
c -> A
c -> B
A -> B
```

------

**C ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹** (è¯­ä¹‰ï¼Œsemantics)

- çŠ¶æ€ = å † + æ ˆ
- åˆå§‹çŠ¶æ€ = `main` çš„ç¬¬ä¸€æ¡è¯­å¥
- è¿ç§» = æ‰§è¡Œä¸€æ¡ç®€å•è¯­å¥
    - ä»»ä½• C ç¨‹åºéƒ½å¯ä»¥æ”¹å†™æˆ â€œéå¤åˆè¯­å¥â€ çš„ C ä»£ç 
    - [çœŸçš„æœ‰è¿™ç§å·¥å…·](https://cil-project.github.io/cil/) (C Intermediate Language) å’Œ[è§£é‡Šå™¨](https://gitlab.com/zsaleeba/picoc)

**cè¯­è¨€ç¨‹åºæ˜¯ä»€ä¹ˆ**ï¼Ÿ

å¯¹äºcè¯­è¨€çš„ç¨‹åºè€Œè¨€ï¼Œcè¯­è¨€çš„ç¨‹åºç”±å¾ˆå¤šçš„æ ˆå¸§ï¼ˆstack frameï¼‰ç»„æˆï¼Œæ¯æ¬¡å‡½æ•°è°ƒç”¨éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„æ ˆå¸§

main æœ‰è‡ªå·±çš„å‚æ•° argcã€argvï¼Œå±€éƒ¨å˜é‡ï¼Œæœ€é‡è¦çš„æ˜¯ç¨‹åºè®¡æ•°å™¨ pcï¼Œ

pc ç›´è§‚çš„çœ‹å°±æ˜¯ gdb ä¸­æ˜¾ç¤ºçš„æ¡å­

**å‡½æ•°è°ƒç”¨æ˜¯ä»€ä¹ˆ**ï¼Ÿ

åˆ›å»ºä¸€ä¸ªæ–°çš„çŠ¶æ€ï¼Œcall å¦ä¸€ä¸ªå‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§

å‘èµ·è°ƒç”¨çš„å‡½æ•°çš„æ ˆå¸§ä¸­çš„ pc++ï¼›è¢«è°ƒç”¨çš„å‡½æ•°çš„æ ˆå¸§ä¸­çš„ pc=0

**å‡½æ•°è°ƒç”¨çš„è¿”å›æ˜¯ä»€ä¹ˆ**ï¼Ÿ

æŠŠé¡¶ä¸Šçš„æ ˆå¸§åˆ æ‰ï¼Œå‘èµ·è°ƒç”¨çš„å‡½æ•°çš„æ ˆå¸§ä¸­çš„ pc--

![](./doc/Snipaste_2022-06-26_23-38-57.jpeg)

------

(è¿™è¿˜åªæ˜¯ â€œç²—æµ…â€ çš„ç†è§£)

- Talk is cheap. Show me the code. (Linus Torvalds): ä»»ä½•çœŸæ­£çš„ç†è§£éƒ½åº”è¯¥è½åˆ°å¯ä»¥æ‰§è¡Œçš„ä»£ç 

### 3ã€C ç¨‹åºçš„è¯­ä¹‰

C ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹ (è¯­ä¹‰ï¼Œsemantics)

- çŠ¶æ€ = stack frame çš„åˆ—è¡¨ (æ¯ä¸ª frame æœ‰ PC) + å…¨å±€å˜é‡
- åˆå§‹çŠ¶æ€ = main(argc, argv), å…¨å±€å˜é‡åˆå§‹åŒ–
- è¿ç§» = æ‰§è¡Œ top stack frame PC çš„è¯­å¥; PC++
    - å‡½æ•°è°ƒç”¨ = push frame (frame.PC = å…¥å£)
    - å‡½æ•°è¿”å› = pop frame

------

åº”ç”¨ï¼šå°†ä»»ä½•é€’å½’ç¨‹åºå°±åœ°è½¬ä¸ºéé€’å½’

- æ±‰è¯ºå¡”éš¾ä¸å€’ä½  [hanoi-nr.c](http://jyywiki.cn/pages/OS/2022/demos/hanoi-nr.c)
- A â†’ B, B â†’ A çš„ä¹Ÿéš¾ä¸å€’ä½ 
    - è¿˜æ˜¯ä¸€æ ·çš„ `call()`ï¼Œä½†æ”¾å…¥ä¸åŒçš„ `Frame`

```c
typedef struct {
  int pc, n;
  char from, to, via;
} Frame;

#define call(...) ({ *(++top) = (Frame) { .pc = 0, __VA_ARGS__ }; })
#define ret()     ({ top--; })
#define goto(loc) ({ f->pc = (loc) - 1; })

void hanoi(int n, char from, char to, char via) {
  Frame stk[64], *top = stk - 1;
  call(n, from, to, via);
  for (Frame *f; (f = top) >= stk; f->pc++) {
    switch (f->pc) {
      case 0: if (f->n == 1) { printf("%c -> %c\n", f->from, f->to); goto(4); } break;
      case 1: call(f->n - 1, f->from, f->via, f->to);   break;
      case 2: call(       1, f->from, f->to,  f->via);  break;
      case 3: call(f->n - 1, f->via,  f->to,  f->from); break;
      case 4: ret();                                    break;
      default: assert(0);
    }
  }
}
```

```c
#include <stdio.h>
#include <assert.h>

#include "hanoi-nr.c"

int main() {
    hanoi(3, 'A', 'B', 'c');
}
```

