# çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹

## Overview

å¤ä¹ 

- å¹¶å‘ç¼–ç¨‹çš„åŸºæœ¬å·¥å…·ï¼šçº¿ç¨‹åº“ã€äº’æ–¥å’ŒåŒæ­¥

------

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: ä»€ä¹ˆæ ·çš„ä»»åŠ¡æ˜¯éœ€è¦å¹¶è¡Œ/å¹¶å‘çš„ï¼Ÿå®ƒä»¬åº”è¯¥å¦‚ä½•å®ç°ï¼Ÿ

------

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶å‘ç¼–ç¨‹
- æ•°æ®ä¸­å¿ƒé‡Œçš„å¹¶å‘ç¼–ç¨‹
- æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹

## æ”¶è·

### 1ã€ä»€ä¹ˆæ ·çš„ä»»åŠ¡æ˜¯éœ€è¦å¹¶è¡Œ/å¹¶å‘çš„ï¼Ÿå®ƒä»¬åº”è¯¥å¦‚ä½•å®ç°ï¼Ÿ

è®²äº†ä¸‰ç§çœŸæ­£çš„å¹¶å‘ç¨‹åºæ˜¯æ€ä¹ˆå†™çš„ï¼Œé«˜æ€§èƒ½è®¡ç®—æ³¨é‡çš„æ˜¯ä»»åŠ¡çš„åˆ†è§£ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼›æ•°æ®ä¸­å¿ƒï¼Œæ³¨é‡çš„å­˜å‚¨ï¼Œæ„å‘³ç€ç³»ç»Ÿè°ƒç”¨ï¼Œé€šè¿‡åç¨‹çº¿ç¨‹è§£å†³ï¼›å†™äººæœºäº¤äº’çš„å‰ç«¯ï¼Œæ³¨é‡çš„æ˜¯ä»£ç çš„ç»´æŠ¤æ€§ã€‚

éƒ½å¯ä»¥ç”¨çº¿ç¨‹æ¥å®ç°

- å¹¶å‘ç¼–ç¨‹çš„çœŸå®åº”ç”¨åœºæ™¯
    - é«˜æ€§èƒ½è®¡ç®— (æ³¨é‡ä»»åŠ¡åˆ†è§£): ç”Ÿäº§è€…-æ¶ˆè´¹è€… (MPI/OpenMP)
    - æ•°æ®ä¸­å¿ƒ (æ³¨é‡ç³»ç»Ÿè°ƒç”¨): çº¿ç¨‹-åç¨‹ (Goroutine)
    - äººæœºäº¤äº’ (æ³¨é‡æ˜“ç”¨æ€§): äº‹ä»¶-æµå›¾ (Promise)
- ç¼–ç¨‹å·¥å…·çš„å‘å±•çªé£çŒ›è¿›
    - è‡ª Web 2.0 ä»¥æ¥ï¼Œå¼€æºç¤¾åŒºæ”¹å˜äº†è®¡ç®—æœºç§‘å­¦çš„å­¦ä¹ æ–¹å¼

### 2ã€çº¿ç¨‹ã€åç¨‹ã€Goroutine

ä¸€ä¸ªçº¿ç¨‹æ˜¯cè¯­è¨€ç¼–è¯‘æˆæ±‡ç¼–çš„çŠ¶æ€æœºï¼Œç„¶åçŠ¶æ€æœºæ¯èµ°ä¸€éƒ¨éœ€è¦æ‰§è¡Œä¸€æ¡æŒ‡ä»¤

ä»ä¸€ä¸ªçŠ¶æ€æœºåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçŠ¶æ€æœºï¼Œé‚£ä¹ˆå°±éœ€è¦ä¿å­˜æ‰€æœ‰çš„å¯„å­˜å™¨ï¼Œx86çš„è¯ abcd sidi pbst r8 r9 åå…­çš„å¯„å­˜å™¨ï¼Œè¿˜æœ‰ç³»ç»Ÿå¯„å­˜å™¨ pcï¼Œå°±å¾ˆå¤§çš„å¼€é”€äº†ï¼›ç„¶åè¿˜è¦åˆ°å†…æ ¸é‡Œå…œä¸€åœˆï¼Œç„¶åé€‰æ‹©ä¸‹ä¸ªè¦æ‰§è¡Œçš„çº¿ç¨‹ï¼ŒæŠŠè¿™ä¸ªçº¿ç¨‹é‡Œçš„ä¿¡æ¯æ¢å¤åˆ°å¯„å­˜å™¨é‡Œï¼Œè¿˜è¦æ¶‰åŠåœ°å€ç©ºé—´çš„å˜åŒ–

å› æ­¤ï¼Œçº¿ç¨‹åˆ‡æ¢çš„å¼€é”€å¾ˆå¤§

---

åç¨‹ï¼Œå¾ˆå°‘çš„åˆ‡æ¢ï¼Œä½†æ˜¯ä¼šé€ æˆçº¿ç¨‹çš„é˜»å¡

åœ¨æ•°æ®ä¸­å¿ƒé‡Œé¢ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè®¸å¤šåç¨‹çš„è¯ï¼Œé¢ä¸´çš„é—®é¢˜ï¼šå¦‚æœæœ‰ä¸€ä¸ªåç¨‹ block äº†ï¼ˆç­‰ç£ç›˜æˆ–è€…ç­‰ç½‘ç»œï¼Œå‘å¦ä¸€ä¸ªæœåŠ¡å™¨æƒ…å†µï¼Œå¯èƒ½100ms æ‰èƒ½å›æ¥ï¼‰ï¼Œå…¶ä»–åç¨‹çš„cpuå°±è¢«æµªè´¹æ‰äº†

---

> Go: å°å­©å­æ‰åšé€‰æ‹©ï¼Œå¤šå¤„ç†å™¨å¹¶è¡Œå’Œè½»é‡çº§å¹¶å‘æˆ‘å…¨éƒ½è¦ï¼

Goroutine: æ¦‚å¿µä¸Šæ˜¯çº¿ç¨‹ï¼Œå®é™…æ˜¯çº¿ç¨‹å’Œåç¨‹çš„æ··åˆä½“

- æ¯ä¸ª CPU ä¸Šæœ‰ä¸€ä¸ª Go Workerï¼Œè‡ªç”±è°ƒåº¦ goroutines
- æ‰§è¡Œåˆ° blocking API æ—¶ (ä¾‹å¦‚ sleep, read)
    - Go Worker å·å·æ”¹æˆ non-blocking çš„ç‰ˆæœ¬
        - æˆåŠŸ â†’ ç«‹å³ç»§ç»­æ‰§è¡Œ
        - å¤±è´¥ â†’ ç«‹å³ yield åˆ°å¦ä¸€ä¸ªéœ€è¦ CPU çš„ goroutine
            - å¤ªå·§å¦™äº†ï¼CPU å’Œæ“ä½œç³»ç»Ÿå…¨éƒ¨ç”¨åˆ° 100%

æ¯ä¸ªCPUä¸Šéƒ½ç»‘å®šä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åˆæœ‰å¤šä¸ªåç¨‹ï¼Œæœ‰ä¸ªå¾ˆå·§å¦™çš„è®¾è®¡ï¼ˆä¸Šè¯¾ç¬”è®°ï¼‰ï¼š

- å¦‚æœä¸€ä¸ªåç¨‹ read() çš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šé˜»å¡çš„å˜›ï¼Œ
- ç„¶åä»–å°±æŠŠé˜»å¡çš„ read() ç³»ç»Ÿè°ƒç”¨æ›¿æ¢æˆä¸é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆscanf printf éƒ½æ˜¯é˜»å¡çš„ï¼Œlinux ä¸­éƒ½æœ‰ç›¸å¯¹åº”ä¸é˜»å¡çš„ï¼‰
- å…¶å®å°±æ˜¯ read() æ›¿æ¢æˆ read_non_block()
- å¦‚æœè¿™ä¸ª read_non_block() æ²¡æœ‰è¿”å›çš„è¯ï¼Œä¼šç«‹å³åˆ‡æ¢åˆ°çº¿ç¨‹ä¸‹çš„å¦ä¸€ä¸ªåç¨‹æ‰§è¡Œ
- ç›´åˆ°æœ‰ä¸€å¤©æ•°æ®å›æ¥äº†ï¼Œread_non_blockçš„åç¨‹ä¼šè¢«æ ‡è®°ä¸ºå¯æ‰§è¡Œçš„

ç›¸å½“äºï¼Œå½“åç¨‹æƒ³åšä¸€ä»¶è€—æ—¶çš„äº‹æƒ…çš„æ—¶å€™ï¼Œå‘Šè¯‰æ“ä½œç³»ç»Ÿï¼Œæˆ‘è¦åšè¿™ä»¶äº‹äº†ï¼Œä½ ç­‰ç­‰ï¼Œç„¶åé©¬ä¸Šåˆ‡æ¢åˆ°å¦ä¸€ä¸ªåç¨‹è¿è¡Œ

## ä¸€ã€é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶å‘ç¼–ç¨‹

### 1ã€é«˜æ€§èƒ½è®¡ç®—ç¨‹åºï¼šç‰¹ç‚¹

> â€œA technology that harnesses the power of supercomputers or computer clusters to solve complex problems requiring massive computation.â€ (IBM)

ä»¥è®¡ç®—ä¸ºä¸­å¿ƒ

- ç³»ç»Ÿæ¨¡æ‹Ÿï¼šå¤©æ°”é¢„æŠ¥ã€èƒ½æºã€åˆ†å­ç”Ÿç‰©å­¦
- äººå·¥æ™ºèƒ½ï¼šç¥ç»ç½‘ç»œè®­ç»ƒ
- çŸ¿å‚ï¼šçº¯ç²¹çš„ hash è®¡ç®—
- [HPC-China 100](http://www.hpc100.cn/top100/20/)

### 2ã€é«˜æ€§èƒ½è®¡ç®—ï¼šä¸»è¦æŒ‘æˆ˜

è®¡ç®—ä»»åŠ¡å¦‚ä½•åˆ†è§£

- è®¡ç®—å›¾éœ€è¦å®¹æ˜“å¹¶è¡ŒåŒ–
    - æœºå™¨-çº¿ç¨‹ä¸¤çº§ä»»åŠ¡åˆ†è§£
- ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³ä¸€åˆ‡
    - [MPI](https://hpc-tutorials.llnl.gov/mpi/) - â€œa specification for the developers and users of message passing librariesâ€, [OpenMP](https://www.openmp.org/) - â€œmulti-platform shared-memory parallel programming in C/C++ and Fortranâ€
- [Parallel and Distributed Computation: Numerical Methods](https://web.mit.edu/dimitrib/www/pdc.html)

çœŸæ­£æƒ³å­¦é«˜æ€§èƒ½è®¡ç®—çš„è¯ï¼Œçœ‹å®Œä¸Šé¢ğŸ‘†è¿™æœ¬ä¹¦å°±å¯ä»¥äº†

- å‘Šè¯‰äº†æˆ‘ä»¬æ€ä¹ˆå»æ±‚çº¿æ€§æ–¹ç¨‹ç»„ï¼Œçº¿æ€§è§„åˆ’è¿™ç±»é‡è¦çš„æ•°å­¦é—®é¢˜
- æ¨¡æ‹Ÿå®è§‚ä¸–ç•Œå°±æ˜¯æœ‰é™å…ƒï¼Œæ¨¡æ‹Ÿå¾®è§‚ä¸–ç•Œå°±æ˜¯é‡å­
- åœ¨è¶…çº§è®¡ç®—æœºé‡Œè§£å†³è¿™äº›é—®é¢˜çš„æ–¹æ³•å°±è¿™äº›

------

çº¿ç¨‹é—´å¦‚ä½•é€šä¿¡

- é€šä¿¡ä¸ä»…å‘ç”Ÿåœ¨èŠ‚ç‚¹/çº¿ç¨‹ä¹‹é—´ï¼Œè¿˜å‘ç”Ÿåœ¨ä»»ä½•å…±äº«å†…å­˜è®¿é—®
- è¿˜è®°å¾—è¢« [mem-ordering.c](http://jyywiki.cn/pages/OS/2022/demos/mem-ordering.c) æ”¯é…çš„ææƒ§å—ï¼Ÿ

---

é«˜æ€§èƒ½è®¡ç®—ä¸»è¦é ã€Œå¹¶è¡ŒåŒ–ã€ï¼Œèƒ½å¤Ÿå¹¶è¡ŒåŒ–çš„å‰ææ˜¯è¿™ä¸ªæ€»ä»»åŠ¡å¯ä»¥ã€Œåˆ†è§£ã€ï¼Œå­ä»»åŠ¡å„è‡ªç‹¬ç«‹çš„è·‘åœ¨çº¿ç¨‹ä¸­ï¼Œä¸è¿‡å­ä»»åŠ¡å¯èƒ½ä¹Ÿè¦è¿›è¡Œä¸€äº›äº¤äº’ï¼Œä¼šæ¶‰åŠçº¿ç¨‹é—´é€šä¿¡

### 3ã€ä¾‹å­ï¼šMandelbrot Set

![img](./doc/Mandelbrot.png)

- [mandelbrot.c](http://jyywiki.cn/pages/OS/2022/demos/mandelbrot.c) (embarrassingly parallel)

```c
#include "thread.h"
#include <math.h>

int NT;
#define W 6400
#define H 6400
#define IMG_FILE "mandelbrot.ppm"

static inline int belongs(int x, int y, int t) {
  return x / (W / NT) == t;
}

int x[W][H];
int volatile done = 0;

// ç”Ÿæˆå›¾ç‰‡çš„ç®—æ³• ppm
void display(FILE *fp, int step) { 
  static int rnd = 1;
  int w = W / step, h = H / step;
  // STFW: Portable Pixel Map
  fprintf(fp, "P6\n%d %d 255\n", w, h);
  for (int j = 0; j < H; j += step) {
    for (int i = 0; i < W; i += step) {
      int n = x[i][j];
      int r = 255 * pow((n - 80) / 800.0, 3);
      int g = 255 * pow((n - 80) / 800.0, 0.7);
      int b = 255 * pow((n - 80) / 800.0, 0.5);
      fputc(r, fp); fputc(g, fp); fputc(b, fp);
    }
  }
}

void Tworker(int tid) {
  for (int i = 0; i < W; i++)
    for (int j = 0; j < H; j++)
      if (belongs(i, j, tid - 1)) {
        double a = 0, b = 0, c, d;
        while ((c = a * a) + (d = b * b) < 4 && x[i][j]++ < 880) {
          b = 2 * a * b + j * 1024.0 / H * 8e-9 - 0.645411;
          a = c - d + i * 1024.0 / W * 8e-9 + 0.356888;
        }
      }
  done++;
}

void Tdisplay() {
  float ms = 0;
  while (1) {
    // FILE *fp = popen("viu -", "w"); assert(fp); // æ²¡è£…viuçš„è¯å¯ä»¥æ³¨æ‰
    // display(fp, W / 256);
    // pclose(fp);
    if (done == NT) break;
    usleep(1000000 / 5);
    ms += 1000.0 / 5;
  }
  printf("Approximate render time: %.1lfs\n", ms / 1000);

  FILE *fp = fopen(IMG_FILE, "w"); assert(fp);
  display(fp, 2);
  fclose(fp);
}

int main(int argc, char *argv[]) {
  assert(argc == 2);
  NT = atoi(argv[1]);
  for (int i = 0; i < NT; i++) {
    create(Tworker);
  }
  create(Tdisplay);
  join();
  return 0;
}

```

```bash
$ gcc mandelbrot.c -lpthread -lm -O2

# å¾—å®‰è£… viuï¼Œä¸è£…çš„è¯æ³¨é‡Šæ‰é‚£ä¸‰è¡Œ
$ ./a.out 4
Approximate render time: 8.2s

# å¯ä»¥è½¬æ ¼å¼æ‰“å¼€ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‰“å¼€ppm
$ convert mandelbrot.ppm a.jpg
$ open mandelbrot.ppm
```

![mandelbrot](./doc/mandelbrot-my.png)

## äºŒã€æ•°æ®ä¸­å¿ƒé‡Œçš„å¹¶å‘ç¼–ç¨‹

### 1ã€æ•°æ®ä¸­å¿ƒç¨‹åºï¼šç‰¹ç‚¹

> â€œA network of compu ting and storage resources that enable the delivery of shared applications and data.â€ (CISCO)

ä»¥æ•°æ® (å­˜å‚¨) ä¸ºä¸­å¿ƒ

- ä»äº’è”ç½‘æœç´¢ (Google)ã€ç¤¾äº¤ç½‘ç»œ (Facebook/Twitter) èµ·å®¶
- æ”¯æ’‘å„ç±»äº’è”ç½‘åº”ç”¨ï¼šå¾®ä¿¡/QQ/æ”¯ä»˜å®/æ¸¸æˆ/ç½‘ç›˜/â€¦â€¦

------

ç®—æ³•/ç³»ç»Ÿå¯¹ HPC å’Œæ•°æ®ä¸­å¿ƒçš„æ„ä¹‰

- ä½ æœ‰ 1,000,000 å°æœåŠ¡å™¨
- å¦‚æœä¸€ä¸ªç®—æ³•/å®ç°èƒ½å¿« 1%ï¼Œå°±èƒ½çœ 10,000 å°æœåŠ¡å™¨
  - å‚è€ƒï¼šå¯¹é¢ä¸€å¥—æˆ¿ â‰ˆ 50 å°æœåŠ¡å™¨ (ä¸è®¡è¿ç»´æˆæœ¬)

### 2ã€æ•°æ®ä¸­å¿ƒï¼šä¸»è¦æŒ‘æˆ˜

**å¤šå‰¯æœ¬æƒ…å†µä¸‹çš„é«˜å¯é ã€ä½å»¶è¿Ÿæ•°æ®è®¿é—®**

- åœ¨æœåŠ¡æµ·é‡åœ°ç†åˆ†å¸ƒè¯·æ±‚çš„å‰æä¸‹
  - æ•°æ®è¦ä¿æŒä¸€è‡´ (Consistency)
  - æœåŠ¡æ—¶åˆ»ä¿æŒå¯ç”¨ (Availability)
  - å®¹å¿æœºå™¨ç¦»çº¿ (Partition tolerance)

![img](./doc/CAP-theorem.png)

### 3ã€è¿™é—¨è¯¾çš„é—®é¢˜ï¼šå¦‚ä½•ç”¨å¥½ä¸€å°è®¡ç®—æœºï¼Ÿ

å¦‚ä½•ç”¨ä¸€å° (å¯é çš„) è®¡ç®—æœºå°½å¯èƒ½å¤šåœ°æœåŠ¡å¹¶è¡Œçš„è¯·æ±‚

- å…³é”®æŒ‡æ ‡ï¼šQPS, tail latency, ...

------

æˆ‘ä»¬æœ‰çš„å·¥å…·

- çº¿ç¨‹ (threads)

```
thread(start = true) {
  println("${Thread.currentThread()} has run.")
}
```

**çº¿ç¨‹åˆ‡æ¢æ˜¯æœ‰ä»£ä»·çš„**ï¼Œåˆ‡æ¢çš„æ—¶å€™åšäº†ä»€ä¹ˆ

ä¸€ä¸ªçº¿ç¨‹æ˜¯cè¯­è¨€ç¼–è¯‘æˆæ±‡ç¼–çš„çŠ¶æ€æœºï¼Œç„¶åçŠ¶æ€æœºæ¯èµ°ä¸€éƒ¨éœ€è¦æ‰§è¡Œä¸€æ¡æŒ‡ä»¤

ä»ä¸€ä¸ªçŠ¶æ€æœºåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçŠ¶æ€æœºï¼Œé‚£ä¹ˆå°±éœ€è¦ä¿å­˜æ‰€æœ‰çš„å¯„å­˜å™¨ï¼Œx86çš„è¯ abcd sidi pbst r8 r9 åå…­çš„å¯„å­˜å™¨ï¼Œè¿˜æœ‰ç³»ç»Ÿå¯„å­˜å™¨ pcï¼Œå°±å¾ˆå¤§çš„å¼€é”€äº†ï¼›ç„¶åè¿˜è¦åˆ°å†…æ ¸é‡Œå…œä¸€åœˆï¼Œç„¶åé€‰æ‹©ä¸‹ä¸ªè¦æ‰§è¡Œçš„çº¿ç¨‹ï¼ŒæŠŠè¿™ä¸ªçº¿ç¨‹é‡Œçš„ä¿¡æ¯æ¢å¤åˆ°å¯„å­˜å™¨é‡Œï¼Œè¿˜è¦æ¶‰åŠåœ°å€ç©ºé—´çš„å˜åŒ–

---

ã€00:53:00ã€‘è®²åç¨‹ï¼Œå¾—åšå®éªŒï¼Œåœ¨ c ä»£ç ä¸­å®ç°åç¨‹ï¼Œä»£ä»·æ¯”çº¿ç¨‹åˆ‡æ¢å°çš„å¤š

- åç¨‹ (coroutines)
  - å¤šä¸ªå¯ä»¥ä¿å­˜/æ¢å¤çš„æ‰§è¡Œæµ ([M2 - libco](http://jyywiki.cn/OS/2022/labs/M2))
  - æ¯”çº¿ç¨‹æ›´è½»é‡ (å®Œå…¨æ²¡æœ‰ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±æ²¡æœ‰æ“ä½œç³»ç»ŸçŠ¶æ€)

co_yield() ä¼šè¢«ç¿»è¯‘æˆ call co_yield æŒ‡ä»¤ï¼Œåœ¨å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œä¸æ˜¯æ‰€æœ‰çš„ä¸œè¥¿éƒ½ä¸€å®šè¦ä¿å­˜

å¬è€å¸ˆè®²ï¼š1ã€ä¸ç”¨è¿›å…¥æ“ä½œç³»ç»Ÿå†…æ ¸å…œä¸€åœˆï¼›2ã€ä¿å­˜çš„å¯„å­˜å™¨å°‘çš„å¤š

### 4ã€æ•°æ®ä¸­å¿ƒï¼šåç¨‹å’Œçº¿ç¨‹

æ•°æ®ä¸­å¿ƒ

- åŒä¸€æ—¶é—´æœ‰æ•°åƒ/æ•°ä¸‡ä¸ªè¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨
- è®¡ç®—éƒ¨åˆ†
  - éœ€è¦åˆ©ç”¨å¥½å¤šå¤„ç†å™¨
    - çº¿ç¨‹ â†’ è¿™å°±æ˜¯æˆ‘æ“…é•¿çš„ (Mandelbrot Set)
    - åç¨‹ â†’ ä¸€äººå‡ºåŠ›ï¼Œä»–äººæ‘¸é±¼
- I/O éƒ¨åˆ†
  - ä¼šåœ¨ç³»ç»Ÿè°ƒç”¨ä¸Š block (ä¾‹å¦‚è¯·æ±‚å¦ä¸€ä¸ªæœåŠ¡æˆ–è¯»ç£ç›˜)
    - åç¨‹ â†’ ä¸€äººå¹²ç­‰ï¼Œä»–äººå›´è§‚ã€‚å¦‚æœåç¨‹é‡åˆ° read()ï¼Œçº¿ç¨‹æ•´ä¸ªé˜»å¡äº†ï¼Œåˆå˜æˆçº¿ç¨‹äº†
    - çº¿ç¨‹ â†’ æ¯ä¸ªçº¿ç¨‹éƒ½å ç”¨å¯è§‚çš„æ“ä½œç³»ç»Ÿèµ„æº
- (è¿™ä¸ªé—®é¢˜æ¯”ä½ æƒ³è±¡çš„å¤æ‚ï¼Œä¾‹å¦‚è™šæ‹Ÿæœº)

åœ¨æ•°æ®ä¸­å¿ƒé‡Œé¢ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè®¸å¤šåç¨‹çš„è¯ï¼Œé¢ä¸´çš„é—®é¢˜ï¼šå¦‚æœæœ‰ä¸€ä¸ªåç¨‹ block äº†ï¼ˆç­‰ç£ç›˜æˆ–è€…ç­‰ç½‘ç»œï¼Œå‘å¦ä¸€ä¸ªæœåŠ¡å™¨æƒ…å†µï¼Œå¯èƒ½100ms æ‰èƒ½å›æ¥ï¼‰ï¼Œå…¶ä»–åç¨‹çš„cpuå°±è¢«æµªè´¹æ‰äº†

### 5ã€Go å’Œ Goroutine

> Go: å°å­©å­æ‰åšé€‰æ‹©ï¼Œå¤šå¤„ç†å™¨å¹¶è¡Œå’Œè½»é‡çº§å¹¶å‘æˆ‘å…¨éƒ½è¦ï¼

Goroutine: æ¦‚å¿µä¸Šæ˜¯çº¿ç¨‹ï¼Œå®é™…æ˜¯çº¿ç¨‹å’Œåç¨‹çš„æ··åˆä½“

- æ¯ä¸ª CPU ä¸Šæœ‰ä¸€ä¸ª Go Workerï¼Œè‡ªç”±è°ƒåº¦ goroutines
- æ‰§è¡Œåˆ° blocking API æ—¶ (ä¾‹å¦‚ sleep, read)
  - Go Worker å·å·æ”¹æˆ non-blocking çš„ç‰ˆæœ¬
    - æˆåŠŸ â†’ ç«‹å³ç»§ç»­æ‰§è¡Œ
    - å¤±è´¥ â†’ ç«‹å³ yield åˆ°å¦ä¸€ä¸ªéœ€è¦ CPU çš„ goroutine
      - å¤ªå·§å¦™äº†ï¼CPU å’Œæ“ä½œç³»ç»Ÿå…¨éƒ¨ç”¨åˆ° 100%

æ¯ä¸ªCPUä¸Šéƒ½ç»‘å®šä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åˆæœ‰å¤šä¸ªåç¨‹ï¼Œæœ‰ä¸ªå¾ˆå·§å¦™çš„è®¾è®¡ï¼ˆä¸Šè¯¾ç¬”è®°ï¼‰ï¼š

- å¦‚æœä¸€ä¸ªåç¨‹ read() çš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šé˜»å¡çš„å˜›ï¼Œ
- ç„¶åä»–å°±æŠŠé˜»å¡çš„ read() ç³»ç»Ÿè°ƒç”¨æ›¿æ¢æˆä¸é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆscanf printf éƒ½æ˜¯é˜»å¡çš„ï¼Œlinux ä¸­éƒ½æœ‰ç›¸å¯¹åº”ä¸é˜»å¡çš„ï¼‰
- å…¶å®å°±æ˜¯ read() æ›¿æ¢æˆ read_non_block()
- å¦‚æœè¿™ä¸ª read_non_block() æ²¡æœ‰è¿”å›çš„è¯ï¼Œä¼šç«‹å³åˆ‡æ¢åˆ°çº¿ç¨‹ä¸‹çš„å¦ä¸€ä¸ªåç¨‹æ‰§è¡Œ
- ç›´åˆ°æœ‰ä¸€å¤©æ•°æ®å›æ¥äº†ï¼Œread_non_blockçš„åç¨‹ä¼šè¢«æ ‡è®°ä¸ºå¯æ‰§è¡Œçš„

ç›¸å½“äºï¼Œå½“åç¨‹æƒ³åšä¸€ä»¶è€—æ—¶çš„äº‹æƒ…çš„æ—¶å€™ï¼Œå‘Šè¯‰æ“ä½œç³»ç»Ÿï¼Œæˆ‘è¦åšè¿™ä»¶äº‹äº†ï¼Œä½ ç­‰ç­‰ï¼Œç„¶åé©¬ä¸Šåˆ‡æ¢åˆ°å¦ä¸€ä¸ªåç¨‹è¿è¡Œ

------

ä¾‹å­

- [fib.go](http://jyywiki.cn/pages/OS/2022/demos/fib.go); [*The Go Programming Language* (ch 9.8)](https://books.studygolang.com/gopl-zh/ch9/ch9-08.html)

```go
// Example from "The Go Programming Language"

package main

import (
  "fmt"
  "time"
)

func main() {
  go spinner(100 * time.Millisecond)
  const n = 45
  fibN := fib(n) // slow
  fmt.Printf("\rFibonacci(%d) = %d\n", n, fibN)
}

func spinner(delay time.Duration) {
  for {
    for _, r := range `-\|/` {
      fmt.Printf("\r%c", r)
      time.Sleep(delay)
    }
  }
}

func fib(x int) int {
  if x < 2 { return x }
  return fib(x - 1) + fib(x - 2)
}

```

### 6ã€ç°ä»£ç¼–ç¨‹è¯­è¨€ä¸Šçš„ç³»ç»Ÿç¼–ç¨‹

> Do not communicate by sharing memory; instead, share memory by communicating. â€”â€”*Effective Go*

å…±äº«å†…å­˜ = ä¸‡æ¶ä¹‹æºï¼Œå¤ªçµæ´»äº†ï¼ˆä»»ä½•äººéƒ½å¯ä»¥æ”¹å…±äº«ï¼‰ï¼Œä¸è¦ç”¨å…±äº«å†…å­˜åšè¿›ç¨‹é—´é€šä¿¡ï¼Œgoé‡Œé¢ä¹Ÿæœ‰å…±äº«å†…å­˜çš„

- åœ¨å¥‡æ€ªè°ƒåº¦ä¸‹å‘ç”Ÿçš„å„ç§å¹¶å‘ bugs
  - æ¡ä»¶å˜é‡ï¼šbroadcast æ€§èƒ½ä½ï¼Œä¸ broadcast å®¹æ˜“é”™
  - ä¿¡å·é‡ï¼šåœ¨ç®¡ç†å¤šç§èµ„æºæ—¶å°±æ²¡é‚£ä¹ˆå¥½ç”¨äº†

------

æ—¢ç„¶ç”Ÿäº§è€…-æ¶ˆè´¹è€…èƒ½è§£å†³ç»å¤§éƒ¨åˆ†é—®é¢˜ï¼Œæä¾›ä¸€ä¸ª API ä¸å°±å¥½äº†ï¼Ÿ

- [producer-consumer.go](http://jyywiki.cn/pages/OS/2022/demos/producer-consumer.go)
  - ç¼“å­˜ä¸º 0 çš„ channel å¯ä»¥ç”¨æ¥åŒæ­¥ (å…ˆåˆ°è€…ç­‰å¾…)

```go
package main

import "fmt"

var stream = make(chan int, 10)
const n = 4

func produce() {
  for i := 0; ; i++ {
    fmt.Println("produce", i)
    stream <- i
  }
}

func consume() {
  for {
    x := <- stream
    fmt.Println("consume", x)
  }
}

func main() {
  for i := 0; i < n; i++ {
    go produce()
  }
  consume()
}

```

## ä¸‰ã€æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹

### 1ã€Web 2.0 æ—¶ä»£ (1999)

äººä¸äººä¹‹é—´è”ç³»æ›´åŠ ç´§å¯†çš„äº’è”ç½‘

- â€œUsers were encouraged to provide content, rather than just viewing it.â€
- ä½ ç”šè‡³å¯ä»¥æ‰¾åˆ°ä¸€äº› â€œWeb 3.0â€/Metaverse çš„çº¿ç´¢

------

æ˜¯ä»€ä¹ˆæˆå°±äº†ä»Šå¤©çš„ Web 2.0?

- æµè§ˆå™¨ä¸­çš„å¹¶å‘ç¼–ç¨‹ï¼šAjax (Asynchronous JavaScript + XML)
- HTML (DOM Tree) + CSS ä»£è¡¨äº†ä½ èƒ½çœ‹è§çš„ä¸€åˆ‡
  - é€šè¿‡ JavaScript å¯ä»¥æ”¹å˜å®ƒ
  - é€šè¿‡ JavaScript å¯ä»¥å»ºç«‹è¿æ¥æœ¬åœ°å’ŒæœåŠ¡å™¨
  - ä½ å°±æ‹¥æœ‰äº†å…¨ä¸–ç•Œï¼

### 2ã€äººæœºäº¤äº’ç¨‹åºï¼šç‰¹ç‚¹å’Œä¸»è¦æŒ‘æˆ˜

ç‰¹ç‚¹ï¼šä¸å¤ªå¤æ‚

- æ—¢æ²¡æœ‰å¤ªå¤šè®¡ç®—
  - DOM Tree ä¹Ÿä¸è‡³äºå¤ªå¤§ (å¤§äº†äººä¹Ÿçœ‹ä¸è¿‡æ¥)
  - DOM Tree æ€ä¹ˆç”»æµè§ˆå™¨å…¨å¸®æˆ‘ä»¬æå®šäº†
- ä¹Ÿæ²¡æœ‰å¤ªå¤š I/O
  - å°±æ˜¯ä¸€äº›ç½‘ç»œè¯·æ±‚

------

æŒ‘æˆ˜ï¼šç¨‹åºå‘˜å¤š

- é›¶åŸºç¡€çš„äººä½ è®©ä»–æ•´å…±äº«å†…å­˜ä¸Šçš„å¤šçº¿ç¨‹
- ææ€•æˆ‘ä»¬ç°åœ¨ç”¨çš„åˆ°å¤„éƒ½æ˜¯ bug å§ï¼Ÿï¼Ÿï¼Ÿ

### 3ã€å•çº¿ç¨‹ + äº‹ä»¶æ¨¡å‹

å°½å¯èƒ½å°‘ä½†åˆè¶³å¤Ÿçš„å¹¶å‘

- ä¸€ä¸ªçº¿ç¨‹ã€å…¨å±€çš„äº‹ä»¶é˜Ÿåˆ—ã€æŒ‰åºæ‰§è¡Œ (run-to-complete)
- è€—æ—¶çš„ API (Timer, Ajax, ...) è°ƒç”¨ä¼šç«‹å³è¿”å›
  - æ¡ä»¶æ»¡è¶³æ—¶å‘é˜Ÿåˆ—é‡Œå¢åŠ ä¸€ä¸ªäº‹ä»¶

```
$.ajax( { url: 'https://xxx.yyy.zzz/login',
  success: function(resp) {
    $.ajax( { url: 'https://xxx.yyy.zzz/cart',
      success: function(resp) {
        // do something
      },
      error: function(req, status, err) { ... }
    }
  },
  error: function(req, status, err) { ... }
);
```

### 4ã€å¼‚æ­¥äº‹ä»¶æ¨¡å‹

å¥½å¤„

- å¹¶å‘æ¨¡å‹ç®€å•äº†å¾ˆå¤š
  - å‡½æ•°çš„æ‰§è¡Œæ˜¯åŸå­çš„ (ä¸èƒ½å¹¶è¡Œï¼Œå‡å°‘äº†å¹¶å‘ bug çš„å¯èƒ½æ€§)
- API ä¾ç„¶å¯ä»¥å¹¶è¡Œ
  - é€‚åˆç½‘é¡µè¿™ç§ â€œå¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨æ¸²æŸ“å’Œç½‘ç»œè¯·æ±‚â€ çš„åœºæ™¯
    - JavaScript ä»£ç åªè´Ÿè´£ â€œæè¿°â€ DOM Tree

------

åå¤„

- Callback hell (ç¥–ä¼ å±å±±)
  - åˆšæ‰çš„ä»£ç åµŒå¥— 5 å±‚ï¼Œå¯ç»´æŠ¤æ€§å·²ç»æ¥è¿‘äºé›¶äº†

### 5ã€å¼‚æ­¥ç¼–ç¨‹ï¼šPromise

> å¯¼è‡´ callback hell çš„æœ¬è´¨ï¼šäººç±»è„‘è¢‹é‡Œæƒ³çš„æ˜¯ â€œæµç¨‹å›¾â€ï¼Œçœ‹åˆ°çš„æ˜¯ â€œå›è°ƒâ€ã€‚

The Promise object represents the *eventual completion* (or failure) of an asynchronous operation and its resulting value.

![img](./doc/promises.png)



Promise: æµç¨‹å›¾çš„æ„é€ æ–¹æ³• (Mozilla-MDN Docs)

### 6ã€Promise: æè¿° Workflow çš„ â€œåµŒå…¥å¼è¯­è¨€â€

Chaining

```
loadScript("/article/promise-chaining/one.js")
  .then( script => loadScript("/article/promise-chaining/two.js") )
  .then( script => loadScript("/article/promise-chaining/three.js") )
  .then( script => {
    // scripts are loaded, we can use functions declared there
  })
  .catch(err => { ... } );
```

------

Fork-join

```
a = new Promise( (resolve, reject) => { resolve('A') } )
b = new Promise( (resolve, reject) => { resolve('B') } )
c = new Promise( (resolve, reject) => { resolve('C') } )
Promise.all([a, b, c]).then( res => { console.log(res) } )
```

### 7ã€Async-Await: Even Better

async function

- æ€»æ˜¯è¿”å›ä¸€ä¸ª `Promise` object
- `async_func()` - fork

------

await promise

- `await promise` - join

------

```
A = async () => await $.ajax('/hello/a')
B = async () => await $.ajax('/hello/b')
C = async () => await $.ajax('/hello/c')
hello = async () => await Promise.all([A(), B(), C()])
hello()
  .then(window.alert)
  .catch(res => { console.log('fetch failed!') } )
```

## æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: ä»€ä¹ˆæ ·çš„ä»»åŠ¡æ˜¯éœ€è¦å¹¶è¡Œ/å¹¶å‘çš„ï¼Ÿå®ƒä»¬åº”è¯¥å¦‚ä½•å®ç°ï¼Ÿ

è®²äº†ä¸‰ç§çœŸæ­£çš„å¹¶å‘ç¨‹åºæ˜¯æ€ä¹ˆå†™çš„ï¼Œé«˜æ€§èƒ½è®¡ç®—æ³¨é‡çš„æ˜¯ä»»åŠ¡çš„åˆ†è§£ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼›æ•°æ®ä¸­å¿ƒï¼Œæ³¨é‡çš„å­˜å‚¨ï¼Œæ„å‘³ç€ç³»ç»Ÿè°ƒç”¨ï¼Œé€šè¿‡åç¨‹çº¿ç¨‹è§£å†³ï¼›å†™äººæœºäº¤äº’çš„å‰ç«¯ï¼Œæ³¨é‡çš„æ˜¯ä»£ç çš„ç»´æŠ¤æ€§ã€‚

éƒ½å¯ä»¥ç”¨çº¿ç¨‹æ¥å®ç°

------

Take-away message

- å¹¶å‘ç¼–ç¨‹çš„çœŸå®åº”ç”¨åœºæ™¯
  - é«˜æ€§èƒ½è®¡ç®— (æ³¨é‡ä»»åŠ¡åˆ†è§£): ç”Ÿäº§è€…-æ¶ˆè´¹è€… (MPI/OpenMP)
  - æ•°æ®ä¸­å¿ƒ (æ³¨é‡ç³»ç»Ÿè°ƒç”¨): çº¿ç¨‹-åç¨‹ (Goroutine)
  - äººæœºäº¤äº’ (æ³¨é‡æ˜“ç”¨æ€§): äº‹ä»¶-æµå›¾ (Promise)
- ç¼–ç¨‹å·¥å…·çš„å‘å±•çªé£çŒ›è¿›
  - è‡ª Web 2.0 ä»¥æ¥ï¼Œå¼€æºç¤¾åŒºæ”¹å˜äº†è®¡ç®—æœºç§‘å­¦çš„å­¦ä¹ æ–¹å¼
  - å¸Œæœ›æ¯ä¸ªåŒå­¦éƒ½æœ‰ä¸€ä¸ª â€œä¸»åŠ›ç°ä»£ç¼–ç¨‹è¯­è¨€â€
    - Modern C++, Rust, Javascript, ...