# çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹

## Overview

å¤ä¹ 

- å¹¶å‘ç¼–ç¨‹çš„åŸºæœ¬å·¥å…·ï¼šçº¿ç¨‹åº“ã€äº’æ–¥å’ŒåŒæ­¥

------

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: ä»€ä¹ˆæ ·çš„ä»»åŠ¡æ˜¯éœ€è¦å¹¶è¡Œ/å¹¶å‘çš„ï¼Ÿå®ƒä»¬åº”è¯¥å¦‚ä½•å®ç°ï¼Ÿ

------

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶å‘ç¼–ç¨‹
- æ•°æ®ä¸­å¿ƒé‡Œçš„å¹¶å‘ç¼–ç¨‹
- æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹

### ä¸€ã€é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶å‘ç¼–ç¨‹

### 1ã€é«˜æ€§èƒ½è®¡ç®—ç¨‹åºï¼šç‰¹ç‚¹

> â€œA technology that harnesses the power of supercomputers or computer clusters to solve complex problems requiring massive computation.â€ (IBM)

ä»¥è®¡ç®—ä¸ºä¸­å¿ƒ

- ç³»ç»Ÿæ¨¡æ‹Ÿï¼šå¤©æ°”é¢„æŠ¥ã€èƒ½æºã€åˆ†å­ç”Ÿç‰©å­¦
- äººå·¥æ™ºèƒ½ï¼šç¥ç»ç½‘ç»œè®­ç»ƒ
- çŸ¿å‚ï¼šçº¯ç²¹çš„ hash è®¡ç®—
- [HPC-China 100](http://www.hpc100.cn/top100/20/)

### 2ã€é«˜æ€§èƒ½è®¡ç®—ï¼šä¸»è¦æŒ‘æˆ˜

è®¡ç®—ä»»åŠ¡å¦‚ä½•åˆ†è§£

- è®¡ç®—å›¾éœ€è¦å®¹æ˜“å¹¶è¡ŒåŒ–
    - æœºå™¨-çº¿ç¨‹ä¸¤çº§ä»»åŠ¡åˆ†è§£
- ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³ä¸€åˆ‡
    - [MPI](https://hpc-tutorials.llnl.gov/mpi/) - â€œa specification for the developers and users of message passing librariesâ€, [OpenMP](https://www.openmp.org/) - â€œmulti-platform shared-memory parallel programming in C/C++ and Fortranâ€
- [Parallel and Distributed Computation: Numerical Methods](https://web.mit.edu/dimitrib/www/pdc.html)

çœŸæ­£æƒ³å­¦é«˜æ€§èƒ½è®¡ç®—çš„è¯ï¼Œçœ‹å®Œä¸Šé¢ğŸ‘†è¿™æœ¬ä¹¦å°±å¯ä»¥äº†

- å‘Šè¯‰äº†æˆ‘ä»¬æ€ä¹ˆå»æ±‚çº¿æ€§æ–¹ç¨‹ç»„ï¼Œçº¿æ€§è§„åˆ’è¿™ç±»é‡è¦çš„æ•°å­¦é—®é¢˜
- æ¨¡æ‹Ÿå®è§‚ä¸–ç•Œå°±æ˜¯æœ‰é™å…ƒï¼Œæ¨¡æ‹Ÿå¾®è§‚ä¸–ç•Œå°±æ˜¯é‡å­
- åœ¨è¶…çº§è®¡ç®—æœºé‡Œè§£å†³è¿™äº›é—®é¢˜çš„æ–¹æ³•å°±è¿™äº›

------

çº¿ç¨‹é—´å¦‚ä½•é€šä¿¡

- é€šä¿¡ä¸ä»…å‘ç”Ÿåœ¨èŠ‚ç‚¹/çº¿ç¨‹ä¹‹é—´ï¼Œè¿˜å‘ç”Ÿåœ¨ä»»ä½•å…±äº«å†…å­˜è®¿é—®
- è¿˜è®°å¾—è¢« [mem-ordering.c](http://jyywiki.cn/pages/OS/2022/demos/mem-ordering.c) æ”¯é…çš„ææƒ§å—ï¼Ÿ

---

é«˜æ€§èƒ½è®¡ç®—ä¸»è¦é ã€Œå¹¶è¡ŒåŒ–ã€ï¼Œèƒ½å¤Ÿå¹¶è¡ŒåŒ–çš„å‰ææ˜¯è¿™ä¸ªæ€»ä»»åŠ¡å¯ä»¥ã€Œåˆ†è§£ã€ï¼Œå­ä»»åŠ¡å„è‡ªç‹¬ç«‹çš„è·‘åœ¨çº¿ç¨‹ä¸­ï¼Œä¸è¿‡å­ä»»åŠ¡å¯èƒ½ä¹Ÿè¦è¿›è¡Œä¸€äº›äº¤äº’ï¼Œä¼šæ¶‰åŠçº¿ç¨‹é—´é€šä¿¡

### 3ã€ä¾‹å­ï¼šMandelbrot Set

![img](./doc/Mandelbrot.png)

- [mandelbrot.c](http://jyywiki.cn/pages/OS/2022/demos/mandelbrot.c) (embarrassingly parallel)

```c
#include "thread.h"
#include <math.h>

int NT;
#define W 6400
#define H 6400
#define IMG_FILE "mandelbrot.ppm"

static inline int belongs(int x, int y, int t) {
  return x / (W / NT) == t;
}

int x[W][H];
int volatile done = 0;

// ç”Ÿæˆå›¾ç‰‡çš„ç®—æ³• ppm
void display(FILE *fp, int step) { 
  static int rnd = 1;
  int w = W / step, h = H / step;
  // STFW: Portable Pixel Map
  fprintf(fp, "P6\n%d %d 255\n", w, h);
  for (int j = 0; j < H; j += step) {
    for (int i = 0; i < W; i += step) {
      int n = x[i][j];
      int r = 255 * pow((n - 80) / 800.0, 3);
      int g = 255 * pow((n - 80) / 800.0, 0.7);
      int b = 255 * pow((n - 80) / 800.0, 0.5);
      fputc(r, fp); fputc(g, fp); fputc(b, fp);
    }
  }
}

void Tworker(int tid) {
  for (int i = 0; i < W; i++)
    for (int j = 0; j < H; j++)
      if (belongs(i, j, tid - 1)) {
        double a = 0, b = 0, c, d;
        while ((c = a * a) + (d = b * b) < 4 && x[i][j]++ < 880) {
          b = 2 * a * b + j * 1024.0 / H * 8e-9 - 0.645411;
          a = c - d + i * 1024.0 / W * 8e-9 + 0.356888;
        }
      }
  done++;
}

void Tdisplay() {
  float ms = 0;
  while (1) {
    // FILE *fp = popen("viu -", "w"); assert(fp); // æ²¡è£…viuçš„è¯å¯ä»¥æ³¨æ‰
    // display(fp, W / 256);
    // pclose(fp);
    if (done == NT) break;
    usleep(1000000 / 5);
    ms += 1000.0 / 5;
  }
  printf("Approximate render time: %.1lfs\n", ms / 1000);

  FILE *fp = fopen(IMG_FILE, "w"); assert(fp);
  display(fp, 2);
  fclose(fp);
}

int main(int argc, char *argv[]) {
  assert(argc == 2);
  NT = atoi(argv[1]);
  for (int i = 0; i < NT; i++) {
    create(Tworker);
  }
  create(Tdisplay);
  join();
  return 0;
}

```

```bash
$ gcc mandelbrot.c -lpthread -lm -O2

# å¾—å®‰è£… viuï¼Œä¸è£…çš„è¯æ³¨é‡Šæ‰é‚£ä¸‰è¡Œ
$ ./a.out 4
Approximate render time: 8.2s

# å¯ä»¥è½¬æ ¼å¼æ‰“å¼€ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‰“å¼€ppm
$ convert mandelbrot.ppm a.jpg
$ open mandelbrot.ppm
```

![mandelbrot](./doc/mandelbrot-my.png)

