# çŠ¶æ€æœºæ¨¡å‹çš„åº”ç”¨

## Overview

å¤ä¹ 

- çŠ¶æ€æœºï¼šç†è®º
    - æ•°å­—ç”µè·¯ï¼š[logisim.c](http://jyywiki.cn/pages/OS/2022/demos/logisim.c) å’Œ [seven-seg.py](http://jyywiki.cn/pages/OS/2022/demos/seven-seg.py)
    - Model checker: ç†è§£å¹¶å‘ç¨‹åºæ‰§è¡Œçš„æ–°æ–¹æ³•
- çŠ¶æ€æœºï¼šå®è·µ
    - [thread-os.c](http://jyywiki.cn/pages/OS/2022/demos/thread-os.c)

------

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: çŠ¶æ€æœºæ¨¡å‹å¦‚æ­¤æœ‰ç”¨ï¼Œè¿˜èƒ½æ›´æœ‰ç”¨ä¸€ç‚¹å—ï¼Ÿ

------

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- ç»ˆäºåšå®Œäº†é“ºå«ï¼Œæ˜¯æ—¶å€™è®©ä½ æ„Ÿå—åˆ° â€œçœŸæ­£çš„åŠ›é‡â€ äº†
    - éƒ½æ˜¯æ²¡ç”¨çš„å†…å®¹ï¼Œå½“æˆ‘å£èƒ¡å°±è¡Œäº†

## ä¸€ã€çŠ¶æ€æœºï¼šç†è§£æˆ‘ä»¬çš„ä¸–ç•Œ

### 1ã€å“² â™‚ å­¦æ¢è®¨

æˆ‘ä»¬çš„ç‰©ç†ä¸–ç•Œæ˜¯ â€œç¡®å®šè§„åˆ™â€ çš„çŠ¶æ€æœºå—ï¼Ÿ

- å®è§‚ç‰©ç†ä¸–ç•Œè¿‘ä¼¼äº deterministic çš„çŠ¶æ€æœº (ç»å…¸åŠ›å­¦)
- å¾®è§‚ä¸–ç•Œå¯èƒ½æ˜¯ non-deterministic çš„ (é‡å­åŠ›å­¦)

------

æŠŠç‰©ç†ä¸–ç•Œå»ºæ¨¡æˆåŸºæœ¬ç²’å­çš„è¿åŠ¨

- [Conway's game of life](https://playgameoflife.com/)

å¯ä»¥åœ¨è¿™ä¸ªæ¨¡å‹ä¸Šä¸¥è‚ƒåœ°å®šä¹‰å¾ˆå¤šæ¦‚å¿µï¼šé¢„æµ‹æœªæ¥ã€æ—¶é—´æ—…è¡Œâ€¦â€¦

- æˆä¸ºä½ ç†è§£ç‰©ç† (å’Œè®¡ç®—æœº) ä¸–ç•Œçš„å‚è€ƒ

------

ä¾‹å­

- Cellular automata ä¸æ”¯æŒ â€œæ—¶é—´æ—…è¡Œâ€
  - æ€ä¹ˆæ·»åŠ ä¸€ä¸ªå…¬ç†ä½¿å®ƒå¯ä»¥æ”¯æŒï¼Ÿ
    - å¹³è¡Œå®‡å®™
    - å¦‚æœä¸–ç•Œçº¿éœ€è¦åˆå¹¶ï¼Ÿå¯ä»¥[æ”¶æ•›äºæŸä¸ªåˆ†å¸ƒ](https://www.scientificamerican.com/article/time-travel-simulation-resolves-grandfather-paradox/)
- Cellular automata ä¸æ”¯æŒ â€œé¢„æµ‹å¤–æ¥â€
  - èƒ½å¦æ·»åŠ ä¸€ä¸ª syscall ä½¿å®ƒæ”¯æŒï¼Ÿ
    - [Why philosophers should care about computational complexity, Ch. 10](https://www.scottaaronson.com/papers/philos.pdf)

### 2ã€çŠ¶æ€æœºæ¨¡å‹ï¼šç†è§£ç¼–è¯‘å™¨å’Œç°ä»£ CPU

ç¼–è¯‘å™¨ï¼šæºä»£ç  S (çŠ¶æ€æœº) â†’ äºŒè¿›åˆ¶ä»£ç  C (çŠ¶æ€æœº)C=compile(S)

ç¼–è¯‘ (ä¼˜åŒ–) çš„æ­£ç¡®æ€§ (Soundness):

- **S ä¸ C çš„å¯è§‚æµ‹è¡Œä¸ºä¸¥æ ¼ä¸€è‡´**
  - system calls; volatile variable loads/stores; termination

------

è¶…æ ‡é‡ (superscalar)/ä¹±åºæ‰§è¡Œå¤„ç†å™¨

- å…è®¸åœ¨çŠ¶æ€æœºä¸Š â€œè·³è·ƒâ€
- [ilp-demo.c](http://jyywiki.cn/pages/OS/2022/demos/ilp-demo.c)

```c
#include <stdio.h>
#include <time.h>

#define LOOP 1000000000ul

__attribute__((noinline)) void loop() {
  for (long i = 0; i < LOOP; i++) {
    asm volatile(
      "mov $1, %%rax;"
      "mov $1, %%rdi;"
      "mov $1, %%rsi;"
      "mov $1, %%rdx;"
      "mov $1, %%rcx;"
      "mov $1, %%r10;"
      "mov $1, %%r8;"
      "mov $1, %%r9;"
    :::"rax", "rdi", "rsi", "rdx", "rcx", "r10", "r8", "r9");
  }
}

int main() {
  clock_t st = clock();
  loop();
  clock_t ed = clock();
  double inst = LOOP * (8 + 2) / 1000000000;
  double ips = inst / ((ed - st) * 1.0 / CLOCKS_PER_SEC);
  printf("%.2lfG instructions/s\n", ips);
}
```

```bash
$ gcc -O2 a.c
$ ./a.out
11.88G instructions/s
```

## äºŒã€æŸ¥çœ‹çŠ¶æ€æœºæ‰§è¡Œ

### 1ã€Trace å’Œè°ƒè¯•å™¨

ç¨‹åºæ‰§è¡Œ = çŠ¶æ€æœºæ‰§è¡Œ

- æˆ‘ä»¬èƒ½ä¸èƒ½ â€œhackâ€ è¿›è¿™ä¸ªçŠ¶æ€æœº
  - è§‚å¯ŸçŠ¶æ€æœºçš„æ‰§è¡Œ
    - strace/gdb
  - ç”šè‡³**è®°å½•å’Œæ”¹å˜**çŠ¶æ€æœºçš„æ‰§è¡Œ

```bash
$ strace -T ./a.out |& vim -
```

-T æ˜¾ç¤ºç³»ç»Ÿè°ƒç”¨æ‰€èŠ±è´¹çš„æ—¶é—´

```bash
$ gcc -O2 a.c -g
$ gdb a.out
```

-g å¯ä»¥ gdb è°ƒè¯•çš„æ—¶å€™æ˜¾ç¤ºæºç 

### 2ã€åº”ç”¨ (1): Time-Travel Debugging

ç¨‹åºæ‰§è¡Œæ˜¯éšæ—¶é—´ â€œå‰è¿›â€ çš„ s0â†’s1â†’s2â†’â€¦

- èƒ½å¦åœ¨æ—¶é—´ä¸Š â€œåé€€â€ï¼Ÿ (time-travel)
  - ç»å¸¸ gdb ä¸å°å¿ƒ step è¿‡äº†ï¼Œä»å¤´å†æ¥â€¦â€¦
  - è®°å½•æ‰€æœ‰çš„ siï¼Œå°±èƒ½å®ç°ä»»æ„çš„ time-traveling

---

è®°å½•æ‰€æœ‰ si çš„å¼€é”€å¤ªå¤§ (si ç”±å†…å­˜ + å¯„å­˜å™¨ç»„æˆ)

- ä½†**ä¸€æ¡æŒ‡ä»¤çš„ side-effect é€šå¸¸æœ‰é™**
  - åªè®°å½•åˆå§‹çŠ¶æ€ï¼Œå’Œæ¯æ¡æŒ‡ä»¤å‰åçŠ¶æ€çš„ diff
  - s0,Î”0,Î”1,â€¦
  - æ­£å‘æ‰§è¡Œï¼šsi+1=si+Î”0
  - åå‘æ‰§è¡Œï¼šsi-1=sieÎ”0-1

---

gdb çš„éšè—åŠŸèƒ½ (å¤§å®¶è¯»è¿‡ gdb çš„æ‰‹å†Œäº†å—ï¼Ÿ)

- `record full` - å¼€å§‹è®°å½•
- `record stop` - ç»“æŸè®°å½•
- `reverse-step`/`reverse-stepi` - â€œæ—¶é—´æ—…è¡Œè°ƒè¯•â€

------

ä¾‹å­ï¼šè°ƒè¯• [rdrand.c](http://jyywiki.cn/pages/OS/2022/demos/rdrand.c)

- Reverse execution ä¸æ˜¯ä¸‡èƒ½çš„
  - æœ‰äº›å¤æ‚çš„æŒ‡ä»¤ (syscall) æ— æ³•ä¿è¯

rdrand.c

```c
#include <stdio.h>
#include <stdint.h>

int main() {
  uint64_t val = 123123;
  asm volatile ("rdrand %0": "=r"(val));
  printf("rdrand returns %016lx\n", val);
}
```

è°ƒè¯•çš„æ—¶å€™ä¸å°å¿ƒèµ°è¿‡æ¥ï¼Œæƒ³å›å»å¤ç°åŸæ¥çš„bugï¼Œ

```bash
$ gcc rdrand.c -O1 -g && ./a.out
rdrand returns b82ec1965e5274dd

$ gdb a.out

(gdb) layout split
(gdb) start
(gdb) record full
(gdb) s
(gdb) p val
$1 = 123123

(gdb) si
(gdb) rsi
main () at a.c:6
(gdb) p val
$2 = 123123
```

- `record full` åœ¨ gdb ä¸­æ‰“å¼€è®°å½•æ¨¡å¼

### 3ã€åº”ç”¨ (2): Record & Replay

åœ¨ç¨‹åºæ‰§è¡Œæ—¶è®°å½•ä¿¡æ¯ï¼Œç»“æŸåé‡ç°ç¨‹åºçš„è¡Œä¸º

- ç¡®å®šçš„ç¨‹åºä¸éœ€è¦ä»»ä½•è®°å½•
  - å‡è®¾s0æ‰§è¡Œ 1,000,000 æ¡ç¡®å®šçš„æŒ‡ä»¤åå¾—åˆ°sâ€²
    - é‚£ä¹ˆåªè¦è®°å½• s0 å’Œ 1,000,000
    - å°±èƒ½é€šè¿‡ â€œå†æ‰§è¡Œä¸€æ¬¡â€ æ¨å¯¼å‡º 

---

Record & Replay: åªéœ€è®°å½• non-deterministic çš„æŒ‡ä»¤çš„æ•ˆæœ

- (å•çº¿ç¨‹) åº”ç”¨ç¨‹åº
  - syscall, rdrand, rdtsc, ...
  - rr (Mozilla)
    - [To catch a failure: The record-and-replay approach to debugging](http://jyywiki.cn/OS/2022/slides/10.slides) (CACM'20)
- (å•å¤„ç†å™¨) æ“ä½œç³»ç»Ÿ
  - mmio, in, out, rdrand, rdtsc, ä¸­æ–­, ...
  - QEMU (-icount shift=auto,rr=record,rrfile=replay.bin)
    - [ReVirt: Enabling intrusion analysis through virtual-machine logging and replay](http://jyywiki.cn/OS/2022/slides/10.slides) (OSDI'02, Best Paper ğŸ…)

```bash
$ rr record -n ./a.out
```

## ä¸‰ã€é‡‡æ ·çŠ¶æ€æœºæ‰§è¡Œ

### 1ã€å…³äºæ€§èƒ½ä¼˜åŒ–

> Premature optimization is the root of all evil. (D. E. Knuth)

é‚£åˆ°åº•æ€ä¹ˆæ ·æ‰ç®— mature å‘¢ï¼Ÿ

- çŠ¶æ€æœºçš„æ‰§è¡Œéœ€è¦æ—¶é—´ï¼›å¯¹è±¡éœ€è¦å ç”¨ç©ºé—´
- éœ€è¦ç†è§£å¥½ â€œæ—¶é—´èŠ±åœ¨å“ªé‡Œâ€ã€â€œä»€ä¹ˆå¯¹è±¡å ç”¨äº†ç©ºé—´â€

æˆ‘ä»¬éœ€è¦çœŸå®æ‰§è¡Œçš„**æ€§èƒ½æ‘˜è¦**ï¼

- æœ¬è´¨çš„å›ç­”ï¼šâ€œä¸ºäº†åšæŸä»¶äº‹åˆ°åº•èŠ±å»äº†å¤šå°‘èµ„æºâ€
- ç®€åŒ–çš„å›ç­”ï¼šâ€œä¸€æ®µæ—¶é—´å†…èµ„æºçš„æ¶ˆè€—æƒ…å†µâ€

### 2ã€Profiler å’Œæ€§èƒ½æ‘˜è¦

> æ€§èƒ½æ‘˜è¦éœ€è¦å¯¹ç¨‹åºæ‰§è¡Œæ€§èƒ½å½±å“æœ€å°ï¼Œå¾€å¾€ä¸éœ€è¦ full traceã€‚

éš”ä¸€æ®µæ—¶é—´ â€œæš‚åœâ€ ç¨‹åºã€è§‚å¯ŸçŠ¶æ€æœºçš„æ‰§è¡Œ

- ä¸­æ–­å°±å¯ä»¥åšåˆ°
- å°†çŠ¶æ€ sâ†’sâ€² â€œè®°è´¦â€
    - æ‰§è¡Œçš„è¯­å¥
    - å‡½æ•°è°ƒç”¨æ ˆ
    - æœåŠ¡çš„è¯·æ±‚
- å¾—åˆ°ç»Ÿè®¡æ„ä¹‰çš„æ€§èƒ½æ‘˜è¦

------

ä¾‹å­ï¼šLinux Kernel perf (æ”¯æŒç¡¬ä»¶ PMU) - [ilp-demo.c](http://jyywiki.cn/pages/OS/2022/demos/ilp-demo.c)

- perf list, perf stat (-e), perf record, perf report

```c
#include <stdio.h>
#include <time.h>

#define LOOP 1000000000ul

__attribute__((noinline)) void loop() {
  for (long i = 0; i < LOOP; i++) {
    asm volatile(
      "mov $1, %%rax;"
      "mov $1, %%rdi;"
      "mov $1, %%rsi;"
      "mov $1, %%rdx;"
      "mov $1, %%rcx;"
      "mov $1, %%r10;"
      "mov $1, %%r8;"
      "mov $1, %%r9;"
    :::"rax", "rdi", "rsi", "rdx", "rcx", "r10", "r8", "r9");
  }
}

int main() {
  clock_t st = clock();
  loop();
  clock_t ed = clock();
  double inst = LOOP * (8 + 2) / 1000000000;
  double ips = inst / ((ed - st) * 1.0 / CLOCKS_PER_SEC);
  printf("%.2lfG instructions/s\n", ips);
}
```

```bash
$ gcc -O2 a.c -g
$ perf stat a.out
```

### 3ã€å®é™…ä¸­çš„æ€§èƒ½ä¼˜åŒ–

ä½ ä»¬é‡åˆ°çš„å¤§éƒ¨åˆ†æƒ…å†µ

- äºŒå…«å®šå¾‹ï¼š80% çš„æ—¶é—´æ¶ˆè€—åœ¨éå¸¸é›†ä¸­çš„å‡ å¤„ä»£ç 
- L1 (pmm): å°å†…å­˜åˆ†é…æ—¶çš„ lock contention
    - profiler ç›´æ¥å¸®ä½ è§£å†³é—®é¢˜

------

å·¥ä¸šç•Œé‡åˆ°çš„å¤§éƒ¨åˆ†æƒ…å†µ

- æœ¨æ¡¶æ•ˆåº”ï¼šæ¯ä¸ªéƒ¨åˆ†éƒ½å·²ç» tune åˆ°å±€éƒ¨æœ€ä¼˜äº†
    - å‰©ä¸‹çš„éƒ¨åˆ†è¦ä¹ˆ profiler ä¿¡æ¯ä¸å®Œæ•´ï¼Œè¦ä¹ˆå°±ä¸å¥½è§£å†³
    - (å·¥ç¨‹å¸ˆæ•´å¤©éƒ½å¯¹ç€ profiler çœ‹å¾—å¤´éƒ½å¤§äº†)
    - [The flame graph](https://cacm.acm.org/magazines/2016/6/202665-the-flame-graph/fulltext) (CACM'16)

## å››ã€Model Checker/Verifier

### 1ã€Model Checker çš„å¨åŠ›å¤§å®¶å·²ç»çŸ¥é“äº†

150 è¡Œä»£ç çš„ [model-checker.py](http://jyywiki.cn/pages/OS/2022/demos/model-checker.py)

- è¯å®Œæ‰€æœ‰ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾ä¸Šæ¶‰åŠçš„å¹¶å‘ç¨‹åº
- å¤ç° OSTEP æ•™ç§‘ä¹¦ä¸Šçš„å¹¶å‘ bug (æ¡ä»¶å˜é‡é”™è¯¯å”¤é†’)

------

ä¸€äº›çœŸæ­£çš„ model checkers

- [TLA+](https://lamport.azurewebsites.net/tla/tla.html) by Leslie Lamport; 
- [Java PathFinder (JFP)](https://ti.arc.nasa.gov/tech/rse/vandv/jpf/) å’Œ [SPIN](http://spinroot.com/)
    - å®ƒä»¬éƒ½å–œæ¬¢ç”¨ Peterson ç®—æ³•åš tutorial ğŸ˜

### 2ã€Model Checker: ä¸ä»…æ˜¯å¹¶å‘

ä»»ä½• â€œnon-deterministicâ€ çš„çŠ¶æ€æœºéƒ½å¯ä»¥æ£€æŸ¥ï¼Œå³ä¾¿æ˜¯å•çº¿ç¨‹çš„

```
u32 x = rdrand();
u32 y = rdrand();
if (x > y)
  if (x * x + y * y == 65)
    bug();
...
assert(ptr); // å¯èƒ½ç©ºæŒ‡é’ˆå—ï¼Ÿ
```

------

æ›´é«˜æ•ˆçš„ Model Checker: â€œå°†ç›¸ä¼¼çŠ¶æ€åˆå¹¶â€

- [KLEE: Unassisted and automatic generation of high-coverage tests for complex systems programs](https://dl.acm.org/doi/10.5555/1855741.1855756) (OSDI'08, Best Paper ğŸ…)
- åŸºäº LLVM bitcode è§£é‡Šå™¨å®ç°

## æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: çŠ¶æ€æœºçš„è§†è§’ç»™äº†æˆ‘ä»¬ä»€ä¹ˆï¼Ÿ

------

Take-away messages

- ç¼–ç¨‹ (çŠ¶æ€æœº) å°±æ˜¯å…¨ä¸–ç•Œ
- çŠ¶æ€æœºå¯ä»¥å¸®æˆ‘ä»¬
    - å»ºç«‹ç‰©ç†ä¸–ç•Œçš„å…¬ç†ä½“ç³»
    - ç†è§£è°ƒè¯•å™¨ã€Trace, profiler
    - è‡ªåŠ¨åˆ†æç¨‹åºçš„æ‰§è¡Œ (model checker)