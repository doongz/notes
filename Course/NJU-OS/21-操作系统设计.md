# æ“ä½œç³»ç»Ÿè®¾è®¡

## Overview

å¤ä¹ 

- æ“ä½œç³»ç»Ÿè®¾è®¡ï¼šä¸€ç»„å¯¹è±¡ + è®¿é—®å¯¹è±¡çš„ API
- æ“ä½œç³»ç»Ÿå®ç°ï¼šä¸€ä¸ª C ç¨‹åºå®ç°ä¸Šé¢çš„è®¾è®¡

------

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: æ“ä½œç³»ç»Ÿåˆ°åº•åº”è¯¥æä¾›ä»€ä¹ˆå¯¹è±¡å’Œ APIï¼Ÿ

------

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- Micro/Exo/Unikernel

## ä¸€ã€æ“ä½œç³»ç»Ÿé‡Œåˆ°åº•è¯¥æœ‰ä»€ä¹ˆï¼Ÿ

### 1ã€2022.4.25 å°å­¦ç”Ÿåˆå‡ºæ–°äº§å“äº†

è¿™æ¬¡æ”¯æŒäº†åˆ†é¡µå’Œå›¾å½¢ç•Œé¢ (ä¼¼ä¹æ˜¯æ¬è¿äº†ä¸€äº›ç´ æï¼Ÿ)

- L2: tty å’Œ fb é©±åŠ¨ (tty æ˜¯é€åƒç´ ç»˜åˆ¶çš„)
- L3: 9 ä¸ªç³»ç»Ÿè°ƒç”¨ (kputc, fork, wait, exit, kill, mmap, ...)

### 2ã€è«è¦æ…Œï¼šä½ ä»¬æ˜¯å¤§å­¦ç”Ÿå•Š ğŸ˜‚

![img](http://jyywiki.cn/pages/OS/img/eager-for-power.jpg)

### 3ã€ä¸Šè¯¾è°ˆçš„ä¸èƒ½ç§°ä¸ºçœŸæ­£çš„ â€œæ“ä½œç³»ç»Ÿâ€

å‘æ‰¬å¤§å­¦ç”Ÿ RTFM & RTFSC çš„å…‰è£ä¼ ç»Ÿ

- èƒ½å¤Ÿæ„è¯†åˆ°è¿™ä¸€ç‚¹çš„ä¸­/å°å­¦ç”Ÿå°±èƒ½æˆä¸ºé¡¶çº§çš„ç¨‹åºå‘˜

------

[The Open Group Base Specifications Issue 7 (2018 Ed.)](https://pubs.opengroup.org/onlinepubs/9699919799/mindex.html)

- XBD: Base Definitions
- XSH: System Interfaces
- XCU: Shell & Utilities
- XRAT: Rationale
    - è¿™æ˜¯éå¸¸å…³é”®çš„ï¼šä¸ä»…å‘Šè¯‰ â€œæ˜¯ä»€ä¹ˆâ€ï¼Œè¿˜æœ‰ â€œä¸ºä»€ä¹ˆâ€

------

[Windows API Index](https://docs.microsoft.com/en-us/windows/win32/apiindex/windows-api-list)

- å’Œ POSIX ç›¸å½“ä¸åŒçš„ä¸€ç»„è®¾è®¡
- â€œå·¥ä¸šâ€ v.s. â€œé»‘å®¢â€ (PowerShell v.s. bash)

### 4ã€å†°å±±çš„ä¸€è§’

API æ„å‘³ç€å¯ä»¥äº’ç›¸æ¨¡æ‹Ÿ

- Windows Subsystem for Linux (WSL)ï¼Œå¤§å®¶éƒ½åœ¨ç”¨
  - WSL1: ç›´æ¥ç”¨ Windows åŠ è½½ ELF æ–‡ä»¶
  - WSL2: è™šæ‹Ÿæœº
- Linux Subsystem for Windows (Wine)

![img](http://jyywiki.cn/pages/OS/img/wined3.jpg)

æ“ä½œç³»ç»Ÿé»˜é»˜å¸®ä½ æ‰¿è½½äº†æ›´å¤š

- [Operating system transactions](https://dl.acm.org/doi/abs/10.1145/1629575.1629591)(SOSP'09)
  - åœ¨ Linux 2.6.22 ä¸Šå®ç°
  - å¯¹ Kernel ç ´åæ€§å¤ªå¤§ï¼Œä¸å¤ªå¯èƒ½ç»´æŠ¤å¾—ä¸‹å»
- [Windows KTM](https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/when-to-use-kernel-mode-ktm), since Windows Vista (2007)
  - å¯¹ï¼Œä½ æ²¡çœ‹é”™ï¼Œæ˜¯ Windows Vista
  - ä¸–ç•Œæœ€å¼ºã€éª‚å£°æœ€å¤§ï¼Œæ‚„ç„¶è½å¹•

### 5ã€å°ç»“ï¼šæ“ä½œç³»ç»Ÿè®¾è®¡

æ“ä½œç³»ç»Ÿ = å¯¹è±¡ + API

- æ‰¿è½½äº†è½¯ä»¶çš„ â€œä¸€åˆ‡éœ€è¦â€
- [ä¸­å›½æµ·å†›èˆªæ¯å®£ä¼ ç‰‡](https://www.bilibili.com/video/BV1aY411P7e1)

### 6ã€å¦‚ä½•è¿ˆå‡ºèµ°å‘æ“ä½œç³»ç»Ÿçš„ç¬¬ä¸€æ­¥ï¼Ÿ

ç†è§£è€ç³»ç»Ÿæ˜¯å¦‚ä½•å®ç°ã€é‡åˆ°æ€æ ·çš„é—®é¢˜

- xv6; å¶å°”è®²ä¸€äº›æ–°ç‰¹æ€§
- ç„¶åï¼šRTFM, RTFSC

## äºŒã€Microkernel

### 1ã€Less is More

> å…¬ç†ï¼šæ²¡æœ‰å®Œç¾çš„ç¨‹åºå‘˜ã€‚
>
> æ¨è®ºï¼š**è¶Šå°çš„ç³»ç»Ÿï¼Œé”™è¯¯å°±è¶Šå°‘ã€‚**

C ä½œä¸ºä¸€ä¸ªæœ‰ Undefined Behavior çš„è¯­è¨€ï¼Œæ˜¯å¤æ‚ç³»ç»Ÿçš„ç¾éš¾

- Signed integer overflow (Linux Kernel ä½¿ç”¨äº† -fwrapv)
- Data race
- Memory error
  - libpng é«˜å±æ¼æ´ (ä¸€å¼ å›¾å·èµ°ä½ çš„å¯†ç )
    - æ•´æ•°æº¢å‡ºåç©ºæ ¼ keyword è¯»å–è¿›ç¨‹æ•°æ®

------

Microkernel (å¾®å†…æ ¸) åº”è¿è€Œç”Ÿ

- **æŠŠå°½å¯èƒ½å¤šçš„åŠŸèƒ½éƒ½ç”¨æ™®é€šè¿›ç¨‹å®ç°** (å¤±æ•ˆéš”ç¦»åœ¨ â€œè¿›ç¨‹â€ çº§)

### 2ã€è¯•ç€ç”¨æ™®é€šè¿›ç¨‹åšæ›´å¤šçš„äº‹

[sh-xv6.c](http://jyywiki.cn/pages/OS/2022/demos/sh-xv6.c) åˆ°åº•æ‰§è¡Œäº†å“ªäº› â€œå°±ç®—ä¸¢ç»™å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿˜å¾—è¯·æ±‚æ“ä½œç³»ç»Ÿâ€ çš„æ“ä½œï¼Ÿ

- è¿›ç¨‹ (çŠ¶æ€æœº) ç®¡ç†ä¼¼ä¹ç»•ä¸å¼€
  - fork/spawn; exit
- åŠ è½½å™¨ [loader-static.c](http://jyywiki.cn/pages/OS/2022/demos/loader-static.c)(execve) ä¼¼ä¹ä¸å¿…è¦
  - mmap ä¼¼ä¹ç»•ä¸å¼€
- ç»ˆç«¯ (tty) å¯ä»¥æ”¾åœ¨è¿›ç¨‹é‡Œ
  - è®© â€œé©±åŠ¨è¿›ç¨‹â€ èƒ½è®¿é—® memory-mapped register å°±è¡Œ
  - æˆ–è€…æä¾›ä¸€ä¸ª mmio ç³»ç»Ÿè°ƒç”¨
- æ–‡ä»¶ç³»ç»Ÿ (open, close, read, write, ...)
  - è¿›ç¨‹åªè¦æœ‰è®¿é—®ç£ç›˜çš„æƒé™ï¼Œåœ¨ç£ç›˜ä¸Šåšä¸ªæ•°æ®ç»“æ„ä¸æˆé—®é¢˜

### 3ã€Microkernel (å¾®å†…æ ¸)

![img](./doc/microkernel.jpg)

------

å¾®å†…æ ¸ (microkernel)

- åªæŠŠ â€œä¸èƒ½æ”¾åœ¨ç”¨æˆ·æ€â€ çš„ä¸œè¥¿ç•™åœ¨å†…æ ¸é‡Œ
  - çŠ¶æ€æœº (æ‹¥æœ‰å¯„å­˜å™¨å’Œåœ°å€ç©ºé—´çš„æ‰§è¡Œæµ)
  - çŠ¶æ€æœºä¹‹é—´çš„åä½œæœºåˆ¶ (è¿›ç¨‹é—´é€šä¿¡)
  - æƒé™ç®¡ç† (ä¾‹å¦‚è®¾å¤‡è®¿é—®)
- èµ‹äºˆè¿›ç¨‹æœ€å°‘çš„æƒé™ï¼Œå°±èƒ½é™ä½é”™è¯¯å¸¦æ¥çš„å½±å“

### 4ã€Minix: å¦ä¸€ä¸ªæ”¹å˜ä¸–ç•Œçš„æ“ä½œç³»ç»Ÿ

Minix: å®Œå…¨ç”¨äºæ•™å­¦çš„çœŸå®æ“ä½œç³»ç»Ÿ

- by Andrew S. Tanenbaum

------

å¹´è½»äººçš„ç¬¬ä¸€ä¸ª â€œå…¨åŠŸèƒ½â€ æ“ä½œç³»ç»Ÿ

- Minix1 (1987): UNIXv7 å…¼å®¹
  - Linus å®ç° Linux çš„èµ·ç‚¹
- [Minix2](http://download.minix3.org/previous-versions/Intel-2.0.4/)(1997): POSIX å…¼å®¹
  - æ›´åŠ å®Œå¤‡çš„ç³»ç»Ÿï¼Œä¹¦åé™„å…¨éƒ¨å†…æ ¸ä»£ç 

![img](./doc/minix3-desktop.png)

- [Minix3](http://minix3.org/)(2006): POSIX/NetBSD å…¼å®¹
  - ä¸€åº¦æ˜¯ä¸–ç•Œä¸Šåº”ç”¨æœ€å¹¿çš„æ“ä½œç³»ç»Ÿ
    - Intel ME äººæ‰‹ä¸€ä¸ª

### 5ã€Minix3 Architecture

![img](./doc/minixarch.png)

- Minix2 æ›´æç«¯ä¸€äº›ï¼Œåªæœ‰ send å’Œ receive ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨
  - ä¸»è¦ç”¨æ¥å®ç° RPC (remote procedure call)
  - æ“ä½œç³»ç»Ÿè¿˜æ˜¯æ“ä½œç³»ç»Ÿï¼Œä½†è·¨æ¨¡å—è°ƒç”¨ä¼šè·¨è¶Šè¿›ç¨‹è¾¹

### 6ã€å†å‘å‰èµ°ä¸€å°æ­¥

å¬è¯´ â€œå¾®å†…æ ¸â€ æœ‰æ›´å¥½çš„å¯é æ€§ï¼Ÿ

- é‚£æˆ‘ä»¬èƒ½ä¸èƒ½è¯æ˜å®ƒçœŸçš„ â€œååˆ†å¯é â€ï¼Ÿ
  - å¯¹äºä»»ä½•è¾“å…¥ã€ä»»ä½•æ‰§è¡Œè·¯å¾„
  - æ²¡æœ‰ memory error
  - ä¸ä¼š crashâ€¦â€¦

seL4

- ä¸–ç•Œä¸Šç¬¬ä¸€ä¸ª verified micorkernel
  - [Whitepaper](https://sel4.systems/About/seL4-whitepaper.pdf) (åˆå­¦è€…å‹å¥½ï¼Œååˆ†æ¨è)
  - [Comprehensive formal verification of an OS microkernel](https://dl.acm.org/doi/10.1145/2560537) (TOCS'14)
- æœ‰ä¸€ä¸ªéå¸¸ä¼˜é›…çš„ capability æœºåˆ¶

 ### 7ã€seL4 è¯æ˜æ€è·¯

é¦–å…ˆï¼Œç”¨é€‚åˆæè¿°è¡Œä¸ºçš„è¯­è¨€å»ºä¸€ä¸ªæ¨¡å‹ (seL4 æœ‰ä¸¤å±‚æ¨¡å‹)

```python
def rr_sched(cpu):
    cpu.threads = cpu.threads[1:] + cpu.threads[:1]
    assert anything_you_need
    return cpu.threads[0]
```

å†å†™ä¸€ä»½ C ä»£ç 

- [thread-os.c](http://jyywiki.cn/pages/OS/2022/demos/thread-os.c)
  - æˆ‘ä»¬å°±æœ‰äº†ä¸¤ä¸ªçŠ¶æ€æœº (Python å’Œ C ä»£ç çš„å½¢å¼è¯­ä¹‰)

å°±å¯ä»¥å»è¯æ˜æ“ä½œç³»ç»Ÿçš„ functional correctness å•¦ï¼

- **è¯æ˜ä¸¤ä¸ªæ•°å­¦å¯¹è±¡ (çŠ¶æ€æœº) å¯è§‚æµ‹è¡Œä¸ºçš„ç­‰ä»·æ€§**
- å‰©ä¸‹å°±æ˜¯å»è§£å†³é‡åˆ°çš„å„ç§æŠ€æœ¯é—®é¢˜ (æ›´é‡è¦çš„æ˜¯**æ•¢ä¸æ•¢å»åš**)
  - Non-trivial; ä½†ä¹Ÿä¸æ˜¯ â€œç¥æ¥ä¹‹ç¬”â€ (incremental work)

## ä¸‰ã€æˆ‘ä»¬ç½®èº«çš„æ—¶ä»£

### 1ã€Linus å’Œ Andy çš„æ¿€çƒˆè®ºæˆ˜ (1992)

â€œ[Linux is obsolete](https://www.oreilly.com/openbook/opensources/book/appa.html)â€

- ä¸»è¦æ‰¹è¯„å†…æ ¸æ¶æ„è®¾è®¡ä¸åˆç†ã€ç§»æ¤æ€§é—®é¢˜
- 30 å¹´è¿‡å»äº†ï¼Œè®¸å¤šé—®é¢˜å¾—åˆ°äº†è§£å†³ï¼›è®¸å¤šè¿˜æ²¡æœ‰

![img](./doc/ken-quote.png)

### 2ã€Exokernel

> â€œThe essential observation about abstractions in traditional operating systems is that they are overly general.â€

æ“ä½œç³»ç»Ÿå°±ä¸åº”è¯¥æœ‰ä»»ä½•ç­–ç•¥

- åªåº”è¯¥ç®¡ç¡¬ä»¶èµ„æºçš„æœ€å°è™šæ‹ŸåŒ–
- Expose allocation, expose names, expose revocation
  - å†…æ ¸é‡Œç”šè‡³è¿ â€œè¿›ç¨‹â€ çš„æ¦‚å¿µéƒ½æ²¡æœ‰ï¼Œåªæœ‰æ—¶é—´ç‰‡
    - è°ƒåº¦ç­–ç•¥å®Œå…¨åœ¨ libOS ä¸­å®ç°
- [Exokernel: An operating system architecture for application-level resource management](https://dl.acm.org/doi/abs/10.1145/224057.224076) (SOSP'95)

### 3ã€Unikernel: libOS çš„å¤æ´»

ä»Šå¤©æˆ‘ä»¬æœ‰è™šæ‹Ÿæœº (å’Œç¡¬ä»¶è™šæ‹ŸåŒ–) äº†

- ä¸ºä»€ä¹ˆä¸ç›´æ¥è®© Lab2 è·‘åº”ç”¨ç¨‹åºå‘¢ï¼Ÿ
  - åº”ç”¨ä»£ç ç›´æ¥å’Œ klib, AbstractMachine, Lab ä»£ç é™æ€é“¾æ¥
  - ä»»ä½•æ“ä½œ (åŒ…æ‹¬ I/O) éƒ½å¯ä»¥ç›´æ¥åš

------

Unikernel: å†…æ ¸å¯ä»¥éå¸¸å° (åº”ç”¨ä¸éœ€è¦çš„ç‰¹æ€§éƒ½ç›´æ¥åˆ é™¤)

- [includeOS](https://www.includeos.org/) (C++); [runtime.js](http://runtimejs.org/) (JavaScript); [Mirage](https://mirage.io/) (OCaml)
- [Unikernels: The rise of the virtual library operating system](https://dl.acm.org/doi/10.1145/2541883.2541895) (CACM'14)
- [Unikraft: Fast, specialized unikernels the easy way](https://dl.acm.org/doi/10.1145/3447786.3456248) (EuroSys'21, Best Paper Award ğŸ…)

## æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: æ“ä½œç³»ç»Ÿåˆ°åº•åº”è¯¥æä¾›ä»€ä¹ˆå¯¹è±¡å’Œ APIï¼Ÿ

------

Take-away messages

- â€œæ“ä½œç³»ç»Ÿâ€ çš„å«ä¹‰éšåº”ç”¨è€Œå˜
  - å¯ä»¥å¤§è€Œå…¨ (Linux/Windows API)
  - å¯ä»¥åªæœ‰æœ€å°‘çš„ç¡¬ä»¶æŠ½è±¡ (Microkernel)
  - å¯ä»¥æ²¡æœ‰ç”¨æˆ·æ€ (Unikernel)
- äº’è”ç½‘æ—¶ä»£
  - ä»äº•é‡Œèµ°å‡ºå»ï¼šRTFM, RTFSC
  - ç„¶åå»æ”¹å˜è¿™ä¸ªä¸–ç•Œ