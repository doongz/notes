# C æ ‡å‡†åº“çš„å®ç°

## Overview

å¤ä¹ 

- [sh-xv6.c](http://jyywiki.cn/pages/OS/2022/demos/sh-xv6.c): ä»…ä¾èµ–ç³»ç»Ÿè°ƒç”¨çš„ â€œæœ€å°â€ å‘½ä»¤è¡Œ Shell

------

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: å¦‚ä½•åœ¨ç³»ç»Ÿè°ƒç”¨ä¹‹ä¸Šæ„å»ºç¨‹åºèƒ½å¤Ÿæ™®éå—æƒ çš„æ ‡å‡†åº“ï¼Ÿ

------

æœ¬æ¬¡è¯¾ä¸»è¦å†…å®¹

- C æ ‡å‡†åº“è®¾è®¡ä¸å®ç°
- åŸºäº libc çš„åº”ç”¨ç¨‹åº

## ä¸€ã€ç†Ÿæ‚‰åˆé™Œç”Ÿçš„ libc

### 1ã€ä¸ºä»€ä¹ˆéœ€è¦ libc?

â€œè£¸å¥”â€ ç¼–ç¨‹ï¼šèƒ½ç”¨ (è€Œä¸”ç»å¯¹å¤Ÿç”¨)ï¼Œä½†ä¸å¥½ç”¨

```c
long syscall(int num, ...) {
  va_list ap;
  va_start(ap, num);
  register long a0 asm ("rax") = num;
  register long a1 asm ("rdi") = va_arg(ap, long);
  register long a2 asm ("rsi") = va_arg(ap, long);
  register long a3 asm ("rdx") = va_arg(ap, long);
  register long a4 asm ("r10") = va_arg(ap, long);
  va_end(ap);
  asm volatile("syscall"
    : "+r"(a0) : "r"(a1), "r"(a2), "r"(a3), "r"(a4)
    : "memory", "rcx", "r8", "r9", "r11");
  return a0;
}
```

### 2ã€ä»»ä½•ç¨‹åºéƒ½ç”¨å¾—ä¸Šçš„å®šä¹‰

[Freestanding ç¯å¢ƒ](https://en.cppreference.com/w/cpp/freestanding)ä¸‹ä¹Ÿå¯ä»¥ä½¿ç”¨çš„å®šä¹‰

- [stddef.h](https://www.cplusplus.com/reference/cstddef/) - `size_t`
- [stdint.h](https://www.cplusplus.com/reference/cstdint/) - `int32_t`, `uint64_t`
- [stdbool.h](https://www.cplusplus.com/reference/cstdbool/) - `bool`, `true`, `false`
- [float.h](https://www.cplusplus.com/reference/cfloat/)
- [limits.h](https://www.cplusplus.com/reference/climits/)
- [stdarg.h](https://www.cplusplus.com/reference/cstdarg/)
    - syscall å°±ç”¨åˆ°äº† (ä½† syscall0, syscall1, ... æ›´é«˜æ•ˆ)
- [inttypes.h](https://www.cplusplus.com/reference/cinttypes/)
    - å›ç­”äº†ä½ å¤šå¹´æ¥çš„ç–‘é—®ï¼
    - åœ¨ä½ è¯»è¿‡äº†å°ç™½é˜¶æ®µä»¥åï¼Œå°±çœŸçš„æ˜¯ friendly manual äº†

### 3ã€ç„¶åï¼Œç³»ç»Ÿè°ƒç”¨ä¹Ÿè¦ç”¨å¾—æ–¹ä¾¿ï¼

> ç³»ç»Ÿè°ƒç”¨æ˜¯æ“ä½œç³»ç»Ÿ â€œç´§å‡‘â€ çš„æœ€å°æ¥å£ã€‚å¹¶ä¸æ˜¯æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨éƒ½åƒ fork ä¸€æ ·å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

ä½æƒ…å•† APIï¼š

```c
#include <unistd.h>

int main() {
  extern char **environ;
  char *argv[] = { "echo", "hello", "world", NULL, };
  if (execve(argv[0], argv, environ) < 0) {
    perror("exec");
  }
}

// exec: No such file or directory
// execve çš„ç¬¬ä¸€ä¸ªå‚æ•° argv[0] å¿…é¡»æ˜¯åˆæ³•è·¯å¾„
// æ¢æˆ /bin/echo å°±å¯ä»¥è¾“å‡º hello world
```

é«˜æƒ…å•† APIï¼š

```c
execlp("echo", "echo", "hello", "world", NULL);
system("echo hello world");
```



```c
#include <unistd.h>
#include <stdlib.h>

int main() {
  execlp("echo", "echo", "hello", "world", NULL);
}
```

å¯ä»¥åœ¨ç¯å¢ƒå˜é‡ä¸­æ‰¾åˆ° echo

```bash
$ gcc a.c && ./a.out
hello world
$ strace ./a.out
...
execve("/usr/local/sbin/echo", ["echo", "hello", "world"], 0x7ffea91115d8 /* 22 vars */) = -1 ENOENT (No such file or directory)
execve("/usr/local/bin/echo", ["echo", "hello", "world"], 0x7ffea91115d8 /* 22 vars */) = -1 ENOENT (No such file or directory)
execve("/usr/sbin/echo", ["echo", "hello", "world"], 0x7ffea91115d8 /* 22 vars */) = -1 ENOENT (No such file or directory)
execve("/usr/bin/echo", ["echo", "hello", "world"], 0x7ffea91115d8 /* 22 vars */) = 0
...
write(1, "hello world\n", 12hello world
)           = 12
```



## äºŒã€å°è£… (1): çº¯ç²¹çš„è®¡ç®—

### 1ã€[string.h](https://www.cplusplus.com/reference/cstring/): å­—ç¬¦ä¸²/æ•°ç»„æ“ä½œ

ç®€å•ï¼Œä¸ç®€å•

```c
void *memset(void *s, int c, size_t n) {
  for (size_t i = 0; i < n; i++) {
    ((char *)s)[i] = c;
  }
  return s;
}
```

------

è®©æˆ‘ä»¬çœ‹çœ‹ clang æŠŠå®ƒç¼–è¯‘æˆäº†ä»€ä¹ˆâ€¦â€¦ 

- ä»¥åŠï¼Œçº¿ç¨‹å®‰å…¨æ€§ï¼Ÿ[memset-race.c](http://jyywiki.cn/pages/OS/2022/demos/memset-race.c)
- **æ ‡å‡†åº“åªå¯¹ â€œæ ‡å‡†åº“å†…éƒ¨æ•°æ®â€ çš„çº¿ç¨‹å®‰å…¨æ€§è´Ÿè´£**
    - ä¾‹å­ï¼šprintf çš„ buffer

```c
#include "thread.h"

char buf[1 << 30];

void foo(int id) {
  memset(buf, '0' + id, sizeof(buf) - 1);
}

int main() {
  for (int i = 0; i < 4; i++)
    create(foo);
  join();
  puts(buf);
}

```



### 2ã€æ’åºå’ŒæŸ¥æ‰¾

ä½æƒ…å•† (ä½é…ç½®) API

```c
void qsort(void *base, size_t nmemb, size_t size,
           int (*compar)(const void *, const void *));

void *bsearch(const void *key, const void *base,
              size_t nmemb, size_t size,
              int (*compar)(const void *, const void *));
```

------

é«˜æƒ…å•† API

```c
sort(xs.begin(), xs.end(), [] (auto& a, auto& b) {...});
xs.sort(lambda key=...)
```

### 3ã€æ›´å¤šçš„ä¾‹å­

RTFM!

- æ›´å¤šçš„ [stdlib.h](https://www.cplusplus.com/reference/cstdlib/) ä¸­çš„ä¾‹å­
    - atoi, atol, atoll, strtoull, ...
    - rand (æ³¨æ„çº¿ç¨‹å®‰å…¨), ...
- [setjmp.h](https://www.cplusplus.com/reference/csetjmp/)
    - ä½“ä¼šåˆ°æˆ‘ä»¬ç²¾å¿ƒè®¾è®¡çš„è‰¯è‹¦ç”¨å¿ƒï¼Ÿ
        - ä¸€æ¬¡æ‰é˜Ÿï¼Œç»ˆèº«æ‰é˜Ÿ ğŸ˜‚
- [math.h](https://www.cplusplus.com/reference/cmath/)
    - è¿™ç©æ„å¤æ‚äº†; ã€Šæ“ä½œç³»ç»Ÿã€‹è¯¾ç›´æ¥æ‘†çƒ‚
        - [Automatically improving accuracy for floating point expressions](https://dl.acm.org/doi/10.1145/2737924.2737959) (PLDI'15, Distinguished Paper ğŸ…)

## ä¸‰ã€å°è£… (2): æ–‡ä»¶æè¿°ç¬¦

### 1ã€[stdio.h](https://www.cplusplus.com/reference/cstdio/): ä½ ç†Ÿæ‚‰çš„å‘³é“

`FILE *` èƒŒåå…¶å®æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦

- æˆ‘ä»¬å¯ä»¥ç”¨ gdb æŸ¥çœ‹å…·ä½“çš„`FILE *`(ä¾‹å¦‚ `p *fp`, `p *stdin `, `p *stdout`)
    - å¯ä»¥ â€œçª¥æ¢â€ åˆ° glibc çš„ä¸€äº›å†…éƒ¨å®ç°ï¼ˆè¿™äº›å‚æ•° _fileno, _IO_buf_ptr, _IO_buf_end, _IO_buf_baseï¼‰
    - å¯ä»¥åŠ è½½ glibc çš„ debug symbols
        - åœ¨è¿™é—¨è¯¾ä¸Šä¸æ¨èï¼šä½ è°ƒè¯•èµ·æ¥ä¼šå¾ˆæµªè´¹æ—¶é—´
- å°è£…äº†æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„ç³»ç»Ÿè°ƒç”¨ (fseek, fgetpos, ftell, feof, ...)

------

vprintf ç³»åˆ—

- ä½¿ç”¨äº† `stdarg.h` çš„å‚æ•°åˆ—è¡¨

```c
int vfprintf(FILE *stream, const char *format, va_list ap);
int vasprintf(char **ret, const char *format, va_list ap);
```

### 2ã€popen å’Œ pclose

æˆ‘ä»¬åœ¨ [dosbox-hack.c](http://jyywiki.cn/pages/OS/2022/demos/dosbox-hack.c) ä¸­ä½¿ç”¨äº†å®ƒ

- ä¸€ä¸ªè®¾è®¡æœ‰ç¼ºé™·çš„ API
    - Since a pipe is by definition unidirectional, the type argument may specify only reading or writing, *not both*; the resulting stream is correspondingly read-only or write-only.

------

é«˜æƒ…å•† API (ç°ä»£ç¼–ç¨‹è¯­è¨€)

```python
subprocess.check_output(['cat'],
  input=b'Hello World', stderr=subprocess.STDOUT)
```

```rust
let dir_checksum = {
  Exec::shell("find . -type f")
    | Exec::cmd("sort") | Exec::cmd("sha1sum")
}.capture()?.stdout_str();
```

## å››ã€å°è£… (3): æ›´å¤šçš„è¿›ç¨‹/æ“ä½œç³»ç»ŸåŠŸèƒ½

### 1ã€err, error, perror

æ‰€æœ‰ API éƒ½å¯èƒ½å¤±è´¥

```
$ gcc nonexist.c
gcc: error: nonexist.c: No such file or directory
```

------

è¿™ä¸ª â€œNo such file or directoryâ€ ä¼¼ä¹è§å¾—æœ‰ç‚¹å¤šï¼Ÿ

- `cat nonexist.c, wc nonexist.c` éƒ½æ˜¯åŒæ ·çš„ error message
- è¿™ä¸æ˜¯å·§åˆï¼
    - æˆ‘ä»¬ä¹Ÿå¯ä»¥ â€œå±±å¯¨â€ å‡ºåŒæ ·çš„æ•ˆæœ
    - `warn("%s", fname);`(è§‚å¯Ÿ strace)
        - `err` å¯ä»¥é¢å¤–é€€å‡ºç¨‹åº
- errno æ˜¯è¿›ç¨‹å…±äº«è¿˜æ˜¯çº¿ç¨‹ç‹¬äº«ï¼Ÿ
    - è¿™ä¸‹çŸ¥é“åç¨‹çš„è½»é‡äº†å§

### 2ã€environ (7)

æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°è‡ªå·±çš„ [env.c](http://jyywiki.cn/pages/OS/2022/demos/env.c)

- é—®é¢˜æ¥äº†ï¼šenviron æ˜¯è°èµ‹å€¼çš„ï¼Ÿ
    - è¿™ä¸ªå‡½æ•°åˆæ˜¯åœ¨å“ªé‡Œå®šä¹‰çš„ï¼Ÿ

```c
#include <stdio.h>

int main() {
  extern char **environ;
  for (char **env = environ; *env; env++) {
    printf("%s\n", *env);
  }
}
```

**environ è§£é‡Šå›¾ï¼š

![image-20220724122254113](./doc/image-20220724122254113.png)

------

```bash
$ gcc -g -static a.c
$ ./a.out
// ä¸€å †ç¯å¢ƒå˜é‡

$ gdb a.out
(gdb) starti
Starting program: /root/demo/a.out 

Program stopped.
0x00007ffff7fd0100 in ?? () from /lib64/ld-linux-x86-64.so.2
(gdb) p (char**)environ
$1 = (char **) 0x0
(gdb) wa (char**)environ
Watchpoint 1: (char**)environ
(gdb) c
Continuing.

Watchpoint 1: (char**)environ

Old value = (char **) 0x0
New value = (char **) 0x7fffffffe5a8
_init (argc=1, argv=<optimized out>, envp=<optimized out>)
    at init-first.c:77
77	init-first.c: No such file or directory.
```

RTFM å

- å¯¹ç¯å¢ƒå˜é‡çš„ç†è§£åˆä¸Šå‡äº†

## äº”ã€å°è£… (4): åœ°å€ç©ºé—´

### 1ã€malloc å’Œ free

Specification å¾ˆç®€å• (åŒ [Lab1](http://jyywiki.cn/OS/2022/Labs/L1))

- åœ¨å¤§åŒºé—´ [L,R) ä¸­ç»´æŠ¤äº’ä¸ç›¸äº¤çš„åŒºé—´çš„é›†åˆ

M={[â„“0,r0),[â„“1,r1),â€¦,[â„“n,rn)}

- malloc(s) - è¿”å›ä¸€æ®µå¤§å°ä¸ºsçš„åŒºé—´
    - å¿…è¦æ—¶å¯ä»¥å‘æ“ä½œç³»ç»Ÿç”³è¯·é¢å¤–çš„ [L,R) (è§‚å¯Ÿ strace)
    - å…è®¸åœ¨å†…å­˜ä¸è¶³æ—¶ â€œæ‹’ç»â€ è¯·æ±‚
- free(â„“,r) - ç»™å®šâ„“ï¼Œåˆ é™¤[â„“,r)âˆˆM
    - æ˜¯å¦æƒ³èµ·äº†ã€Šç®—æ³•å¯¼è®ºã€‹ï¼Ÿ

![image-20220724144537165](./doc/image-20220724144537165.png)

------

å¤šçº¿ç¨‹å®‰å…¨

- Scalability å°±æ˜¯ä¸ªå¾ˆå¤§çš„é—®é¢˜äº†

### 2ã€å®ç°é«˜æ•ˆçš„ malloc/free

> Premature optimization is the root of all evil.
>
> â€”â€”D. E. Knuth

é‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼š

- **è„±ç¦» workload åšä¼˜åŒ–å°±æ˜¯è€æµæ°“**
- **è„±ç¦» workload åšä¼˜åŒ–å°±æ˜¯è€æµæ°“**
- **è„±ç¦» workload åšä¼˜åŒ–å°±æ˜¯è€æµæ°“**
    - åœ¨å¼€å§‹è€ƒè™‘æ€§èƒ½ä¹‹å‰ï¼Œç†è§£ä½ éœ€è¦è€ƒè™‘ä»€ä¹ˆæ ·çš„æ€§èƒ½

------

ç„¶åï¼Œå»å“ªé‡Œæ‰¾ workload?

- å½“ç„¶æ˜¯ paper äº† (é¡ºä¾¿ç™½å¾—ä¸€ä¸ªæ–¹æ¡ˆ)
    - [Mimalloc: free list sharding in action](https://www.microsoft.com/en-us/research/uploads/prod/2019/06/mimalloc-tr-v1.pdf) (APLAS'19)

### 3ã€Workload åˆ†æ

> æŒ‡å¯¼æ€æƒ³ï¼šO(n) å¤§å°çš„å¯¹è±¡åˆ†é…åè‡³å°‘æœ‰ Î©(n) çš„è¯»å†™æ“ä½œï¼Œå¦åˆ™å°±æ˜¯ performance bug (ä¸åº”è¯¥åˆ†é…é‚£ä¹ˆå¤š)ã€‚

- è¶Šå°çš„å¯¹è±¡åˆ›å»º/åˆ†é…è¶Šé¢‘ç¹
    - å­—ç¬¦ä¸²ã€ä¸´æ—¶å¯¹è±¡ç­‰ (å‡ ååˆ°å‡ ç™¾å­—èŠ‚)ï¼›ç”Ÿå­˜å‘¨æœŸå¯é•¿å¯çŸ­ 
- è¾ƒä¸ºé¢‘ç¹åœ°åˆ†é…ä¸­ç­‰å¤§å°çš„å¯¹è±¡
    - è¾ƒå¤§çš„æ•°ç»„ã€å¤æ‚çš„å¯¹è±¡ï¼›æ›´é•¿çš„ç”Ÿå­˜å‘¨æœŸ
- ä½é¢‘ç‡çš„å¤§å¯¹è±¡
    - å·¨å¤§çš„å®¹å™¨ã€åˆ†é…å™¨ï¼›å¾ˆé•¿çš„ç”Ÿå­˜å‘¨æœŸ
- **å¹¶è¡Œã€å¹¶è¡Œã€å†å¹¶è¡Œ**
    - æ‰€æœ‰åˆ†é…éƒ½ä¼šåœ¨æ‰€æœ‰å¤„ç†å™¨ä¸Šå‘ç”Ÿ
    - ä½¿ç”¨é“¾è¡¨/åŒºé—´æ ‘ (first fit) å¯ä¸æ˜¯ä¸ªå¥½æƒ³æ³•

### 4ã€`malloc`, Fast and Slow

è®¾ç½®ä¸¤å¥—ç³»ç»Ÿï¼š

- fast path
    - æ€§èƒ½æå¥½ã€å¹¶è¡Œåº¦æé«˜ã€è¦†ç›–å¤§éƒ¨åˆ†æƒ…å†µ
    - ä½†æœ‰å°æ¦‚ç‡ä¼šå¤±è´¥ (fall back to slow path)
- slow path
    - ä¸åœ¨ä¹é‚£ä¹ˆå¿«
    - ä½†æŠŠå›°éš¾çš„äº‹æƒ…åšå¥½
        - è®¡ç®—æœºç³»ç»Ÿé‡Œæœ‰å¾ˆå¤šè¿™æ ·çš„ä¾‹å­ (æ¯”å¦‚ cache)

------

äººç±»ä¹Ÿæ˜¯è¿™æ ·çš„ç³»ç»Ÿ

- Daniel Kahneman. *Thinking, Fast and Slow*. Farrar, Straus and Giroux, 2011.

### 5ã€`malloc`: Fast Path è®¾è®¡

**ä½¿æ‰€æœ‰ CPU éƒ½èƒ½å¹¶è¡Œåœ°ç”³è¯·å†…å­˜**

- çº¿ç¨‹éƒ½äº‹å…ˆç“œåˆ†ä¸€äº› â€œé¢†åœ°â€ (thread-local allocation buffer)
- é»˜è®¤ä»è‡ªå·±çš„é¢†åœ°é‡Œåˆ†é…
    - é™¤äº†åœ¨å¦ä¸€ä¸ª CPU é‡Šæ”¾ï¼Œacquire lock å‡ ä¹æ€»æ˜¯æˆåŠŸ
- å¦‚æœè‡ªå·±çš„é¢†åœ°ä¸è¶³ï¼Œå°±ä»å…¨å±€çš„æ± å­é‡Œå€Ÿä¸€ç‚¹

![image-20220724150505571](./doc/image-20220724150505571.png)

------

ä¸è¦åœ¨ä¹ä¸€ç‚¹å°çš„æµªè´¹

- è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦å¯¹é½åˆ° 2^k å­—èŠ‚

### 6ã€å°å†…å­˜ï¼šSegregated List

åˆ†é…: Segregated List (Slab)

- æ¯ä¸ª slab é‡Œçš„æ¯ä¸ªå¯¹è±¡éƒ½ä¸€æ ·å¤§
    - æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰æ¯ä¸ªå¯¹è±¡å¤§å°çš„ slab
    - fast path â†’ ç«‹å³åœ¨çº¿ç¨‹æœ¬åœ°åˆ†é…å®Œæˆ
    - slow path â†’ pgalloc()
- ä¸¤ç§å®ç°
    - å…¨å±€å¤§é“¾è¡¨ v.s. List sharding (per-page å°é“¾è¡¨)

å›æ”¶

- ç›´æ¥å½’è¿˜åˆ° slab ä¸­
    - æ³¨æ„è¿™å¯èƒ½æ˜¯å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„ slabï¼Œéœ€è¦ per-slab é” (å°å¿ƒæ•°æ®ç«äº‰)

### 7ã€å¤§å†…å­˜ï¼šä¸€æŠŠå¤§é”ä¿å¹³å®‰

Buddy system (1963)

- å¦‚æœä½ æƒ³åˆ†é… 1, 2, 3, 4, ... n ä¸ªè¿ç»­çš„é¡µé¢ï¼Ÿ
    - ä¾‹å¦‚ï¼š64 KB/é¡µé¢
- é‚£å°± first fit æˆ–è€… best fit å§â€¦â€¦

------

ä½ åªéœ€è¦ä¸€ä¸ªæ•°æ®ç»“æ„è§£å†³é—®é¢˜

- åŒºé—´æ ‘ï¼›çº¿æ®µæ ‘â€¦â€¦

### 8ã€ç°å®ä¸–ç•Œä¸­çš„ malloc/free

ä»¥ä¸Šå°±æ˜¯æ‰€æœ‰ç°ä»£ malloc/free å®ç°çš„åŸºç¡€

- å½“ç„¶ï¼Œå®é™…æƒ…å†µä¼šå¤æ‚ä¸€äº›ï¼Œæ€§èƒ½ä¹Ÿæ˜¯é”±é“¢å¿…è¾ƒ
    - [glibc](https://sourceware.org/glibc/wiki/MallocInternals): arena â†’ heap â†’ tcache (thread-local)
    - [tcmalloc](https://google.github.io/tcmalloc/design.html): thread-caching malloc, [mimalloc](https://github.com/microsoft/mimalloc)![img](./doc/tcmalloc.png)
    - [OpenJDK: ZGC](https://wiki.openjdk.java.net/display/zgc/Main): region based + tlab (thread-local)
        - managed memory å…è®¸ object moveï¼Œå› æ­¤å¤æ‚å¾—å¤š......

## å…­ã€æ— æ­¢å¢ƒåœ°å°è£…

### 1ã€æƒ³çŸ¥é“æœ‰æ²¡æœ‰æ›´å¤šçš„åŠŸèƒ½ï¼Ÿ

RTFM: [The GNU C Library](https://www.gnu.org/software/libc/manual/), RTFSC: [Newlib](https://sourceware.org/newlib/)

- éƒ½ä¸å¤ªé•¿ (glibc çš„æ‰‹å†Œå’Œ newlib çš„æºç ) ä¹Ÿå¥½è¯»
- Computer System ç³»åˆ—è¯¾ç¨‹çš„é‡è¦ç›®æ ‡ï¼šæ‘†æ­£çœ‹æ‰‹å†Œçš„å¿ƒæ€

------

ä½ ä¼šå‘ç°å¾ˆå¤šå®è—

- Globbing
- Regex
- Shell-style word expansion
- â€¦â€¦

### 2ã€æˆ‘ä»¬è¿˜å¯ä»¥â€¦â€¦

èµ°å‡º C çš„é¢†åŸŸï¼ŒåŸºäº libc å®ç°

- C++ ç¼–è¯‘å™¨
    - ç»§ç»­å®ç° C++ Standard Library
    - ç»§ç»­å®ç° [OpenJDK (HotSpot)](https://openjdk.java.net/groups/hotspot/)
    - ç»§ç»­å®ç° [V8](https://v8.dev/) (JavaScript)
- CPython
- Go
    - å†ä¹‹å Go å°±å¯ä»¥è‡ªå·±ç¼–è¯‘è‡ªå·±äº† (Goodbye, C!)

------

Eventually, (åƒç–®ç™¾å­”) çš„æ•´ä¸ªè®¡ç®—æœºä¸–ç•Œï¼

- [C is not a low-level language](https://dl.acm.org/doi/pdf/10.1145/3209212) (CACM'18)
- [C isn't a programming language any more](https://gankra.github.io/blah/c-isnt-a-language/) (Gankra's Blog)

## æ€»ç»“

æœ¬æ¬¡è¯¾å›ç­”çš„é—®é¢˜

- **Q**: å¦‚ä½•åœ¨ç³»ç»Ÿè°ƒç”¨ä¹‹ä¸Šæ„å»ºç¨‹åºèƒ½å¤Ÿæ™®éå—æƒ çš„æ ‡å‡†åº“ï¼Ÿ

![image-20220724151243599](./doc/image-20220724151243599.png)

------

Take-away messages

- libc
    - RTFM; RTFSC: å……æ»¡äº†å®è—
    - æ€§èƒ½ä¼˜åŒ–ä¸­çš„ fast/slow path
- ç„¶åï¼Œä½ æ‹¥æœ‰äº†æ•´ä¸ªä¸–ç•Œï¼

